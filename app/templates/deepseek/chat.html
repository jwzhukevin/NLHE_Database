{% extends 'base.html' %}
{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/deepseek_chat.css', v='20250913') }}">
{% endblock %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/katex.min.css') }}">
{% endblock %}
{% block content %}
<!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/deepseek_chat.css -->
<section class="deepseek-chat-main">
    <div class="deepseek-chat-box">
        <h2>{{ _('SiliconFlow LLM Chat') }}</h2>
        <form method="post" class="chat-toolbar" id="toolbar-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" name="delete_session" value="1">{{ _('Delete') }}</button>
            <button type="submit" name="clear" value="1">{{ _('Clear') }}</button>
            <button type="submit" name="new" value="1">{{ _('New') }}</button>
            <button type="button" id="save-btn">{{ _('Save') }}</button>
            <label for="history_select">{{ _('History:') }}</label>
            <select name="history_select" id="history_select" onchange="this.form.submit()">
                <option value="current" {% if selected_history=='history.json' %}selected{% endif %}>{{ _('Current Session') }}</option>
                {% if history_list %}
                    {% for h in history_list %}
                        <option value="{{ h }}" {% if h == selected_history %}selected{% endif %}>{{ h[:-5] }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            {% if selected_history != 'history.json' %}
                <button type="button" id="rename-btn">{{ _('Rename') }}</button>
            {% endif %}
        </form>
        <!-- 保存对话弹窗 -->
        <div class="modal" id="save-modal">
            <div class="modal-content">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <h4>{{ _('Name this session') }}</h4>
                    <input type="text" name="save_name" placeholder="{{ _('Session name') }}" required maxlength="32" />
                    <div>
                        <button type="submit" name="save" value="1">{{ _('Save') }}</button>
                        <button type="button" onclick="closeModal('save-modal')">{{ _('Cancel') }}</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 重命名弹窗 -->
        <div class="modal" id="rename-modal">
            <div class="modal-content">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <h4>{{ _('Rename this session') }}</h4>
                    <input type="text" name="rename_name" placeholder="{{ _('New name') }}" required maxlength="32" />
                    <div>
                        <button type="submit" name="rename" value="1">{{ _('Rename') }}</button>
                        <button type="button" onclick="closeModal('rename-modal')">{{ _('Cancel') }}</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="chat-history" id="chat-history">
            {% for turn in chat_history %}
                <div class="chat-turn user-turn">
                    <div class="user-label">{{ _('You') }}</div>
                    <div class="bubble user-bubble">{{ turn.user }}</div>
                </div>
                <div class="chat-turn ai-turn">
                    <div class="ai-label">{{ _('AI') }}</div>
                    <div class="ai-wrapper">
                        <div class="bubble ai-bubble" data-ai="{{ turn.assistant|e }}"></div>
                        <div class="ai-actions" data-index="{{ loop.index0 }}">
                            <!-- 保存按钮 -->
                            <button class="ai-action-btn save-btn btn-ghost" title="{{ _('Save answer') }}" data-index="{{ loop.index0 }}">
                                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6.83a2 2 0 0 0-.59-1.41l-2.83-2.83A2 2 0 0 0 12.17 2H5zm0 2h7v3a1 1 0 0 0 1 1h3v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4zm9 1.41V7h1.59L14 5.41zM7 10v4h6v-4H7zm2 2h2v-2h-2v2z"/></svg>
                            </button>
                            <!-- 重新回答按钮 -->
                            <button class="ai-action-btn retry-btn btn-ghost" title="{{ _('Retry answering') }}" data-index="{{ loop.index0 }}">
                                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M10 2a8 8 0 1 1-7.75 6.25.75.75 0 1 1 1.46-.5A6.5 6.5 0 1 0 10 3.5V6a.75.75 0 0 1-1.5 0V2.75A.75.75 0 0 1 9.25 2H10z"/></svg>
                            </button>
                            <!-- 删除按钮 -->
                            <button class="ai-action-btn delete-btn btn-ghost" title="{{ _('Delete answer') }}" data-index="{{ loop.index0 }}">
                                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M7.5 2a1 1 0 0 0-1 1V3.5H3.75a.75.75 0 0 0 0 1.5h12.5a.75.75 0 0 0 0-1.5H13.5V3a1 1 0 0 0-1-1h-5zm-2 4v9a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V6h-9zm2 2.5a.75.75 0 0 1 1.5 0v5a.75.75 0 0 1-1.5 0v-5zm3 0a.75.75 0 0 1 1.5 0v5a.75.75 0 0 1-1.5 0v-5z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <form method="post" class="deepseek-chat-form" id="chat-form" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <textarea name="prompt" rows="2" placeholder="{{ _('Type your message...') }}" required></textarea>
            <button type="submit">{{ _('Send') }}</button>
        </form>
    </div>
</section>

<script src="{{ url_for('static', filename='js/markdown-it.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/markdown-it-katex.min.js') }}"></script>
<!-- i18n 文案以 JSON 安全注入，避免在 JS 中直接嵌入模板字符串导致语法错误 -->
<script type="application/json" id="i18n-json">
  {{ {
    'labelYou': _('You'),
    'labelAI':  _('AI'),
    'generating': _('Generating...'),
    'copied': _('Copied!'),
    'saveAnswer': _('Save answer'),
    'copyQuestion': _('Copy question'),
    'submitFailed': _('Submit failed:'),
    'confirmDeleteQA': _('Are you sure you want to delete this Q&A?'),
    'serverError': _('Server error')
  } | tojson }}
</script>
<script>
function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}
document.addEventListener('DOMContentLoaded', function() {
    // 打字机+markdown-it渲染同前
    const aiBubbles = document.querySelectorAll('.ai-bubble');
    const md = window.markdownit().use(window.markdownitKatex);
    // 读取 JSON 注入的国际化文案
    const i18n = JSON.parse(
        document.getElementById('i18n-json').textContent
    );

    aiBubbles.forEach(function(bubble, idx) {
        const text = bubble.getAttribute('data-ai');
        if (!text) return;
        const actions = document.querySelectorAll('.ai-actions')[idx];
        if (idx === aiBubbles.length - 1 && !bubble.innerText.trim()) {
            let i = 0;
            function typing() {
                if (i <= text.length) {
                    bubble.innerHTML = md.render(text.slice(0, i));
                    i++;
                    setTimeout(typing, 18);
                } else {
                    // 打字机动画结束后显示操作按钮
                    if (actions) actions.classList.add('visible');
                }
            }
            typing();
        } else {
            bubble.innerHTML = md.render(text);
            if (actions) actions.classList.add('visible');
        }
    });
    // 保存对话弹窗
    document.getElementById('save-btn').onclick = function() {
        document.getElementById('save-modal').classList.add('active');
    };
    // 重命名弹窗
    var renameBtn = document.getElementById('rename-btn');
    if (renameBtn) {
        renameBtn.onclick = function() {
            document.getElementById('rename-modal').classList.add('active');
        };
    }
    // 关闭弹窗点击遮罩
    document.querySelectorAll('.modal').forEach(function(modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeModal(modal.id);
        });
    });
    // AI回答操作按钮事件
    document.querySelectorAll('.ai-actions .save-btn').forEach(function(btn) {
        btn.onclick = function() {
            const idx = btn.getAttribute('data-index');
            const bubble = document.querySelectorAll('.ai-bubble')[idx];
            if (bubble) {
                const text = bubble.getAttribute('data-ai');
                // 复制到剪贴板
                navigator.clipboard.writeText(text).then(function() {
                    btn.title = i18n.copied;
                    setTimeout(()=>{btn.title=i18n.saveAnswer;}, 1200);
                });
            }
        };
    });
    document.querySelectorAll('.ai-actions .retry-btn').forEach(function(btn) {
        btn.onclick = function() {
            const idx = btn.getAttribute('data-index');
            // 提交表单，带上 retry_index
            const form = document.createElement('form');
            form.method = 'post';
            form.style.display = 'none';

            // 添加CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'retry_index';
            input.value = idx;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        };
    });
    document.querySelectorAll('.ai-actions .delete-btn').forEach(function(btn) {
        btn.onclick = function() {
            const idx = btn.getAttribute('data-index');
            if (!confirm(i18n.confirmDeleteQA)) return;
            // 提交表单，带上 delete_index
            const form = document.createElement('form');
            form.method = 'post';
            form.style.display = 'none';

            // 添加CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'delete_index';
            input.value = idx;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        };
    });
    // 提交后立即显示用户输入和AI等待气泡同前（AJAX实现无刷新）
    document.getElementById('chat-form').onsubmit = async function(e) {
        e.preventDefault();
        const textarea = this.querySelector('textarea');
        const prompt = textarea.value.trim();
        if (!prompt) return;
        const chatHistory = document.getElementById('chat-history');
        // 添加用户气泡
        const userDiv = document.createElement('div');
        userDiv.className = 'chat-turn user-turn';
        userDiv.innerHTML = '<div class="user-label">' + i18n.labelYou + '</div><div class="bubble user-bubble">' + prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
        chatHistory.appendChild(userDiv);
        // 添加AI等待气泡
        const aiDiv = document.createElement('div');
        aiDiv.className = 'chat-turn ai-turn';
        aiDiv.innerHTML = '<div class="ai-label">' + i18n.labelAI + '</div><div class="ai-wrapper"><div class="bubble ai-bubble">' + i18n.generating + '</div></div>';
        chatHistory.appendChild(aiDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        textarea.value = '';
        // 异步POST到后端
        try {
            const resp = await fetch('/siliconflow/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, history: document.getElementById('history_select')?.value || 'history.json' })
            });
            if (!resp.ok) throw new Error(i18n.serverError);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);
            // 渲染AI回复（打字机+markdown-it）
            const aiBubble = aiDiv.querySelector('.ai-bubble');
            const actions = aiDiv.querySelector('.ai-actions');
            const text = data.assistant;
            const md = window.markdownit().use(window.markdownitKatex);
            let i = 0;
            function typing() {
                if (i <= text.length) {
                    aiBubble.innerHTML = md.render(text.slice(0, i));
                    i++;
                    setTimeout(typing, 18);
                } else {
                    // 重新渲染操作按钮
                    if (actions) actions.classList.add('visible');
                }
            }
            typing();
            // 刷新操作按钮（重新绑定事件）
            setTimeout(function() {
                document.querySelectorAll('.ai-actions .save-btn').forEach(function(btn) {
                    btn.onclick = function() {
                        const idx = btn.getAttribute('data-index');
                        const bubble = document.querySelectorAll('.ai-bubble')[idx];
                        if (bubble) {
                            const text = bubble.getAttribute('data-ai');
                            navigator.clipboard.writeText(text).then(function() {
                                btn.title = i18n.copied;
                                setTimeout(()=>{btn.title=i18n.saveAnswer;}, 1200);
                            });
                        }
                    };
                });
                document.querySelectorAll('.ai-actions .retry-btn').forEach(function(btn) {
                    btn.onclick = function() {
                        const idx = btn.getAttribute('data-index');
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.style.display = 'none';

                        // 添加CSRF token
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrf_token';
                        csrfInput.value = '{{ csrf_token() }}';
                        form.appendChild(csrfInput);

                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'retry_index';
                        input.value = idx;
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    };
                });
                document.querySelectorAll('.ai-actions .delete-btn').forEach(function(btn) {
                    btn.onclick = function() {
                        const idx = btn.getAttribute('data-index');
                        if (!confirm(i18n.confirmDeleteQA)) return;
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.style.display = 'none';

                        // 添加CSRF token
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrf_token';
                        csrfInput.value = '{{ csrf_token() }}';
                        form.appendChild(csrfInput);

                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'delete_index';
                        input.value = idx;
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    };
                });
            }, 100);
        } catch (err) {
            alert(i18n.submitFailed + ' ' + err.message);
            // 回滚AI等待气泡
            chatHistory.removeChild(aiDiv);
        }
    };
    // 用户问题复制按钮事件
    function bindUserCopyBtns() {
        document.querySelectorAll('.user-copy-btn').forEach(function(btn, idx) {
            btn.onclick = function() {
                // 获取对应气泡内容
                let bubble;
                if (btn.parentElement) {
                    bubble = btn.parentElement.querySelector('.user-bubble');
                }
                if (bubble) {
                    const text = bubble.innerText;
                    navigator.clipboard.writeText(text).then(function() {
                        btn.title = i18n.copied;
                        setTimeout(()=>{btn.title=i18n.copyQuestion;}, 1200);
                    });
                }
            };
        });
    }
    bindUserCopyBtns();
    // 每次页面渲染后都重新绑定
    const observer = new MutationObserver(bindUserCopyBtns);
    observer.observe(document.getElementById('chat-history'), {childList:true,subtree:true});
    // 输入框回车发送，Shift+Enter换行
    const textarea = document.querySelector('#chat-form textarea');
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chat-form').requestSubmit();
        }
    });
});
</script>
{% endblock %} 