{% extends 'base.html' %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/database.css', v='20250913') }}">
{% endblock %}

{% block content %}
<!-- ====================== 数据表格容器（完全复用 main/database.html 结构与类名） ====================== -->
<div class="data-table-container">

  <!-- ====================== 搜索表单（结构与样式一致） ====================== -->
  <form class="search-form" id="htaSearchForm" onsubmit="return false;">
    <canvas id="hvElectronsDb" class="hv-electrons" aria-hidden="true"></canvas>

    <!-- 基本搜索（占位，样式一致；输入不会提交服务器，仅用于一致外观） -->
    <div class="basic-search">
      <div class="search-input-container">
        <input type="text" name="q" id="htaSearchInput"
               placeholder="{{ _('Search materials, MP IDs, space groups...') }}"
               aria-label="{{ _('Search') }}" autocomplete="off">
        <div class="search-suggestions" id="htaSearchSuggestions"></div>
      </div>
      <button type="button" class="button-tool" id="htaClearSearchBtn">{{ _('Clear') }}</button>
      <button type="button" class="button-search" id="btn-query">{{ _('Search') }}</button>
      <button type="button" class="button-tool" onclick="toggleAdvanced()">{{ _('Advanced') }}</button>
      <input type="hidden" name="per_page" id="per_page" value="">
    </div>

    <!-- 高级搜索（自定义字段，但沿用相同类名与网格） -->
    <div class="advanced-search" id="advancedSearch">
      <div class="search-group">
        <!-- 第一行：元素范围（左右两列） -->
        <!-- [Deprecated 20251008] 旧元素范围筛选（Ag/Au/Cu/I/K/S/Se/Te）已按需求移除，仅保留其他筛选项 -->

        <!-- 第二行：类别多选（3列） -->
        <div class="search-row">
          <div class="filter-group" style="flex:1;">
            <label>{{ _('Crystal structure') }}</label>
            <select name="crystal_structure" multiple size="4"></select>
          </div>
          <div class="filter-group" style="flex:1;">
            <label>{{ _('Process type') }}</label>
            <select name="process_type" multiple size="4"></select>
          </div>
          <div class="filter-group" style="flex:1;">
            <label>{{ _('Heat treatment process') }}</label>
            <select name="heat_treatment_process" multiple size="4"></select>
          </div>
        </div>

        <!-- 第三行：性能范围（2列） + 分页大小与操作按钮 -->
        <div class="search-row">
          <div class="filter-group" style="flex:1;">
            <label>{{ _('Bending Strength (MPa)') }}</label>
            <div class="range-inputs" style="display:flex; gap:.5rem;">
              <input type="number" step="1" name="bending_strength_min" placeholder="{{ _('Min') }}">
              <span>{{ _('to') }}</span>
              <input type="number" step="1" name="bending_strength_max" placeholder="{{ _('Max') }}">
            </div>
          </div>
          <div class="filter-group" style="flex:1;">
            <div style="display:flex; gap:1rem;">
              <div style="flex:1;">
                <label>{{ _('zt') }}</label>
                <div class="range-inputs" style="display:flex; gap:.5rem;">
                  <input type="number" step="0.01" name="zt_min" placeholder="{{ _('Min') }}">
                  <span>{{ _('to') }}</span>
                  <input type="number" step="0.01" name="zt_max" placeholder="{{ _('Max') }}">
                </div>
              </div>
              <div style="flex:1;">
                <label>{{ _('Bending Strain') }}</label>
                <div class="range-inputs" style="display:flex; gap:.5rem;">
                  <input type="number" step="0.01" name="bending_strain_min" placeholder="{{ _('Min') }}">
                  <span>{{ _('to') }}</span>
                  <input type="number" step="0.01" name="bending_strain_max" placeholder="{{ _('Max') }}">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="search-actions">
          <button type="button" class="button-tool" id="btn-reset">{{ _('Reset') }}</button>
          <button type="button" class="button-search" id="btn-query-adv">{{ _('Search') }}</button>
        </div>
      </div>
    </div>

    <!-- 搜索验证提示（保留结构以复用样式） -->
    <div id="searchAlert" class="search-alert">
      <i class="fas fa-exclamation-circle"></i>
      <span>{{ _('Please enter search criteria or select at least one filter before searching.') }}</span>
    </div>
  </form>

  <!-- ====================== 表格区域（与 main/database.html 相同外层结构） ====================== -->
  <div class="table-outer">
    <div class="table-inner">
      <div class="table-stack">

        <!-- 表格标题（样式一致，文案简化） -->
        <div class="table-title">
          <span class="title2">{{ _('Results') }}</span>
          <div class="table-toolbar">
            <div class="menu per-page">
              <button type="button" class="button-tool-small" id="perPageBtn" aria-expanded="false">
                {{ _('Per Page') }} <span id="perPageCurrent" class="per-page-current">(20)</span>
              </button>
              <div class="menu-panel is-hidden" id="perPageMenu" role="menu" aria-labelledby="perPageBtn">
                <button type="button" class="menu-item" data-per-page="20">
                  <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                  <span class="item-text">20</span>
                </button>
                <button type="button" class="menu-item" data-per-page="50">
                  <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                  <span class="item-text">50</span>
                </button>
                <button type="button" class="menu-item" data-per-page="100">
                  <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                  <span class="item-text">100</span>
                </button>
                <button type="button" class="menu-item" data-per-page="200">
                  <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                  <span class="item-text">200</span>
                </button>
              </div>
            </div>
            <div class="menu column-visibility">
              <button type="button" class="button-tool-small" id="colToggleBtn" aria-expanded="false">{{ _('Columns') }}</button>
              <div class="menu-panel is-hidden" id="colMenu" role="menu" aria-labelledby="colToggleBtn">
                <div class="menu-title">{{ _('Optional Columns') }}</div>
                <!-- [Deprecated 20251008] 元素可选列（Ag/Au/Cu/I/K/S/Se/Te）已移除 -->
                <label class="menu-check" data-field="bending_strength_mpa"><input type="checkbox" value="bending_strength_mpa" checked><i class="fas fa-bolt field-icon" aria-hidden="true"></i><span class="menu-check-text">{{ _('Bending Strength (MPa)') }}</span><i class="far fa-eye field-visibility" aria-hidden="true"></i></label>
                <label class="menu-check" data-field="zt"><input type="checkbox" value="zt" checked><i class="fas fa-bolt field-icon" aria-hidden="true"></i><span class="menu-check-text">{{ _('zt') }}</span><i class="far fa-eye field-visibility" aria-hidden="true"></i></label>
                <label class="menu-check" data-field="bending_strain"><input type="checkbox" value="bending_strain" checked><i class="fas fa-bolt field-icon" aria-hidden="true"></i><span class="menu-check-text">{{ _('Bending Strain') }}</span><i class="far fa-eye field-visibility" aria-hidden="true"></i></label>
                <div class="menu-actions">
                  <button type="button" class="button-primary-small" id="applyColsBtn">{{ pgettext('columns', 'Apply') }}</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 表格（类名与基础样式一致） -->
        <table class="material-data-table" id="hta-table">
          <thead>
            <tr>
              <th class="sortable" data-sort-key="hta_row" data-col-key="hta_id" aria-sort="none">HTA-id <span class="sort-indicator"></span></th>
              <th class="sortable" data-sort-key="Material" data-col-key="Material" aria-sort="none">Material <span class="sort-indicator"></span></th>
              <th class="sortable" data-sort-key="bending_strength_mpa" data-col-key="bending_strength_mpa" aria-sort="none">{{ _('Bending Strength (MPa)') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="bending_strength_mpa" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
              <th class="sortable" data-sort-key="zt" data-col-key="zt" aria-sort="none">{{ _('zt') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="zt" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
              <th class="sortable" data-sort-key="bending_strain" data-col-key="bending_strain" aria-sort="none">{{ _('Bending Strain') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="bending_strain" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
              <th data-col-key="actions">{{ _('Detail') }}</th>
            </tr>
          </thead>
          <tbody>
            {% if items %}
              {% for item in items %}
                <tr>
                  <td data-col-key="hta_id">{{ item.hta_display_id }}</td>
                  <td data-col-key="Material">
                    <a class="material-link" href="{{ url_for('high_temperature_alloy.detail', hta_id=item.hta_display_id ~ '-' ~ item.hta_hash[-10:]) }}">
                      {{ item.Material }}
                    </a>
                  </td>
                  <td data-col-key="bending_strength_mpa">{{ "%.2f"|format(item.bending_strength_mpa|float) if item.bending_strength_mpa is not none else 'None' }}</td>
                  <td data-col-key="zt">{{ "%.2f"|format(item.zt|float) if item.zt is not none else 'None' }}</td>
                  <td data-col-key="bending_strain">{{ "%.2f"|format(item.bending_strain|float) if item.bending_strain is not none else 'None' }}</td>
                  <td data-col-key="actions">
                                        <button type="button" class="button-detail-action" onclick="openProcModal('{{ item.process_type }}', '{{ item.heat_treatment_process }}')">
                      <i class="fas fa-info-circle"></i> {{ _('Detail') }}
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6">{{ _('No results found.') }}</td>
              </tr>
            {% endif %}
          </tbody>
        </table>

      </div>
    </div>
  </div>

  <!-- 分页（沿用同样类名获得相同样式） -->
  <div id="hta-pagination" class="pagination"></div>

  <!-- 工艺信息弹窗（复用 analysis-modal 样式体系） -->
  <div class="analysis-modal" id="htaProcModal" style="display:none;">
    <div class="analysis-content" role="dialog" aria-modal="true" aria-labelledby="htaProcTitle">
      <div class="analysis-header">
        <h3 id="htaProcTitle">{{ _('Process Information') }}</h3>
        <button class="button-close" id="htaProcClose" aria-label="{{ _('Close') }}">×</button>
      </div>
      <div class="analysis-body">
        <div class="analysis-section">
          <h4>{{ _('Process type') }}</h4>
          <div id="htaProcType"></div>
        </div>
        <div class="analysis-section">
          <h4>{{ _('Heat treatment process') }}</h4>
          <div id="htaProcHeat"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function toggleAdvanced() {
  const el = document.getElementById('advancedSearch');
  if (!el) return;
  if (el.classList.contains('show')) el.classList.remove('show');
  else el.classList.add('show');
}
</script>

<script>
  // 将服务端初始加载的数据暴露给 JS
  window.initialData = JSON.parse('{{ data|tojson|safe }}'.replace(/&quot;/g, '"'));
  // 将搜索参数也暴露出来，用于JS恢复表单状态
  window.searchParams = JSON.parse('{{ search_params|tojson|safe }}'.replace(/&quot;/g, '"'));

  // 定义全局函数供模板中的 onclick 调用
  function openProcModal(procType, procHeat) {
    const modal = document.getElementById('htaProcModal');
    if (!modal) return;
    const typeEl = document.getElementById('htaProcType');
    const heatEl = document.getElementById('htaProcHeat');
    if (typeEl) typeEl.textContent = procType || '';
    if (heatEl) heatEl.textContent = procHeat || '';
    modal.style.display = 'flex';
  }
</script>
<script src="{{ url_for('static', filename='js/high_temperature_alloy.js') }}"></script>
{% endblock %}
