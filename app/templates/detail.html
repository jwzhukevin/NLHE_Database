{% extends 'base.html' %}

{% block content %}
<!-- Jmol Scripts: 用于加载和显示材料的3D结构 -->
<script type="text/javascript" src="{{ url_for('static', filename='jsmol/JSmol.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jsmol/JSmolApplet.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jsmol/jmol-controls.js') }}"></script>
<!-- Band Structure Scripts: 用于显示材料的能带结构图 -->
<script type="text/javascript" src="{{ url_for('static', filename='band-plot.js') }}"></script>
<div class="material-detail-container">
    <!-- Header Section: 包含材料名称和操作按钮 -->
    <div class="header-section" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <span class="title2" style="font-size: 1.5em; color: #2c3e50;">{{ material.name }}</span>
        <div class="action-buttons" style="margin-top: 16px; display: flex; gap: 10px; justify-content: center;">
            <!-- 返回列表按钮 -->
            <a href="{{ url_for('views.index') }}" class="btn" style="display: inline-flex; align-items: center; gap: 5px;">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            <!-- 材料项目链接 -->
            <a class="mp" 
               href="https://materialsproject.org/materials/{{ material.name }}" 
               target="_blank"
               title="View in MP">
               MP
            </a>
            {% if current_user.is_authenticated %}
            <!-- 编辑材料按钮 -->
            <a class="btn" style="text-decoration: none;"
               href="{{ url_for('views.edit', material_id=material.id) }}">
               Edit
            </a>
            <form method="post" 
            action="{{ url_for('views.delete', material_id=material.id) }}">
            <button class="btn" 
            type="submit" 
            onclick="return confirm('Delete permanently?')">Del</button>
            </form>
            {% endif %}    
        </div>
    </div>
    <div class="detail-section">
        <div class="detail-card">
            <h3>Basic Properties</h3>
            <ul>
                <li>Status: {{ material.status }}</li>
                <li>Total Energy: {{ material.total_energy }} eV</li>
                <li>Formation Energy: {{ material.formation_energy }} eV</li>
                <li>Fermi Level: {{ material.fermi_level }} eV</li>
            </ul>
        </div>

        <div class="detail-card">
            <h3>Surface Properties</h3>
            <ul>
                <li>Vacuum Level: {{ material.vacuum_level }} eV</li>
                <li>Work Function: {{ material.workfunction }} eV</li>
                <li>Metal Type: {{ material.metal_type }}</li>
            </ul>
        </div>

        <div class="detail-card">
            <h3>Band Structure</h3>
            <ul>
                <li>Band Gap: {{ material.gap }} eV</li>
                <li>VBM Energy: {{ material.vbm_energy }} eV</li>
                <li>CBM Energy: {{ material.cbm_energy }} eV</li>
                <li>VBM Coordinates: {{ material.vbm_coordi }}</li>
                <li>CBM Coordinates: {{ material.cbm_coordi }}</li>
            </ul>
        </div>
    </div>

    <!-- Jmol Container -->
    <div class="jmol-container">
        <div class="jmol-viewer" id="jmolApplet0"></div>
        <div class="jmol-controls" style="margin-top: 20px;">
            <button onclick="rotateLeft()" class="btn">Rotate Left</button>
            <button onclick="rotateRight()" class="btn">Rotate Right</button>
            <button onclick="resetView()" class="btn">Reset View</button>
            <button onclick="toggleSpin()" class="btn">Toggle Spin</button>
        </div>
    </div>

    <!-- Band Structure Container -->
    <div class="jmol-container" style="margin-top: 40px;">
        <div id="bandStructure" style="width: 100%; height: 400px;"></div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const bandDataPath = "{{ url_for('static', filename='band/' + material.name + '.dat') }}";
                plotBandStructure('bandStructure', bandDataPath);
            });
        </script>
        <script>
            var jmolApplet;
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Full static path:', "{{ url_for('static', filename=structure_file) }}");
                
                try {
                    jmolApplet = Jmol.getApplet("jmol", {
                        width: '100%',
                        height: '100%',
                        use: 'HTML5',
                        j2sPath: "{{ url_for('static', filename='jsmol/j2s') }}",
                        script: "load '" + "{{ url_for('static', filename=structure_file) }}" + "'; wireframe off; spacefill 20%;",
                        disableJ2SLoadMonitor: true,
                        disableInitialConsole: true,
                        allowJavaScript: true,
                        color: '#FFFFFF',
                        addSelectionOptions: false,
                        readyFunction: function() {
                            console.log('JSmol initialized successfully');
                            Jmol.script(jmolApplet, 'set antialiasDisplay true');
                            Jmol.script(jmolApplet, 'set defaultVDW babel');
                            Jmol.script(jmolApplet, 'set zoomLarge false');
                            Jmol.script(jmolApplet, 'set picking off');
                        }
                    });
                } catch(e) {
                    console.error("Error initializing Jmol:", e);
                }
            });
        </script>

    </div>
</div>



<style>
/* ====================== 材料详情容器 ====================== */
.material-detail-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

/* ====================== 详情区块布局 ====================== */
.detail-section {
    display: flex;
    flex-direction: row;
    gap: 24px;
    margin: 20px 0;
    justify-content: space-between;
}

.detail-card {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 0;
}

/* ====================== 卡片标题样式 ====================== */
.detail-card h3 {
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
    margin-bottom: 10px;
}

/* ====================== 列表优化样式 ====================== */
.detail-card ul {
    list-style: none;
    padding-left: 0;
}

/* ====================== 列表项样式 ====================== */
.detail-card li {
    margin: 6px 0;
    padding: 8px;
}

/* ====================== JSmol容器样式 ====================== */
.jmol-container {
    margin: 20px auto;
    text-align: center;
    max-width: 800px;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.jmol-viewer {
    width: 100%;
    height: 400px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.jmol-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
}
</style>

{% endblock %}
