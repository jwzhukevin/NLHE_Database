{% extends 'base.html' %}
{# 继承base.html模板，这使得detail.html可以共享base.html中定义的全局结构 #}

{% block content %}
{# 开始内容块，将覆盖base.html中相应的块 #}

<!-- ====================== 外部脚本引入 ====================== -->
<!-- Three.js相关脚本：用于创建和渲染3D晶体结构模型 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<!-- Three.js轨道控制器：允许用户旋转、平移和缩放3D模型 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<!-- 自定义晶体查看器脚本：实现晶体结构的交互式展示 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/crystal-viewer.js') }}"></script>

<!-- 能带结构脚本：用于绘制和交互式显示材料的电子能带结构 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/band-plot.js') }}"></script>

<!-- SC结构相关脚本 -->
<!-- Plotly.js：强大的图表库，用于创建交互式图表 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/plotly.js@2.18.0/dist/plotly.min.js"></script>
<!-- 自定义SC结构绘图脚本：处理SC结构数据的可视化 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/sc-plot.js') }}"></script>

<!-- ====================== 顶部导航栏 ====================== -->
<div class="top-nav">
    <!-- 材料名称显示：从后端传递的material对象中获取 -->
    <div class="material-title">{{ material.name }}</div>
    
    <!-- 导航链接容器 -->
    <div class="nav-links">
        <!-- 页内导航链接：通过锚点链接到页面不同部分 -->
        <a href="#first-section" class="nav-link active">Structure</a> <!-- 默认激活的链接 -->
        <a href="#second-section" class="nav-link">Crystal Data</a>
        <a href="#third-section" class="nav-link">Band Structure</a>
        <a href="#sc-section" class="nav-link">SC</a>
        <a href="#fourth-section" class="nav-link">Properties</a>
        
        <!-- 管理员专用功能：仅在用户已登录时显示 -->
        {% if current_user.is_authenticated %}
            <!-- 编辑材料按钮：跳转到编辑页面 -->
            <a href="{{ url_for('views.edit', material_id=material.id) }}" class="nav-link">
                <i class="fas fa-edit"></i> Edit
            </a>
            
            <!-- 删除材料按钮：发送删除请求并要求确认 -->
            <a method="post" action="{{ url_for('views.delete', material_id=material.id) }}" 
               type="submit" onclick="return confirm('Delete permanently?')" class="nav-link">
                <i class="fas fa-trash"></i> Del
            </a>                    
        {% endif %} 
        
        <!-- 外部链接和返回按钮 -->
        <!-- Materials Project外部链接：打开新标签页查看相同材料 -->
        <a href="https://materialsproject.org/materials/{{ material.name }}" target="_blank" class="nav-link">
            <i class="fas fa-external-link-alt"></i> MP
        </a>
        
        <!-- 搜索返回：仅当从搜索结果页面进入时显示 -->
        {% if request.referrer and 'q=' in request.referrer %}
            <a href="{{ request.referrer }}" class="nav-link back-link">
                <i class="fas fa-search"></i> Back to Search
            </a>
        {% endif %}
        
        <!-- 返回列表：返回材料列表页面 -->
        <a href="{{ url_for('views.index') }}" class="nav-link back-link">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<!-- ====================== 主容器 ====================== -->
<div class="material-detail-container">
    <style>
    /* ===== 页面全局样式 ===== */
    body {
        margin: 0; /* 移除默认外边距 */
        padding: 0; /* 移除默认内边距 */
        background: #f8fafc; /* 设置浅灰色背景，提供柔和视觉体验 */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; /* 现代系统字体栈，确保在不同平台上的一致性 */
    }
    
    /* ===== 主容器布局样式 ===== */
    .material-detail-container {
        max-width: 1600px; /* 设置最大宽度为1600px，确保在大屏幕上不会过宽 */
        margin: 120px auto 0; /* 上边距120px避免与顶部固定导航栏重叠，左右自动居中，下边距0 */
        padding: 24px; /* 四周内边距24px，给内容留出呼吸空间 */
        background: #f8fafc; /* 与body相同的背景色，保持一致性 */
    }

    /* ===== 顶部导航栏样式 ===== */
    .top-nav {
        position: fixed; /* 固定定位，使导航栏在滚动时始终可见 */
        top: 64px; /* 距顶部64px，为主导航栏预留空间 */
        left: 0; /* 水平方向左对齐 */
        right: 0; /* 水平方向右对齐，与left:0结合确保全宽度 */
        height: 100px; /* 设置导航栏高度为100px */
        background: #a2d4ff; /* 蓝色背景，提供视觉焦点 */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 添加轻微阴影，增强层次感 */
        display: flex; /* 使用弹性布局，便于组织子元素 */
        align-items: flex-start; /* 子元素在垂直方向上顶部对齐 */
        justify-content: space-between; /* 子元素在水平方向上两端对齐 */
        padding: 36px 24px 0; /* 上内边距36px，左右内边距24px，下内边距0 */
        z-index: 80; /* 设置层级，确保在正常内容之上，但不会覆盖主导航栏 */
    }

    /* 材料标题样式 */
    .material-title {
        font-size: 1.8em; /* 字体大小为基准大小的1.8倍，使标题突出 */
        font-weight: 1000; /* 字体极粗，增强可读性和视觉重要性 */
        color: #1e293b; /* 深蓝灰色文字，提供良好对比度 */
        text-align: center; /* 文本居中对齐 */
        padding: 12px 0 36px 100px; /* 上内边距12px，右内边距0，下内边距36px，左内边距100px */
        transition: transform 0.2s ease; /* 变换属性添加0.2秒过渡效果，使交互更平滑 */
    }

    /* 材料标题悬停效果 */
    .material-title:hover {
        transform: scale(1.05); /* 悬停时放大到原尺寸的1.05倍，创建微妙的交互反馈 */
    }

    /* 导航链接容器样式 */
    .nav-links {
        display: flex; /* 使用弹性布局，使链接水平排列 */
        align-items: center; /* 子元素在垂直方向上居中对齐 */
    }
    
    /* 导航链接基本样式 */
    .nav-link {
        padding: 0 15px; /* 左右内边距15px，提供足够的点击区域 */
        color: #64748b; /* 默认状态下的灰蓝色文本颜色 */
        text-decoration: none; /* 移除默认的下划线装饰 */
        font-size: 0.95rem; /* 字体大小略小于基准大小，保持紧凑 */
        font-weight: 1000; /* 字体中等加粗，增强可读性 */
        transition: color 0.2s ease; /* 颜色变化时的平滑过渡效果 */
        height: 60px; /* 设置链接高度为60px，提供足够的点击区域 */
        display: flex; /* 使用弹性布局，便于垂直居中图标和文本 */
        align-items: center; /* 子元素在垂直方向上居中对齐 */
        position: relative; /* 设置为相对定位，为active状态的底部指示条准备 */
    }

    /* 导航链接悬停效果 */
    .nav-link:hover {
        color: #0047AB; /* 悬停时变为深蓝色，提供视觉反馈 */
    }

    /* 当前激活的导航链接样式 */
    .nav-link.active {
        color: #0047AB; /* 激活状态下使用深蓝色文本 */
    }
    
    /* 激活导航链接的底部指示条 */
    .nav-link.active::after {
        content: ''; /* 创建一个空内容的伪元素 */
        position: absolute; /* 绝对定位，相对于.nav-link */
        bottom: 0; /* 定位到父元素底部 */
        left: 15px; /* 左边缘与父元素内边距对齐 */
        right: 15px; /* 右边缘与父元素内边距对齐 */
        height: 4px; /* 高度为3px的细线 */
        background: #0047AB; /* 深蓝色背景，与激活文本颜色匹配 */
    }

    /* 导航链接中的图标样式 */
    .nav-link i {
        margin-right: 6px; /* 图标右侧添加6px间距，与文本分开 */
    }
    
    /* 返回链接特殊样式 */
    .nav-link.back-link {
        background-color: #f1f5f9; /* 浅灰色背景，区分于普通导航链接 */
        border-radius: 8px; /* 圆角边框，创建按钮外观 */
        padding: 0 15px; /* 左右内边距保持15px */
        height: 40px; /* 减小高度为40px，与其他链接区分 */
        margin-left: 10px; /* 左侧外边距10px，与其他链接保持间距 */
    }
    
    /* 返回链接悬停效果 */
    .nav-link.back-link:hover {
        background-color: #e2e8f0; /* 悬停时背景色变深，提供视觉反馈 */
    }

    /* ===== 内容区域布局样式 ===== */
    
    /* 内容区块样式 - 每个主要内容部分（如结构、晶体数据等）的容器 */
    .content-section {
        margin-bottom: 30px; /* 区块之间添加30px的底部间距，提高可读性 */
    }
    
    /* 两列布局容器 - 用于并排展示相关信息 */
    .two-column-layout {
        display: flex; /* 使用弹性布局实现并排排列 */
        gap: 24px; /* 列之间的间距为24px，提供良好的视觉分隔 */
        margin-bottom: 24px; /* 底部间距24px，与下一个部分分开 */
    }
    
    /* 宽列样式 - 用于主要内容展示（占60%宽度） */
    .column-60 {
        flex: 6; /* 在弹性分配中占6份，实际效果约为60%宽度 */
    }
    
    /* 窄列样式 - 用于辅助内容展示（占40%宽度） */
    .column-40 {
        flex: 4; /* 在弹性分配中占4份，实际效果约为40%宽度 */
    }

    /* ===== 卡片组件样式 ===== */
    
    /* 详情卡片 - 包含标题和内容的基本信息展示组件 */
    .detail-card {
        background: #fff; /* 纯白色背景，提供干净的视觉效果 */
        border-radius: 12px; /* 圆角边框，增加现代感 */
        box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px; /* 轻微阴影，增加层次感 */
        margin-bottom: 20px; /* 底部间距20px，分隔相邻卡片 */
        transition: all 0.3s ease; /* 所有属性变化添加平滑过渡 */
        border: 1px solid #e5e7eb; /* 浅灰色边框，增强边界感 */
        overflow: hidden; /* 隐藏超出边界的内容，保持整洁 */
    }

    /* 卡片悬停效果 - 增强用户交互反馈 */
    .detail-card:hover {
        box-shadow: rgba(0, 0, 0, 0.15) 0px 8px 24px; /* 悬停时增强阴影效果，提高视觉突出度 */
    }

    /* 卡片头部 - 包含标题和折叠控制按钮 */
    .card-header {
        display: flex; /* 弹性布局，便于排列标题和控制按钮 */
        align-items: center; /* 子元素垂直居中 */
        justify-content: space-between; /* 标题靠左，按钮靠右 */
        background: linear-gradient(to right, #f1f5f9, #f8fafc); /* 从左到右的浅色渐变背景 */
        border-bottom: 1px solid #e5e7eb; /* 底部边框，与卡片内容区域分隔 */
        padding: 16px 20px; /* 上下内边距16px，左右内边距20px，确保足够的空间 */
        cursor: pointer; /* 鼠标指针变为手型，提示可点击 */
    }

    /* 卡片标题样式 */
    .card-header h3 {
        margin: 0; /* 移除默认外边距 */
        color: #1e293b; /* 深蓝灰色文本，提供良好对比度 */
        font-size: 1.3rem; /* 字体大小适中，突出重要性但不过分夸张 */
        font-weight: 600; /* 字体加粗，增强可读性 */
    }
    
    /* 卡片折叠/展开图标 */
    .card-header .toggle-icon {
        color: #64748b; /* 图标使用灰色，不抢视觉焦点 */
        transition: transform 0.3s ease; /* 旋转变换添加平滑过渡效果 */
    }
    
    /* 折叠状态下的图标旋转效果 */
    .card-header.collapsed .toggle-icon {
        transform: rotate(-90deg); /* 图标旋转-90度，提供视觉状态指示 */
    }

    /* 卡片内容区域 */
    .card-content {
        padding: 20px; /* 四周内边距20px，提供内容呼吸空间 */
        transition: max-height 0.3s ease, opacity 0.3s ease; /* 高度和透明度变化添加平滑过渡 */
        max-height: 2000px; /* 展开状态下的最大高度，足够容纳大多数内容 */
        opacity: 1; /* 完全不透明，内容清晰可见 */
        overflow: hidden; /* 隐藏超出高度限制的内容 */
    }
    
    /* 折叠状态下的内容区域 */
    .card-content.collapsed {
        max-height: 0; /* 高度为0，内容完全隐藏 */
        padding: 0 20px; /* 上下内边距为0，左右保持20px，防止内容突然变化 */
        opacity: 0; /* 完全透明，内容不可见 */
    }

    .card-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .card-content li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .card-content li:last-child {
        border-bottom: none;
    }

    .property-label {
        color: #64748b;
        font-weight: 500;
        font-size: 1.05rem;
    }

    .property-value {
        color: #0047AB;
        font-weight: 600;
        padding: 6px 14px;
        background: #F5F8FF;
        border-radius: 6px;
        font-size: 1.05rem;
    }

/* 原子坐标表格样式 */
.atom-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.05rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.atom-table th {
    background-color: #f1f5f9;
    color: #334155;
    font-weight: 600;
    text-align: center;
    padding: 12px 10px;
    border-bottom: 2px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 1;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.atom-table td {
    padding: 12px 10px;
    text-align: center;
    border-bottom: 1px solid #e5e7eb;
    transition: background-color 0.2s ease;
}

.atom-table tbody tr:nth-child(odd) {
    background-color: #f8fafc;
}

.atom-table tbody tr:hover {
    background-color: #EFF6FF;
}

.atom-coords-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    margin-top: 12px;
    scrollbar-width: thin;
    scrollbar-color: #94a3b8 #f1f5f9;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.atom-coords-container::-webkit-scrollbar {
    width: 8px;
}

.atom-coords-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 6px;
}

.atom-coords-container::-webkit-scrollbar-thumb {
    background-color: #94a3b8;
    border-radius: 6px;
    border: 2px solid #f1f5f9;
}

.atom-coords-container::-webkit-scrollbar-thumb:hover {
    background-color: #0047AB;
}

.atom-info {
    margin-bottom: 15px;
    color: #475569;
    font-size: 1.05rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.atom-info p {
    margin: 0;
    line-height: 1.5;
}

.coordinates-toggle {
    display: flex;
    margin-bottom: 20px;
    justify-content: flex-end;
}

.coords-toggle-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to right, #EFF6FF, #DBEAFE);
    color: #0047AB;
    border: 1px solid #BFDBFE;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 71, 171, 0.15);
    position: relative;
    overflow: hidden;
    min-width: 160px;
}

.coords-toggle-btn:hover {
    background: linear-gradient(to right, #DBEAFE, #BFDBFE);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 71, 171, 0.3);
}

.coords-toggle-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 3px rgba(0, 71, 171, 0.2);
}

.coords-toggle-btn i {
    margin-right: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.coords-toggle-btn.active {
    background: linear-gradient(to right, #0047AB, #1E40AF);
    color: white;
}

.coords-toggle-btn.active i {
    transform: rotate(180deg);
}

.coords-toggle-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
    transform: translateX(-100%);
    transition: transform 0.6s ease;
}

.coords-toggle-btn:hover::before {
    transform: translateX(100%);
}

.toggle-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 0.85rem;
    color: #64748b;
    transition: color 0.2s ease;
}

.toggle-label:hover {
    color: #0047AB;
}

.toggle-label input {
    margin-right: 6px;
}

.atom-element {
    font-weight: 600;
    color: #0047AB;
    font-size: 1.05rem;
}

.atom-coords {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    letter-spacing: 0.5px;
    color: #334155;
    font-size: 1.05rem;
}

.atom-total {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.atom-composition {
    font-style: italic;
    color: #64748b;
    font-size: 1rem;
}

/* 3D结构查看器样式 */
.viewer-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: rgba(17, 12, 46, 0.1) 0px 8px 24px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.viewer-container:hover {
    box-shadow: rgba(0, 0, 0, 0.15) 0px 8px 24px;
}

.viewer-content {
    padding: 0 20px 20px;
    transition: max-height 0.3s ease, opacity 0.3s ease;
    max-height: 2000px;
    opacity: 1;
    overflow: hidden;
}

.viewer-content.collapsed {
    max-height: 0;
    padding: 0 20px;
    opacity: 0;
}

.crystal-viewer {
    width: 100%;
    height: 625px; /* 增加25%的高度 */
    border-radius: 8px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

/* 确保3D查看器控件不会覆盖导航栏 */
.crystal-viewer canvas, 
.crystal-viewer div {
    z-index: 10 !important; /* 强制降低z-index */
}

/* 能带结构图样式 */
#bandStructure, #scStructure {
    width: 100%;
    flex-grow: 1; /* 让图表容器填充剩余空间 */
    min-height: 625px; /* 增加25%的高度 */
    border-radius: 8px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

/* 共享交互效果 */
.crystal-viewer:hover, #bandStructure:hover, #scStructure:hover {
    border-color: #0047AB;
    box-shadow: rgba(0, 71, 171, 0.15) 0px 0px 0px 4px;
}

/* 响应式调整 */
@media (max-width: 1200px) {
    .two-column-layout {
        flex-direction: column;
    }
    
    .column-60, .column-40 {
        flex: 1;
        width: 100%;
    }
    
    .crystal-viewer, #bandStructure {
        height: 500px; /* 同样增加25%的高度 */
    }
}

@media (max-width: 768px) {
    .material-detail-container {
        padding: 16px;
        margin-top: 200px; /* 在小屏幕上增加更多的顶部间距以适应新导航栏 */
    }
    
    .top-nav {
        height: auto;
        flex-direction: column;
        padding: 15px;
        top: 56px; /* 在小屏幕上，主导航栏通常更窄 */
    }
    
    .material-title {
        font-size: 1.8em;
        margin: 0 0 15px 0;
        text-align: center;
        width: 100%;
    }
    
    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
        margin: 0;
        gap: 8px;
        width: 100%;
    }
    
    .nav-link {
        height: 40px;
        padding: 0 12px;
        font-size: 1rem;
        border-radius: 6px;
    }
    
    .nav-link.active {
        border-radius: 6px;
        background-color: rgba(0, 71, 171, 0.1);
    }
    
    .nav-link.active::after {
        height: 3px;
        bottom: 5px;
        left: 10px;
        right: 10px;
        border-radius: 1.5px;
    }

    .crystal-viewer, #bandStructure {
        height: 375px; /* 同样增加25%的高度 */
    }
}

/* 为iPad和其他平板设备添加特殊处理 */
@media (min-width: 769px) and (max-width: 1024px) {
    .material-detail-container {
        margin-top: 130px;
    }
    
    .top-nav {
        top: 60px;
    }
}

/* 卡片头部操作按钮样式 */
.card-header-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.download-btn {
    color: #0047AB;
    background-color: #EFF6FF;
    border: 1px solid #BFDBFE;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0, 71, 171, 0.15);
    position: relative;
    overflow: hidden;
    margin-left: 10px;
    vertical-align: middle;
}

.download-btn i {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.download-btn:hover {
    color: white;
    background-color: #0047AB;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 71, 171, 0.3);
}

.download-btn:hover i {
    transform: scale(1.1);
}

.download-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 3px rgba(0, 71, 171, 0.2);
}

/* 8:2 布局专用样式 */
.sc-layout {
    display: flex;
    gap: 24px;
    margin-bottom: 24px;
}

.column-80 {
    flex: 8;
}

.column-20 {
    flex: 2;
}

/* 响应式调整 */
@media (max-width: 1200px) {
    .sc-layout {
        flex-direction: column;
    }
    
    .column-80, .column-20 {
        flex: 1;
        width: 100%;
    }
}

/* 确保全局比例缩放时界面元素也相应调整 */
@media (min-resolution: 120dpi) {
    .top-nav, .material-title, .nav-links,
    .card-header, .card-content, .property-label, .property-value {
        transform-origin: left top;
        transform: scale(0.95);
    }
}

/* ===================== SC结构图相关样式 ===================== */
/* 响应式控制面板 */
.sc-control-panel {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding: 15px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    position: relative;
    flex-wrap: wrap;
    gap: 10px;
}

/* 控制面板在小屏幕上的样式 */
@media (max-width: 768px) {
    .sc-control-panel {
        flex-direction: column;
        align-items: flex-start;
    }
    .sc-control-status {
        width: 100%;
        text-align: left;
        margin-top: 5px;
    }
}

/* 提示文本响应式样式 */
.sc-control-tip {
    font-size: 16px;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 250px;
}

.control-tip-text {
    font-weight: 500;
    display: inline-block;
    border-left: 3px solid #0047AB;
    padding-left: 8px;
    line-height: 1.4;
}

.sc-control-tip i {
    color: #0047AB;
    font-size: 18px;
}

/* 响应式重置按钮 */
.sc-control-item {
    display: flex;
    gap: 10px;
}

.sc-control-btn {
    padding: 8px 16px;
    background: #0047AB;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    white-space: nowrap;
}

/* 按钮悬停和活动状态 */
.sc-control-btn:hover {
    background: #00348F;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.sc-control-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}

.sc-control-btn.active {
    background: #003366;
}

/* 可见曲线计数样式 */
.sc-control-status {
    font-size: 15px;
    color: #4b5563;
    font-weight: 500;
    background: rgba(224, 231, 255, 0.6);
    padding: 6px 12px;
    border-radius: 4px;
    border-left: 3px solid #0047AB;
}

.visible-count-text {
    white-space: nowrap;
}

/* 图例交互样式增强 */
/* 整体图例容器样式 */
.js-plotly-plot .legend {
    /* 设置圆角为8px，使图例更圆润 */
    border-radius: 8px !important;
    /* 添加微妙的阴影效果，提供层次感 */
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
}

/* 图例中每个条目的开关按钮样式 */
.js-plotly-plot .legend .traces .legendtoggle {
    /* 设置鼠标指针为手型，表示可点击 */
    cursor: pointer;
    /* 添加0.2秒的平滑过渡效果 */
    transition: all 0.1s ease;
    /* 设置圆角为4px，与整体风格统一 */
    border-radius: 4px;
}

/* 图例开关按钮悬停效果 */
.js-plotly-plot .legend .traces .legendtoggle:hover {
    /* 悬停时添加浅蓝色背景，使用主题色0047AB，透明度0.15 */
    background-color: rgba(0, 71, 171, 0.15) ;
    /* 添加发光效果，增强视觉反馈 */
    box-shadow: 0 0 8px rgba(0, 71, 171, 0.3);
}

/* 显示状态的图例项样式 */
.js-plotly-plot .legend .traces .legendtext {
    /* 添加0.2秒的平滑过渡效果，使状态变化更自然 */
    transition: all 0.2s ease;
    
    /* 设置内边距，使文本周围有适当的空白空间 */
    padding: 4px 8px;
    
    /* 添加圆角效果，使外观更现代化 */
    border-radius: 5px;
    
    /* 设置字体大小为16像素，确保清晰可读 */
    font-size: 16px ;
    
    /* 设置行高为1.4倍字体大小，优化文本间距 */
    line-height: 1.4 ;
    
    /* 设置相对定位，为后续的悬停提示做准备 */
    position: relative;
}

.js-plotly-plot .legend .traces:not([style*="opacity: 0.5"]) .legendtext {
    font-weight: 600;
    color: #1f2937 !important;
}

.js-plotly-plot .legend .traces:hover .legendtext {
    background-color: rgba(0, 71, 171, 0.1);
    transform: translateX(3px);
}

/* 隐藏状态的图例项样式 */
.js-plotly-plot .legend .traces[style*="opacity: 0.5"] .legendtext {
    text-decoration: line-through;
    color: #a0aec0 !important;
    background-color: rgba(226, 232, 240, 0.5);
    font-size: 16px !important;
}

.js-plotly-plot .legend .traces[style*="opacity: 0.5"]:hover .legendtext {
    background-color: rgba(226, 232, 240, 0.8);
    color: #718096 !important;
}

/* 图例项激活样式 */
.js-plotly-plot .legend .traces.active .legendtext {
    background-color: rgba(0, 71, 171, 0.2);
    box-shadow: 0 0 8px rgba(0, 71, 171, 0.4);
    transform: translateX(3px);
}

/* 图例悬停提示 */
.js-plotly-plot .legend .traces .legendtext::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(17, 24, 39, 0.9);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 10;
}

.js-plotly-plot .legend .traces .legendtext:hover::after {
    opacity: 1;
    visibility: visible;
    bottom: calc(100% + 5px);
}

/* 自定义滚动条样式 */
.js-plotly-plot .legend::-webkit-scrollbar {
    width: 10px;
}

.js-plotly-plot .legend::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 6px;
}

.js-plotly-plot .legend::-webkit-scrollbar-thumb {
    background-color: #0047AB;
    border-radius: 6px;
    border: 2px solid #f1f5f9;
}

.js-plotly-plot .legend::-webkit-scrollbar-thumb:hover {
    background-color: #003380;
}

/* Firefox滚动条样式 */
.js-plotly-plot .legend {
    scrollbar-width: thin;
    scrollbar-color: #0047AB #f1f5f9;
}

/* 弹出通知样式 */
.sc-notification {
    position: absolute;
    top: -50px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #0047AB;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 100;
    font-size: 16px;
    opacity: 1;
    transition: opacity 0.5s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sc-notification i {
    color: #ffff00;
    font-size: 18px;
}

/* 响应式字体大小调整 */
@media (max-width: 1200px) {
    .sc-control-tip, .sc-control-status {
        font-size: 14px;
    }
    .sc-control-btn {
        font-size: 13px;
        padding: 6px 12px;
    }
    .js-plotly-plot .legend .traces .legendtext {
        font-size: 14px !important;
    }
}

/* SC元素关系样式 */
@keyframes scrollPulse {
    0% { opacity: 0.7; }
    50% { opacity: 0.3; }
    100% { opacity: 0.7; }
}

.scrollable::after {
    content: '';
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 4px;
    background-color: #0047AB;
    border-radius: 2px;
    opacity: 0.7;
    animation: scrollPulse 1.5s infinite;
}

/* 图例项整体样式 */
.js-plotly-plot .legend .traces {
    /* 为每个图例项添加底部外边距，确保图例项之间有适当间距 */
    margin-bottom: 6px !important;
    /* 为每个图例项添加底部内边距，使内容与边框保持一定距离 */
    padding-bottom: 8px !important;
    /* !important用于覆盖plotly.js的默认样式 */
}

/* 新的原子信息卡片样式 */
.atom-info-card {
    background: linear-gradient(to right, #f1f5f9, #f8fafc);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 12px;
    border: 1px solid #e5e7eb;
}

.atom-info-section {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
}

.atom-count {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border: 1px solid #e5e7eb;
}

.atom-count i {
    color: #0047AB;
    font-size: 1.3rem;
}

.atom-total {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.atom-total-label {
    font-size: 1.1rem;
    color: #64748b;
    margin-left: 4px;
}

.atom-composition-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-width: 70%;
}

.element-chip {
    display: flex;
    align-items: center;
    background: #ffffff;
    border-radius: 6px;
    padding: 6px 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 1px solid #e5e7eb;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.element-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}

.element-symbol {
    font-weight: 600;
    color: #0047AB;
    margin-right: 4px;
    font-size: 0.95rem;
}

.element-count {
    color: #64748b;
    font-size: 0.9rem;
}

.coords-display-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    color: #475569;
    padding: 8px 16px;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border: 1px solid #e5e7eb;
    width: fit-content;
}

.coords-display-info i {
    color: #0047AB;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .atom-info-section {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .atom-composition-container {
        max-width: 100%;
    }
    
    .atom-total {
        font-size: 1.3rem;
    }
}

/* 添加脉冲动画效果 */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.pulse-animation {
    animation: pulse 0.5s ease;
}
    </style>

    <!-- ====================== 第一栏：3D结构和晶体结构 ====================== -->
    <div id="first-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：3D结构显示区域 (60%) -->
            <div class="column-60">
                <div class="viewer-container">
                    <div class="card-header">
                <h3>3D Structure</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="viewer-content">
                <div class="crystal-viewer" id="crystalViewer"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：晶体结构信息 (40%) -->
            <div class="column-40">
                <div class="detail-card" id="crystal-structure">
                    <div class="card-header">
                        <h3>Crystal Structure</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content">
                        <ul>
                            <li><span class="property-label">Lattice a:</span> <span class="property-value" id="lattice-a">Loading...</span></li>
                            <li><span class="property-label">Lattice b:</span> <span class="property-value" id="lattice-b">Loading...</span></li>
                            <li><span class="property-label">Lattice c:</span> <span class="property-value" id="lattice-c">Loading...</span></li>
                            <li><span class="property-label">α:</span> <span class="property-value" id="lattice-alpha">Loading...</span></li>
                            <li><span class="property-label">β:</span> <span class="property-value" id="lattice-beta">Loading...</span></li>
                            <li><span class="property-label">γ:</span> <span class="property-value" id="lattice-gamma">Loading...</span></li>
                            <li><span class="property-label">Volume:</span> <span class="property-value" id="lattice-volume">Loading...</span></li>
                            <li><span class="property-label">Density:</span> <span class="property-value" id="structure-density">Loading...</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 第二栏：晶体对称性和原子坐标 ====================== -->
    <div id="second-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：晶体对称性 -->
            <div class="column-40">
                <div class="detail-card" id="crystal-symmetry">
                    <div class="card-header collapsed">
                        <h3>Crystal Symmetry</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li><span class="property-label">Crystal System:</span> <span class="property-value" id="crystal-system">Loading...</span></li>
                            <li><span class="property-label">Space Group:</span> <span class="property-value" id="space-group">Loading...</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：原子坐标 -->
            <div class="column-60">
                <div class="detail-card" id="atomic-coordinates">
                    <div class="card-header collapsed">
                        <h3>Atomic Coordinates</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <div class="coordinates-toggle">
                            <button class="coords-toggle-btn" id="coords-toggle-btn">
                                <i class="fas fa-sync-alt"></i>
                                <span id="toggle-btn-text">Show Fractional</span>
                            </button>
                        </div>
                        <div id="atom-list">Loading atomic coordinates...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 第三栏：能带信息和能带性质 ====================== -->
    <div id="third-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：能带图 (60%) -->
            <div class="column-60">
                <div class="viewer-container">
                    <div class="card-header collapsed">
                <h3>Band Structure
                    <a href="{{ url_for('static', filename='materials/' + (material.formatted_id or 'IMR-' + '%08d'|format(material.id)) + '/band/band.dat') }}" download class="download-btn" title="Download band data">
                        <i class="fas fa-download"></i>
                    </a>
                </h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="viewer-content card-content collapsed">
                <div id="bandStructure"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：能带结构属性 (40%) -->
            <div class="column-40">
                <div class="detail-card" id="band-structure">
                    <div class="card-header collapsed">
                        <h3>Band Structure</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li><span class="property-label">Band Gap:</span> <span class="property-value">{{ material.gap ~ ' eV' if material.gap is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">VBM Energy:</span> <span class="property-value">{{ material.vbm_energy ~ ' eV' if material.vbm_energy is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">CBM Energy:</span> <span class="property-value">{{ material.cbm_energy ~ ' eV' if material.cbm_energy is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">VBM Coordinates:</span> <span class="property-value">{{ material.vbm_coordi or 'Not available yet' }}</span></li>
                            <li><span class="property-label">CBM Coordinates:</span> <span class="property-value">{{ material.cbm_coordi or 'Not available yet' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================== SC部分：SC结构图 ====================== -->
    <div id="sc-section" class="content-section">
        <div class="sc-layout">
            <!-- 左侧：SC图 (80%) -->
            <div class="column-80">
                <div class="viewer-container">
                    <div class="card-header collapsed">
                        <h3>SC Structure
                            <a href="{{ url_for('static', filename='materials/' + (material.formatted_id or 'IMR-' + '%08d'|format(material.id)) + '/bcd/sc.dat') }}" download class="download-btn" title="Download SC data">
                                <i class="fas fa-download"></i>
                            </a>
                        </h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="viewer-content card-content collapsed">
                        <div id="scStructure"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：SC属性 (20%) -->
            <div class="column-20">
                <div class="detail-card" id="sc-properties">
                    <div class="card-header collapsed">
                        <h3>Element Relations</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed" id="element-relations-content">
                        <!-- 元素关系表格在此显示 -->
                        <style>
                            .relations-table {
                                font-size: 14px;
                            }
                            .relations-table table {
                                width: 100%;
                                border-collapse: collapse;
                            }
                            .relations-table th,
                            .relations-table td {
                                padding: 8px;
                                text-align: left;
                                border-bottom: 1px solid #e5e7eb;
                            }
                            .relations-table th {
                                background-color: #f1f5f9;
                                font-weight: 600;
                                color: #334155;
                            }
                            .relations-table tr:hover {
                                background-color: #f8fafc;
                            }
                            .zero-group {
                                color: #6B7280;
                                font-style: italic;
                            }
                            .same-relation {
                                color: #0047AB;
                                font-weight: 500;
                            }
                            .opposite-relation {
                                color: #B91C1C;
                                font-weight: 500;
                            }
                            .mixed-relation {
                                color: #7E22CE;
                                font-weight: 500;
                            }
                            .single-curve {
                                color: #4B5563;
                            }
                            .relations-header {
                                margin-bottom: 15px;
                                border-bottom: 1px solid #e5e7eb;
                                padding-bottom: 10px;
                            }
                            .relations-legend {
                                list-style: none;
                                padding: 0;
                                margin: 0;
                                display: flex;
                                gap: 15px;
                                justify-content: center;
                            }
                            .relations-legend li {
                                display: flex;
                                align-items: center;
                                font-size: 12px;
                                color: #4B5563;
                            }
                            .zero-indicator {
                                color: #6B7280;
                                font-size: 16px;
                                margin-right: 5px;
                            }
                            .same-indicator {
                                color: #0047AB;
                                font-size: 16px;
                                margin-right: 5px;
                            }
                            .opposite-indicator {
                                color: #B91C1C;
                                font-size: 16px;
                                margin-right: 5px;
                            }
                        </style>
                        
                        <div class="relations-header">
                            <ul class="relations-legend">
                                <li><span class="zero-indicator">●</span> Zero</li>
                                <li><span class="same-indicator">●</span> Same</li>
                                <li><span class="opposite-indicator">●</span> Opposite</li>
                            </ul>
                        </div>
                        
                        <div id="relations-table-container">
                            <div class="loading-message">
                                Loading element relations...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 第四栏：基本信息和表面属性 ====================== -->
    <div id="fourth-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：基本属性 -->
            <div class="column-40">
                <div class="detail-card" id="basic-properties">
                    <div class="card-header collapsed">
                        <h3>Basic Properties</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li><span class="property-label">ID:</span> <span class="property-value">{{ material.formatted_id or 'IMR-' + '%08d'|format(material.id) }}</span></li>
                            <li><span class="property-label">Status:</span> <span class="property-value">{{ material.status or 'Not available yet' }}</span></li>
                            <li><span class="property-label">Total Energy:</span> <span class="property-value">{{ material.total_energy ~ ' eV' if material.total_energy is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">Formation Energy:</span> <span class="property-value">{{ material.formation_energy ~ ' eV' if material.formation_energy is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">Fermi Level:</span> <span class="property-value">{{ material.fermi_level ~ ' eV' if material.fermi_level is not none else 'Not available yet' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：表面属性 -->
            <div class="column-40">
                <div class="detail-card" id="surface-properties">
                    <div class="card-header collapsed">
                        <h3>Surface Properties</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li><span class="property-label">Vacuum Level:</span> <span class="property-value">{{ material.vacuum_level ~ ' eV' if material.vacuum_level is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">Work Function:</span> <span class="property-value">{{ material.workfunction ~ ' eV' if material.workfunction is not none else 'Not available yet' }}</span></li>
                            <li><span class="property-label">Metal Type:</span> <span class="property-value">{{ material.metal_type or 'Not available yet' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript区域 -->
<script>
/**
 * 页面加载完成后的初始化函数
 * 负责设置各种组件、加载数据和绑定事件监听器
 */
document.addEventListener('DOMContentLoaded', function() {
    // 初始化3D晶体结构查看器
    // 'crystalViewer'是DOM容器ID，用于放置3D模型
    CrystalViewer.init('crystalViewer'); 
    // 加载特定材料ID的晶体结构数据
    CrystalViewer.load("{{ material.id }}");
    
    // 初始化能带结构图
    // 构建能带数据文件的URL路径
    const bandDataPath = "{{ url_for('static', filename='materials/' + (material.formatted_id or 'IMR-' + '%08d'|format(material.id)) + '/band/band.dat') }}";
    // 调用绘图函数，传入容器ID和数据路径
    plotBandStructure('bandStructure', bandDataPath);
    
    // 初始化SC结构图（自相关性结构图）
    // 构建主要SC数据文件的URL路径
    const scDataPath = "{{ url_for('static', filename='materials/' + (material.formatted_id or 'IMR-' + '%08d'|format(material.id)) + '/bcd/sc.dat') }}";
    // 构建备用示例数据文件的URL路径，当主文件不可用时使用
    const fallbackScDataPath = "{{ url_for('static', filename='materials/example_sc.dat') }}";
    
    // 使用fetch API加载SC数据文件
    fetch(scDataPath)
        .then(response => {
            // 检查响应状态
            if (!response.ok) {
                // 如果主数据文件不可用，记录信息并尝试加载备用文件
                console.log('使用示例SC数据文件');
                return fetch(fallbackScDataPath);
            }
            // 主数据文件加载成功，直接返回响应对象
            return response;
        })
        .then(response => {
            // 检查响应状态（可能是主文件或备用文件）
            if (response.ok) {
                // 数据加载成功，调用绘图函数
                plotSCStructure('scStructure', response.url);
            } else {
                // 所有数据源均不可用，显示错误信息
                console.error('无法加载SC数据文件');
                document.getElementById('scStructure').innerHTML = `<div style="text-align:center;padding:50px;color:#666;background:#f9f9f9;border-radius:8px;margin:20px 0;font-size:18px;">
                    <p>No data</p>
                </div>`;
            }
        })
        .catch(error => {
            // 处理请求过程中的任何错误（网络问题等）
            console.error('SC数据加载失败:', error);
            document.getElementById('scStructure').innerHTML = `<div style="text-align:center;padding:50px;color:#666;background:#f9f9f9;border-radius:8px;margin:20px 0;font-size:18px;">
                <p>No data</p>
            </div>`;
        });
    
    // 初始化卡片折叠功能
    initializeCollapsibleCards();
    
    // 获取所有导航链接
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.content-section');
    
    // 阻止下载按钮点击事件传播
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // 监听滚动事件，高亮当前所在的导航项
    window.addEventListener('scroll', function() {
        let current = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (pageYOffset >= (sectionTop - 180)) {
                current = section.getAttribute('id');
            }
        });
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            const href = link.getAttribute('href');
            if (href && href.slice(1) === current) {
                link.classList.add('active');
            }
        });
    });
    
    // 为导航链接添加点击事件
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href && href.startsWith('#')) {
                e.preventDefault();
                const targetId = href.substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    window.scrollTo({
                        top: targetSection.offsetTop - 180, // 增加更大偏移量，确保标题完全可见
                        behavior: 'smooth'
                    });
                }
            }
        });
    });
    
    // 加载晶体结构数据
    loadCrystalStructureData();
});

// 初始化可折叠卡片功能
function initializeCollapsibleCards() {
    const cardHeaders = document.querySelectorAll('.card-header');
    
    cardHeaders.forEach(header => {
        // 绑定点击事件切换折叠状态
        header.addEventListener('click', function() {
            this.classList.toggle('collapsed');
            
            // 获取相邻的内容区域
            let content = this.nextElementSibling;
            
            // 处理3D结构查看器和能带图的特殊情况
            if (content.classList.contains('viewer-content')) {
                content.classList.toggle('collapsed');
                
                // 处理3D结构查看器的特殊情况
                if (!content.classList.contains('collapsed') && content.querySelector('#crystalViewer')) {
                    // 延迟一下，等待内容展开后再重新调整3D查看器
                    setTimeout(() => {
                        if (window.CrystalViewer && CrystalViewer.updateSize) {
                            CrystalViewer.updateSize();
                        }
                    }, 300);
                }
                
                // 处理能带图的特殊情况
                if (!content.classList.contains('collapsed') && content.querySelector('#bandStructure')) {
                    setTimeout(() => {
                        if (window.Plotly) {
                            Plotly.relayout('bandStructure', {autosize: true});
                        }
                    }, 300);
                }
            } else {
                content.classList.toggle('collapsed');
            }
        });
    });
    
    // 默认展开第一栏
    const firstSectionCards = document.querySelector('#first-section').querySelectorAll('.card-header');
    firstSectionCards.forEach(header => {
        header.classList.remove('collapsed');
        
        // 获取相邻的内容区域
        const content = header.nextElementSibling;
        content.classList.remove('collapsed');
    });
    
    // 页面加载后，确保内容不被顶部导航栏遮挡
    setTimeout(() => {
        const firstSection = document.getElementById('first-section');
        if (firstSection) {
            // 如果当前滚动位置过低(可能导致标题被遮挡)，则自动滚动到适当位置
            if (window.scrollY < firstSection.offsetTop - 180 && window.scrollY > 0) {
                window.scrollTo({
                    top: firstSection.offsetTop - 180,
                    behavior: 'smooth'
                });
            }
        }
    }, 500);
}

// 加载晶体结构数据的函数
function loadCrystalStructureData() {
    const materialId = "{{ material.id }}";
    const materialName = "{{ material.name }}";
    
    // 创建API请求URL
    let url = `/api/structure?material_id=${materialId}`;
    if (!materialId && materialName) {
        url = `/api/structure?material_name=${materialName}`;
    }
    
    // 发送请求获取晶体结构数据
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("Error loading crystal structure data:", data.error);
                document.querySelectorAll('#crystal-structure .property-value').forEach(el => {
                    el.textContent = 'Data not available';
                });
                return;
            }
            
            // 更新晶体结构卡片中的数据
            // 晶体系统
            if (data.symmetry && data.symmetry.crystal_system) {
                document.getElementById('crystal-system').textContent = data.symmetry.crystal_system;
            }
            
            // 空间群
            if (data.symmetry && data.symmetry.space_group_symbol) {
                const spaceGroup = `${data.symmetry.space_group_symbol} (${data.symmetry.space_group_number})`;
                document.getElementById('space-group').textContent = spaceGroup;
            }
            
            // 晶格参数
            if (data.lattice) {
                document.getElementById('lattice-a').textContent = `${data.lattice.a.toFixed(2)} Å`;
                document.getElementById('lattice-b').textContent = `${data.lattice.b.toFixed(2)} Å`;
                document.getElementById('lattice-c').textContent = `${data.lattice.c.toFixed(2)} Å`;
                document.getElementById('lattice-alpha').textContent = `${data.lattice.alpha.toFixed(2)}°`;
                document.getElementById('lattice-beta').textContent = `${data.lattice.beta.toFixed(2)}°`;
                document.getElementById('lattice-gamma').textContent = `${data.lattice.gamma.toFixed(2)}°`;
                document.getElementById('lattice-volume').textContent = `${data.lattice.volume.toFixed(2)} Å³`;
            }
            
            // 密度
            if (data.density) {
                document.getElementById('structure-density').textContent = `${data.density.toFixed(2)} g/cm³`;
            }
            
            // 添加原子坐标信息
            if (data.sites && Array.isArray(data.sites)) {
                const atomListElement = document.getElementById('atom-list');
                const totalAtoms = data.sites.length;
                
                // 创建元素计数对象
                const elementCounts = {};
                data.sites.forEach(site => {
                    const element = site.species[0].element;
                    elementCounts[element] = (elementCounts[element] || 0) + 1;
                });
                
                // 构建元素统计信息
                let elementCountsText = Object.entries(elementCounts)
                    .map(([element, count]) => `${element}: ${count}`)
                    .join(', ');
                
                // 创建表格显示原子坐标
                let tableHTML = `
                    <div class="atom-info-card">
                        <div class="atom-info-section">
                            <div class="atom-count">
                                <i class="fas fa-atom"></i>
                                <span class="atom-total">${totalAtoms}</span>
                                <span class="atom-total-label">atoms</span>
                            </div>
                            <div class="atom-composition-container">
                                ${Object.entries(elementCounts).map(([element, count]) => 
                                    `<div class="element-chip"><span class="element-symbol">${element}</span><span class="element-count">${count}</span></div>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="coords-display-info">
                            <i class="fas fa-ruler-combined"></i>
                            <span id="coords-type-label">Showing coordinates in Å</span>
                        </div>
                    </div>
                    <div class="atom-coords-container">
                        <table class="atom-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Element</th>
                                    <th>x</th>
                                    <th>y</th>
                                    <th>z</th>
                                    <th>Wyckoff</th>
                                </tr>
                            </thead>
                            <tbody id="atom-coordinates-body">
                `;
                
                // 添加所有原子的信息，不再限制显示数量
                for (let i = 0; i < totalAtoms; i++) {
                    const site = data.sites[i];
                    const element = site.species[0].element;
                    
                    // 笛卡尔坐标（默认显示）
                    const x = site.xyz[0].toFixed(4);
                    const y = site.xyz[1].toFixed(4);
                    const z = site.xyz[2].toFixed(4);
                    
                    // 分数坐标（初始隐藏）
                    const fx = site.frac_coords[0].toFixed(4);
                    const fy = site.frac_coords[1].toFixed(4);
                    const fz = site.frac_coords[2].toFixed(4);
                    
                    // 获取Wyckoff位置
                    const wyckoff = site.wyckoff || "-";
                    
                    tableHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td class="atom-element">${element}</td>
                            <td class="atom-coords" data-cart="${x}" data-frac="${fx}">${x}</td>
                            <td class="atom-coords" data-cart="${y}" data-frac="${fy}">${y}</td>
                            <td class="atom-coords" data-cart="${z}" data-frac="${fz}">${z}</td>
                            <td>${wyckoff}</td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                atomListElement.innerHTML = tableHTML;
                
                // 添加坐标切换功能
                const coordsToggle = document.getElementById('coords-toggle-btn');
                let showingFractional = false;
                
                coordsToggle.addEventListener('click', function() {
                    showingFractional = !showingFractional;
                    const coordsLabel = document.getElementById('coords-type-label');
                    const toggleText = document.getElementById('toggle-btn-text');
                    
                    // 更新标签
                    coordsLabel.textContent = showingFractional ? 'Showing fractional coordinates' : 'Showing coordinates in Å';
                    toggleText.textContent = showingFractional ? 'Show Cartesian' : 'Show Fractional';
                    
                    // 更新按钮状态
                    if (showingFractional) {
                        this.classList.add('active');
                    } else {
                        this.classList.remove('active');
                    }
                    
                    // 为按钮添加交互视觉效果
                    this.classList.add('pulse-animation');
                    setTimeout(() => {
                        this.classList.remove('pulse-animation');
                    }, 500);
                    
                    // 更新表格中的坐标值
                    const coordCells = document.querySelectorAll('.atom-coords');
                    coordCells.forEach(cell => {
                        const frac = cell.getAttribute('data-frac');
                        const cart = cell.getAttribute('data-cart');
                        cell.textContent = showingFractional ? frac : cart;
                    });
                });
            } else {
                document.getElementById('atom-list').textContent = 'Atomic coordinates not available';
            }
        })
        .catch(error => {
            console.error("Error fetching crystal structure data:", error);
            document.querySelectorAll('#crystal-structure .property-value').forEach(el => {
                el.textContent = 'Error loading data';
            });
            document.getElementById('atom-list').textContent = 'Error loading atomic coordinates';
        });
}
</script>
{% endblock %}
