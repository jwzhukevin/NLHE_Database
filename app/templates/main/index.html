{% extends 'base.html' %}

{% block content %}
<!-- ====================== 数据表格容器 ====================== -->
<div class="data-table-container">
    <style>
    .data-table-container {
        max-width: 1200px;
        margin: 0.5rem auto 2rem auto; /* 减少顶部边距，保持底部边距 */
        padding: 0 20px;
    }
    </style>

    <!-- ====================== 搜索表单 ====================== -->
    <form method="GET" action="{{ url_for('views.index') }}" class="search-form" id="searchForm" onsubmit="return validateSearch()">
        <style>
        /* 搜索表单容器 */
        .search-form {
          /* ---------- 可调节参数 ---------- */
          --form-max-width: 1000px;        /* 控制表单最大宽度，避免在大屏幕上过宽 */
          --form-padding: 1.0rem;         /* 表单内边距，影响内容与边框的距离 */
          --form-gap: 1.0rem;            /* 表单项之间的垂直间距 */
          --border-width: 2px;           /* 表单整体边框粗细 */
          --border-radius: 10px;         /* 表单整体圆角半径 */

          /* 输入控件参数 */
          --input-height: 2rem;          /* 所有输入框/下拉框的统一高度（注意单位） */
          --input-padding: 0.2rem;       /* 输入框内文字与边框的间距 */
          --input-font-size: clamp(0.6rem, 1.0vw, 2.0rem); /* 响应式字体：最小1rem，随视口增长，最大1.2rem */

          /* 按钮参数 */
          --btn-padding: 0.2rem 0.6rem;  /* 按钮内边距（上下 左右） */
          --btn-font-size: clamp(0.6rem, 1.2vw, 2.0rem);       /* 按钮文字大小 */
          --btn-radius: 5px;             /* 按钮圆角半径 */

          /* ---------- 布局样式 ---------- */
          margin: 0.5rem auto 2rem auto;   /* 减少上边距，保持下边距 */
          max-width: var(--form-max-width); /* 应用最大宽度变量 */
          border: var(--border-width) solid #eee; /* 边框样式（颜色#eee） */
          border-radius: var(--border-radius); /* 应用圆角变量 */
          padding: var(--form-padding);  /* 内边距 */
          display: flex;                 /* 弹性布局 */
          flex-direction: column;        /* 垂直排列子元素 */
          gap: var(--form-gap);          /* 子元素间垂直间距 */
          background-color: white;
          box-shadow: var(--card-shadow);
          padding: 2rem;
          margin-bottom: 2rem;
        }
        </style>

        <!-- 基本搜索 -->
        <div class="basic-search">
            <div class="search-input-container">
                <input type="text"
                       name="q"
                       id="searchInput"
                       placeholder="Search materials, MP IDs, space groups..."
                       value="{{ search_params.q }}"
                       aria-label="Search"
                       autocomplete="off">
                <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
            </div>
            <button type="button" class="btn btn-clear" id="clearSearchBtn">Clear</button>
            <button type="submit" class="btn">Search</button>
            <button type="button" class="btn" id="elementsToggleBtn">Elements</button>
            <button type="button" class="btn" onclick="toggleAdvanced()">Advanced</button>
        </div>
        <style>
        /* 基础搜索区域 */
        .basic-search {
          display: flex;                 /* 弹性布局使输入框和按钮横向排列 */
          gap: 0.5rem;                   /* 减小子元素间距 */
          position: relative;            /* 为子元素定位提供参考系 */

          /* 主搜索输入框特定样式 */
          & input[type="text"] {
            flex: 1;                     /* 占据剩余所有空间 */
            height: 2.5rem;              /* 增加高度 */
            padding: 0.5rem 1rem;        /* 适当的内边距 */
            font-size: 1rem;             /* 字体大小 */
            border: 1px solid #D9E2F0;   /* 边框 */
            border-radius: 4px;          /* 减小圆角 */
            transition: border-color 0.1s; /* 边框颜色过渡动画 */
          }

          /* 聚焦状态增强 */
          & input[type="text"]:focus {
            border-color: var(--primary-color); /* 加深边框颜色 */
            outline: none;               /* 移除浏览器默认轮廓线 */
            box-shadow: 0 0 4px rgba(0, 71, 171, 0.2); /* 添加发光效果 */
          }
        }

        /* 搜索按钮样式 */
        .basic-search .btn {
          height: 2.5rem;               /* 与输入框相同高度 */
          padding: 0 1.5rem;            /* 适当的内边距 */
          border-radius: 4px;           /* 减小圆角 */
          font-size: 1rem;              /* 字体大小 */
          font-weight: 500;             /* 字体粗细 */
          transition: all 0.2s;         /* 过渡效果 */
        }

        /* Clear按钮特殊样式 */
        .basic-search .btn-clear {
          background-color: #f3f4f6;    /* 浅灰色背景 */
          color: #6b7280;               /* 灰色文字 */
          border: 1px solid #d1d5db;    /* 灰色边框 */
        }

        .basic-search .btn-clear:hover {
          background-color: #e5e7eb;    /* 悬停时稍深的灰色 */
          color: #374151;               /* 悬停时深色文字 */
          border-color: #9ca3af;        /* 悬停时深色边框 */
        }

        .basic-search .btn-clear:active {
          background-color: #d1d5db;    /* 点击时更深的灰色 */
          transform: translateY(1px);   /* 点击时轻微下移效果 */
        }

        /* 搜索输入容器样式 */
        .search-input-container {
          flex: 1;
          position: relative;
        }

        /* 搜索建议样式 */
        .search-suggestions {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid #d1d5db;
          border-top: none;
          border-radius: 0 0 6px 6px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-height: 300px;
          overflow-y: auto;
          z-index: 1000;
        }

        .suggestion-item {
          padding: 0.75rem 1rem;
          cursor: pointer;
          border-bottom: 1px solid #f3f4f6;
          transition: background-color 0.15s;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
          background-color: #f8fafc;
        }

        .suggestion-item:last-child {
          border-bottom: none;
        }

        .suggestion-label {
          font-weight: 500;
          color: #374151;
        }

        .suggestion-category {
          font-size: 0.75rem;
          color: #6b7280;
          margin-top: 0.25rem;
        }

        .suggestion-highlight {
          background-color: #fef3c7;
          font-weight: 600;
        }

        /* 元素分析模态框样式 */
        .analysis-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        }

        .analysis-content {
          background: white;
          border-radius: 8px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .analysis-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1.5rem;
          border-bottom: 1px solid #e5e7eb;
        }

        .analysis-header h3 {
          margin: 0;
          color: #374151;
        }

        .close-btn {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #6b7280;
        }

        .analysis-body {
          padding: 1.5rem;
        }

        .analysis-section {
          margin-bottom: 1.5rem;
        }

        .analysis-section h4 {
          margin: 0 0 0.5rem 0;
          color: #374151;
          font-size: 1.1rem;
        }

        .element-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          margin: 0.5rem 0;
        }

        .element-tag {
          background: #e5e7eb;
          color: #374151;
          padding: 0.25rem 0.75rem;
          border-radius: 4px;
          font-size: 0.875rem;
          font-weight: 500;
        }

        .element-tag.similar {
          background: #dbeafe;
          color: #1e40af;
          cursor: pointer;
          transition: background-color 0.15s;
        }

        .element-tag.similar:hover {
          background: #bfdbfe;
        }

        .group-info {
          margin: 0.5rem 0;
          padding: 0.5rem;
          background: #f9fafb;
          border-radius: 4px;
        }
        </style>

        <!-- 元素周期表组件 -->
        <div class="periodic-table-wrapper" id="periodicTableWrapper" style="display: none;">
            <div class="elements-header">
                <div class="header-left">
                    <span>Periodic Table</span>
                    <button type="button" class="btn btn-sm" id="clearElements">Clear All</button>
                </div>
                <div class="header-right">
                    <small style="color: #666; margin-right: 10px;">Click elements to add to search</small>
                    <button type="button" class="btn btn-sm" id="analyzeElements" style="margin-right: 10px; display: none;">Analyze</button>
                    <span id="selectedElementsCount">0 selected</span>
                </div>
            </div>
            <div class="periodic-table-container">
                <div class="periodic-table" id="periodicTable">
                    <!-- 第一行 -->
                    <div class="element nonmetal" data-symbol="H">
                        <span class="atomic-number">1</span>
                        H
                        <div class="tooltip">
                            <strong>Hydrogen (H)</strong><br>
                            Atomic No: 1<br>
                            Mass: 1.008<br>
                            Electron: 1s¹
                        </div>
                    </div>
                    <div style="grid-column: span 16;"></div>
                    <div class="element noble" data-symbol="He">
                        <span class="atomic-number">2</span>
                        He
                        <div class="tooltip">
                            <strong>Helium (He)</strong><br>
                            Atomic No: 2<br>
                            Mass: 4.0026<br>
                            Electron: 1s²
                        </div>
                </div>
                
                    <!-- 第二行 -->
                    <div class="element alkali" data-symbol="Li">
                        <span class="atomic-number">3</span>
                        Li
                        <div class="tooltip">
                            <strong>Lithium (Li)</strong><br>
                            Atomic No: 3<br>
                            Mass: 6.94<br>
                            Electron: [He] 2s¹
                        </div>
                    </div>
                    <div class="element alkaline" data-symbol="Be">
                        <span class="atomic-number">4</span>
                        Be
                        <div class="tooltip">
                            <strong>Beryllium (Be)</strong><br>
                            Atomic No: 4<br>
                            Mass: 9.0122<br>
                            Electron: [He] 2s²
                        </div>
                    </div>
                    <div style="grid-column: span 10;"></div>
                    <div class="element metalloid" data-symbol="B">
                        <span class="atomic-number">5</span>
                        B
                        <div class="tooltip">
                            <strong>Boron (B)</strong><br>
                            Atomic No: 5<br>
                            Mass: 10.81<br>
                            Electron: [He] 2s² 2p¹
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="C">
                        <span class="atomic-number">6</span>
                        C
                        <div class="tooltip">
                            <strong>Carbon (C)</strong><br>
                            Atomic No: 6<br>
                            Mass: 12.011<br>
                            Electron: [He] 2s² 2p²
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="N">
                        <span class="atomic-number">7</span>
                        N
                        <div class="tooltip">
                            <strong>Nitrogen (N)</strong><br>
                            Atomic No: 7<br>
                            Mass: 14.007<br>
                            Electron: [He] 2s² 2p³
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="O">
                        <span class="atomic-number">8</span>
                        O
                        <div class="tooltip">
                            <strong>Oxygen (O)</strong><br>
                            Atomic No: 8<br>
                            Mass: 15.999<br>
                            Electron: [He] 2s² 2p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="F">
                        F
                        <div class="tooltip">
                            <strong>Fluorine (F)</strong><br>
                            Atomic No: 9<br>
                            Mass: 18.998<br>
                            Electron: [He] 2s² 2p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Ne">
                        Ne
                        <div class="tooltip">
                            <strong>Neon (Ne)</strong><br>
                            Atomic No: 10<br>
                            Mass: 20.180<br>
                            Electron: [He] 2s² 2p⁶
                </div>
            </div>
            
                    <!-- 第三行 -->
                    <div class="element alkali" data-symbol="Na">
                        Na
                        <div class="tooltip">
                            <strong>Sodium (Na)</strong><br>
                            Atomic No: 11<br>
                            Mass: 22.990<br>
                            Electron: [Ne] 3s¹
                        </div>
                    </div>
                    <div class="element alkaline" data-symbol="Mg">
                        Mg
                        <div class="tooltip">
                            <strong>Magnesium (Mg)</strong><br>
                            Atomic No: 12<br>
                            Mass: 24.305<br>
                            Electron: [Ne] 3s²
                        </div>
                    </div>
                    <div class="element-spacer" style="grid-column: span 10;"></div>
                    <div class="element post-transition" data-symbol="Al">
                        Al
                        <div class="tooltip">
                            <strong>Aluminum (Al)</strong><br>
                            Atomic No: 13<br>
                            Mass: 26.982<br>
                            Electron: [Ne] 3s² 3p¹
                        </div>
                    </div>
                    <div class="element metalloid" data-symbol="Si">
                        Si
                        <div class="tooltip">
                            <strong>Silicon (Si)</strong><br>
                            Atomic No: 14<br>
                            Mass: 28.085<br>
                            Electron: [Ne] 3s² 3p²
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="P">
                        P
                        <div class="tooltip">
                            <strong>Phosphorus (P)</strong><br>
                            Atomic No: 15<br>
                            Mass: 30.974<br>
                            Electron: [Ne] 3s² 3p³
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="S">
                        S
                        <div class="tooltip">
                            <strong>Sulfur (S)</strong><br>
                            Atomic No: 16<br>
                            Mass: 32.06<br>
                            Electron: [Ne] 3s² 3p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="Cl">
                        Cl
                        <div class="tooltip">
                            <strong>Chlorine (Cl)</strong><br>
                            Atomic No: 17<br>
                            Mass: 35.45<br>
                            Electron: [Ne] 3s² 3p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Ar">
                        Ar
                        <div class="tooltip">
                            <strong>Argon (Ar)</strong><br>
                            Atomic No: 18<br>
                            Mass: 39.948<br>
                            Electron: [Ne] 3s² 3p⁶
                    </div>
                </div>
            
                    <!-- 第四行 -->
                    <div class="element alkali" data-symbol="K">
                        K
                        <div class="tooltip">
                            <strong>Potassium (K)</strong><br>
                            Atomic No: 19<br>
                            Mass: 39.098<br>
                            Electron: [Ar] 4s¹
                    </div>
                    </div>
                    <div class="element alkaline" data-symbol="Ca">
                        Ca
                        <div class="tooltip">
                            <strong>Calcium (Ca)</strong><br>
                            Atomic No: 20<br>
                            Mass: 40.078<br>
                            Electron: [Ar] 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Sc">
                        Sc
                        <div class="tooltip">
                            <strong>Scandium (Sc)</strong><br>
                            Atomic No: 21<br>
                            Mass: 44.956<br>
                            Electron: [Ar] 3d¹ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ti">
                        Ti
                        <div class="tooltip">
                            <strong>Titanium (Ti)</strong><br>
                            Atomic No: 22<br>
                            Mass: 47.867<br>
                            Electron: [Ar] 3d² 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="V">
                        V
                        <div class="tooltip">
                            <strong>Vanadium (V)</strong><br>
                            Atomic No: 23<br>
                            Mass: 50.942<br>
                            Electron: [Ar] 3d³ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Cr">
                        Cr
                        <div class="tooltip">
                            <strong>Chromium (Cr)</strong><br>
                            Atomic No: 24<br>
                            Mass: 51.996<br>
                            Electron: [Ar] 3d⁵ 4s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Mn">
                        Mn
                        <div class="tooltip">
                            <strong>Manganese (Mn)</strong><br>
                            Atomic No: 25<br>
                            Mass: 54.938<br>
                            Electron: [Ar] 3d⁵ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Fe">
                        Fe
                        <div class="tooltip">
                            <strong>Iron (Fe)</strong><br>
                            Atomic No: 26<br>
                            Mass: 55.845<br>
                            Electron: [Ar] 3d⁶ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Co">
                        Co
                        <div class="tooltip">
                            <strong>Cobalt (Co)</strong><br>
                            Atomic No: 27<br>
                            Mass: 58.933<br>
                            Electron: [Ar] 3d⁷ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ni">
                        Ni
                        <div class="tooltip">
                            <strong>Nickel (Ni)</strong><br>
                            Atomic No: 28<br>
                            Mass: 58.693<br>
                            Electron: [Ar] 3d⁸ 4s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Cu">
                        Cu
                        <div class="tooltip">
                            <strong>Copper (Cu)</strong><br>
                            Atomic No: 29<br>
                            Mass: 63.546<br>
                            Electron: [Ar] 3d¹⁰ 4s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Zn">
                        Zn
                        <div class="tooltip">
                            <strong>Zinc (Zn)</strong><br>
                            Atomic No: 30<br>
                            Mass: 65.38<br>
                            Electron: [Ar] 3d¹⁰ 4s²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Ga">
                        Ga
                        <div class="tooltip">
                            <strong>Gallium (Ga)</strong><br>
                            Atomic No: 31<br>
                            Mass: 69.723<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p¹
                        </div>
                    </div>
                    <div class="element metalloid" data-symbol="Ge">
                        Ge
                        <div class="tooltip">
                            <strong>Germanium (Ge)</strong><br>
                            Atomic No: 32<br>
                            Mass: 72.64<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p²
                        </div>
                    </div>
                    <div class="element metalloid" data-symbol="As">
                        As
                        <div class="tooltip">
                            <strong>Arsenic (As)</strong><br>
                            Atomic No: 33<br>
                            Mass: 74.922<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p³
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="Se">
                        Se
                        <div class="tooltip">
                            <strong>Selenium (Se)</strong><br>
                            Atomic No: 34<br>
                            Mass: 78.96<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="Br">
                        Br
                        <div class="tooltip">
                            <strong>Bromine (Br)</strong><br>
                            Atomic No: 35<br>
                            Mass: 79.904<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Kr">
                        Kr
                        <div class="tooltip">
                            <strong>Krypton (Kr)</strong><br>
                            Atomic No: 36<br>
                            Mass: 83.798<br>
                            Electron: [Ar] 3d¹⁰ 4s² 4p⁶
                </div>
            </div>
            
                    <!-- 第五行 -->
                    <div class="element alkali" data-symbol="Rb">
                        Rb
                        <div class="tooltip">
                            <strong>Rubidium (Rb)</strong><br>
                            Atomic No: 37<br>
                            Mass: 85.468<br>
                            Electron: [Kr] 5s¹
                        </div>
                    </div>
                    <div class="element alkaline" data-symbol="Sr">
                        Sr
                        <div class="tooltip">
                            <strong>Strontium (Sr)</strong><br>
                            Atomic No: 38<br>
                            Mass: 87.62<br>
                            Electron: [Kr] 5s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Y">
                        Y
                        <div class="tooltip">
                            <strong>Yttrium (Y)</strong><br>
                            Atomic No: 39<br>
                            Mass: 88.906<br>
                            Electron: [Kr] 4d¹ 5s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Zr">
                        Zr
                        <div class="tooltip">
                            <strong>Zirconium (Zr)</strong><br>
                            Atomic No: 40<br>
                            Mass: 91.224<br>
                            Electron: [Kr] 4d² 5s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Nb">
                        Nb
                        <div class="tooltip">
                            <strong>Niobium (Nb)</strong><br>
                            Atomic No: 41<br>
                            Mass: 92.906<br>
                            Electron: [Kr] 4d⁴ 5s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Mo">
                        Mo
                        <div class="tooltip">
                            <strong>Molybdenum (Mo)</strong><br>
                            Atomic No: 42<br>
                            Mass: 95.94<br>
                            Electron: [Kr] 4d⁵ 5s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Tc">
                        Tc
                        <div class="tooltip">
                            <strong>Technetium (Tc)</strong><br>
                            Atomic No: 43<br>
                            Mass: 98<br>
                            Electron: [Kr] 4d⁵ 5s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ru">
                        Ru
                        <div class="tooltip">
                            <strong>Ruthenium (Ru)</strong><br>
                            Atomic No: 44<br>
                            Mass: 101.07<br>
                            Electron: [Kr] 4d⁷ 5s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Rh">
                        Rh
                        <div class="tooltip">
                            <strong>Rhodium (Rh)</strong><br>
                            Atomic No: 45<br>
                            Mass: 102.91<br>
                            Electron: [Kr] 4d⁸ 5s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Pd">
                        Pd
                        <div class="tooltip">
                            <strong>Palladium (Pd)</strong><br>
                            Atomic No: 46<br>
                            Mass: 106.42<br>
                            Electron: [Kr] 4d¹⁰
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ag">
                        Ag
                        <div class="tooltip">
                            <strong>Silver (Ag)</strong><br>
                            Atomic No: 47<br>
                            Mass: 107.87<br>
                            Electron: [Kr] 4d¹⁰ 5s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Cd">
                        Cd
                        <div class="tooltip">
                            <strong>Cadmium (Cd)</strong><br>
                            Atomic No: 48<br>
                            Mass: 112.41<br>
                            Electron: [Kr] 4d¹⁰ 5s²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="In">
                        In
                        <div class="tooltip">
                            <strong>Indium (In)</strong><br>
                            Atomic No: 49<br>
                            Mass: 114.82<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p¹
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Sn">
                        Sn
                        <div class="tooltip">
                            <strong>Tin (Sn)</strong><br>
                            Atomic No: 50<br>
                            Mass: 118.71<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p²
                        </div>
                    </div>
                    <div class="element metalloid" data-symbol="Sb">
                        Sb
                        <div class="tooltip">
                            <strong>Antimony (Sb)</strong><br>
                            Atomic No: 51<br>
                            Mass: 121.76<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p³
                        </div>
                    </div>
                    <div class="element nonmetal" data-symbol="Te">
                        Te
                        <div class="tooltip">
                            <strong>Tellurium (Te)</strong><br>
                            Atomic No: 52<br>
                            Mass: 127.6<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="I">
                        I
                        <div class="tooltip">
                            <strong>Iodine (I)</strong><br>
                            Atomic No: 53<br>
                            Mass: 126.9<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Xe">
                        Xe
                        <div class="tooltip">
                            <strong>Xenon (Xe)</strong><br>
                            Atomic No: 54<br>
                            Mass: 131.29<br>
                            Electron: [Kr] 4d¹⁰ 5s² 5p⁶
                        </div>
                    </div>
                    
                    <!-- 第六行 -->
                    <div class="element alkali" data-symbol="Cs">
                        Cs
                        <div class="tooltip">
                            <strong>Cesium (Cs)</strong><br>
                            Atomic No: 55<br>
                            Mass: 132.91<br>
                            Electron: [Xe] 6s¹
                        </div>
                    </div>
                    <div class="element alkaline" data-symbol="Ba">
                        Ba
                        <div class="tooltip">
                            <strong>Barium (Ba)</strong><br>
                            Atomic No: 56<br>
                            Mass: 137.33<br>
                            Electron: [Xe] 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="La">
                        La
                        <div class="tooltip">
                            <strong>Lanthanum (La)</strong><br>
                            Atomic No: 57<br>
                            Mass: 138.91<br>
                            Electron: [Xe] 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Hf">
                        Hf
                        <div class="tooltip">
                            <strong>Hafnium (Hf)</strong><br>
                            Atomic No: 72<br>
                            Mass: 178.49<br>
                            Electron: [Xe] 4f¹⁴ 5d² 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ta">
                        Ta
                        <div class="tooltip">
                            <strong>Tantalum (Ta)</strong><br>
                            Atomic No: 73<br>
                            Mass: 180.95<br>
                            Electron: [Xe] 4f¹⁴ 5d³ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="W">
                        W
                        <div class="tooltip">
                            <strong>Tungsten (W)</strong><br>
                            Atomic No: 74<br>
                            Mass: 183.84<br>
                            Electron: [Xe] 4f¹⁴ 5d⁴ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Re">
                        Re
                        <div class="tooltip">
                            <strong>Rhenium (Re)</strong><br>
                            Atomic No: 75<br>
                            Mass: 186.21<br>
                            Electron: [Xe] 4f¹⁴ 5d⁵ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Os">
                        Os
                        <div class="tooltip">
                            <strong>Osmium (Os)</strong><br>
                            Atomic No: 76<br>
                            Mass: 190.23<br>
                            Electron: [Xe] 4f¹⁴ 5d⁶ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ir">
                        Ir
                        <div class="tooltip">
                            <strong>Iridium (Ir)</strong><br>
                            Atomic No: 77<br>
                            Mass: 192.22<br>
                            Electron: [Xe] 4f¹⁴ 5d⁷ 6s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Pt">
                        Pt
                        <div class="tooltip">
                            <strong>Platinum (Pt)</strong><br>
                            Atomic No: 78<br>
                            Mass: 195.08<br>
                            Electron: [Xe] 4f¹⁴ 5d⁹ 6s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Au">
                        Au
                        <div class="tooltip">
                            <strong>Gold (Au)</strong><br>
                            Atomic No: 79<br>
                            Mass: 196.97<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s¹
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Hg">
                        Hg
                        <div class="tooltip">
                            <strong>Mercury (Hg)</strong><br>
                            Atomic No: 80<br>
                            Mass: 200.59<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Tl">
                        Tl
                        <div class="tooltip">
                            <strong>Thallium (Tl)</strong><br>
                            Atomic No: 81<br>
                            Mass: 204.38<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p¹
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Pb">
                        Pb
                        <div class="tooltip">
                            <strong>Lead (Pb)</strong><br>
                            Atomic No: 82<br>
                            Mass: 207.2<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Bi">
                        Bi
                        <div class="tooltip">
                            <strong>Bismuth (Bi)</strong><br>
                            Atomic No: 83<br>
                            Mass: 208.98<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p³
                        </div>
                    </div>
                    <div class="element metalloid" data-symbol="Po">
                        Po
                        <div class="tooltip">
                            <strong>Polonium (Po)</strong><br>
                            Atomic No: 84<br>
                            Mass: 209<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="At">
                        At
                        <div class="tooltip">
                            <strong>Astatine (At)</strong><br>
                            Atomic No: 85<br>
                            Mass: 210<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Rn">
                        Rn
                        <div class="tooltip">
                            <strong>Radon (Rn)</strong><br>
                            Atomic No: 86<br>
                            Mass: 222<br>
                            Electron: [Xe] 4f¹⁴ 5d¹⁰ 6s² 6p⁶
                        </div>
                    </div>
                    
                    <!-- 第七行 -->
                    <div class="element alkali" data-symbol="Fr">
                        Fr
                        <div class="tooltip">
                            <strong>Francium (Fr)</strong><br>
                            Atomic No: 87<br>
                            Mass: 223<br>
                            Electron: [Rn] 7s¹
                        </div>
                    </div>
                    <div class="element alkaline" data-symbol="Ra">
                        Ra
                        <div class="tooltip">
                            <strong>Radium (Ra)</strong><br>
                            Atomic No: 88<br>
                            Mass: 226<br>
                            Electron: [Rn] 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Ac">
                        Ac
                        <div class="tooltip">
                            <strong>Actinium (Ac)</strong><br>
                            Atomic No: 89<br>
                            Mass: 227<br>
                            Electron: [Rn] 6d¹ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Rf">
                        Rf
                        <div class="tooltip">
                            <strong>Rutherfordium (Rf)</strong><br>
                            Atomic No: 104<br>
                            Mass: 267<br>
                            Electron: [Rn] 5f¹⁴ 6d² 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Db">
                        Db
                        <div class="tooltip">
                            <strong>Dubnium (Db)</strong><br>
                            Atomic No: 105<br>
                            Mass: 268<br>
                            Electron: [Rn] 5f¹⁴ 6d³ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Sg">
                        Sg
                        <div class="tooltip">
                            <strong>Seaborgium (Sg)</strong><br>
                            Atomic No: 106<br>
                            Mass: 271<br>
                            Electron: [Rn] 5f¹⁴ 6d⁴ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Bh">
                        Bh
                        <div class="tooltip">
                            <strong>Bohrium (Bh)</strong><br>
                            Atomic No: 107<br>
                            Mass: 272<br>
                            Electron: [Rn] 5f¹⁴ 6d⁵ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Hs">
                        Hs
                        <div class="tooltip">
                            <strong>Hassium (Hs)</strong><br>
                            Atomic No: 108<br>
                            Mass: 270<br>
                            Electron: [Rn] 5f¹⁴ 6d⁶ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Mt">
                        Mt
                        <div class="tooltip">
                            <strong>Meitnerium (Mt)</strong><br>
                            Atomic No: 109<br>
                            Mass: 278<br>
                            Electron: [Rn] 5f¹⁴ 6d⁷ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Ds">
                        Ds
                        <div class="tooltip">
                            <strong>Darmstadtium (Ds)</strong><br>
                            Atomic No: 110<br>
                            Mass: 281<br>
                            Electron: [Rn] 5f¹⁴ 6d⁸ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Rg">
                        Rg
                        <div class="tooltip">
                            <strong>Roentgenium (Rg)</strong><br>
                            Atomic No: 111<br>
                            Mass: 281<br>
                            Electron: [Rn] 5f¹⁴ 6d⁹ 7s²
                        </div>
                    </div>
                    <div class="element transition" data-symbol="Cn">
                        Cn
                        <div class="tooltip">
                            <strong>Copernicium (Cn)</strong><br>
                            Atomic No: 112<br>
                            Mass: 285<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Nh">
                        Nh
                        <div class="tooltip">
                            <strong>Nihonium (Nh)</strong><br>
                            Atomic No: 113<br>
                            Mass: 286<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p¹
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Fl">
                        Fl
                        <div class="tooltip">
                            <strong>Flerovium (Fl)</strong><br>
                            Atomic No: 114<br>
                            Mass: 289<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p²
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Mc">
                        Mc
                        <div class="tooltip">
                            <strong>Moscovium (Mc)</strong><br>
                            Atomic No: 115<br>
                            Mass: 289<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p³
                        </div>
                    </div>
                    <div class="element post-transition" data-symbol="Lv">
                        Lv
                        <div class="tooltip">
                            <strong>Livermorium (Lv)</strong><br>
                            Atomic No: 116<br>
                            Mass: 293<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p⁴
                        </div>
                    </div>
                    <div class="element halogen" data-symbol="Ts">
                        Ts
                        <div class="tooltip">
                            <strong>Tennessine (Ts)</strong><br>
                            Atomic No: 117<br>
                            Mass: 294<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p⁵
                        </div>
                    </div>
                    <div class="element noble" data-symbol="Og">
                        Og
                        <div class="tooltip">
                            <strong>Oganesson (Og)</strong><br>
                            Atomic No: 118<br>
                            Mass: 294<br>
                            Electron: [Rn] 5f¹⁴ 6d¹⁰ 7s² 7p⁶
                        </div>
                    </div>
                    
                    <!-- 镧系 -->
                    <div style="grid-column: span 3;"></div>
                    <div class="element lanthanoid" data-symbol="Ce">
                        Ce
                        <div class="tooltip">
                            <strong>Cerium (Ce)</strong><br>
                            Atomic No: 58<br>
                            Mass: 140.12<br>
                            Electron: [Xe] 4f¹ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Pr">
                        Pr
                        <div class="tooltip">
                            <strong>Praseodymium (Pr)</strong><br>
                            Atomic No: 59<br>
                            Mass: 140.91<br>
                            Electron: [Xe] 4f³ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Nd">
                        Nd
                        <div class="tooltip">
                            <strong>Neodymium (Nd)</strong><br>
                            Atomic No: 60<br>
                            Mass: 144.24<br>
                            Electron: [Xe] 4f⁴ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Pm">
                        Pm
                        <div class="tooltip">
                            <strong>Promethium (Pm)</strong><br>
                            Atomic No: 61<br>
                            Mass: 145<br>
                            Electron: [Xe] 4f⁵ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Sm">
                        Sm
                        <div class="tooltip">
                            <strong>Samarium (Sm)</strong><br>
                            Atomic No: 62<br>
                            Mass: 150.36<br>
                            Electron: [Xe] 4f⁶ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Eu">
                        Eu
                        <div class="tooltip">
                            <strong>Europium (Eu)</strong><br>
                            Atomic No: 63<br>
                            Mass: 151.96<br>
                            Electron: [Xe] 4f⁷ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Gd">
                        Gd
                        <div class="tooltip">
                            <strong>Gadolinium (Gd)</strong><br>
                            Atomic No: 64<br>
                            Mass: 157.25<br>
                            Electron: [Xe] 4f⁷ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Tb">
                        Tb
                        <div class="tooltip">
                            <strong>Terbium (Tb)</strong><br>
                            Atomic No: 65<br>
                            Mass: 158.93<br>
                            Electron: [Xe] 4f⁹ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Dy">
                        Dy
                        <div class="tooltip">
                            <strong>Dysprosium (Dy)</strong><br>
                            Atomic No: 66<br>
                            Mass: 162.50<br>
                            Electron: [Xe] 4f¹⁰ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Ho">
                        Ho
                        <div class="tooltip">
                            <strong>Holmium (Ho)</strong><br>
                            Atomic No: 67<br>
                            Mass: 164.93<br>
                            Electron: [Xe] 4f¹¹ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Er">
                        Er
                        <div class="tooltip">
                            <strong>Erbium (Er)</strong><br>
                            Atomic No: 68<br>
                            Mass: 167.26<br>
                            Electron: [Xe] 4f¹² 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Tm">
                        Tm
                        <div class="tooltip">
                            <strong>Thulium (Tm)</strong><br>
                            Atomic No: 69<br>
                            Mass: 168.93<br>
                            Electron: [Xe] 4f¹³ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Yb">
                        Yb
                        <div class="tooltip">
                            <strong>Ytterbium (Yb)</strong><br>
                            Atomic No: 70<br>
                            Mass: 173.04<br>
                            Electron: [Xe] 4f¹⁴ 5d¹ 6s²
                        </div>
                    </div>
                    <div class="element lanthanoid" data-symbol="Lu">
                        Lu
                        <div class="tooltip">
                            <strong>Lutetium (Lu)</strong><br>
                            Atomic No: 71<br>
                            Mass: 174.97<br>
                            Electron: [Xe] 4f¹⁴ 5d¹ 6s²
                        </div>
                    </div>
                    
                    <!-- 锕系 -->
                    <div style="grid-column: span 3;"></div>
                    <div class="element actinoid" data-symbol="Th">
                        Th
                        <div class="tooltip">
                            <strong>Thorium (Th)</strong><br>
                            Atomic No: 90<br>
                            Mass: 232.04<br>
                            Electron: [Rn] 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Pa">
                        Pa
                        <div class="tooltip">
                            <strong>Protactinium (Pa)</strong><br>
                            Atomic No: 91<br>
                            Mass: 231.04<br>
                            Electron: [Rn] 5f² 6d¹ 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="U">
                        U
                        <div class="tooltip">
                            <strong>Uranium (U)</strong><br>
                            Atomic No: 92<br>
                            Mass: 238.03<br>
                            Electron: [Rn] 5f³ 6d¹ 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Np">
                        Np
                        <div class="tooltip">
                            <strong>Neptunium (Np)</strong><br>
                            Atomic No: 93<br>
                            Mass: 237<br>
                            Electron: [Rn] 5f⁴ 6d¹ 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Pu">
                        Pu
                        <div class="tooltip">
                            <strong>Plutonium (Pu)</strong><br>
                            Atomic No: 94<br>
                            Mass: 244<br>
                            Electron: [Rn] 5f⁶ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Am">
                        Am
                        <div class="tooltip">
                            <strong>Americium (Am)</strong><br>
                            Atomic No: 95<br>
                            Mass: 243<br>
                            Electron: [Rn] 5f⁷ 6d³ 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Cm">
                        Cm
                        <div class="tooltip">
                            <strong>Curium (Cm)</strong><br>
                            Atomic No: 96<br>
                            Mass: 247<br>
                            Electron: [Rn] 5f⁷ 6d⁴ 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Bk">
                        Bk
                        <div class="tooltip">
                            <strong>Berkelium (Bk)</strong><br>
                            Atomic No: 97<br>
                            Mass: 247<br>
                            Electron: [Rn] 5f⁸ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Cf">
                        Cf
                        <div class="tooltip">
                            <strong>Californium (Cf)</strong><br>
                            Atomic No: 98<br>
                            Mass: 251<br>
                            Electron: [Rn] 5f¹⁰ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Es">
                        Es
                        <div class="tooltip">
                            <strong>Einsteinium (Es)</strong><br>
                            Atomic No: 99<br>
                            Mass: 252<br>
                            Electron: [Rn] 5f¹² 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Fm">
                        Fm
                        <div class="tooltip">
                            <strong>Fermium (Fm)</strong><br>
                            Atomic No: 100<br>
                            Mass: 257<br>
                            Electron: [Rn] 5f¹⁴ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Md">
                        Md
                        <div class="tooltip">
                            <strong>Mendelevium (Md)</strong><br>
                            Atomic No: 101<br>
                            Mass: 258<br>
                            Electron: [Rn] 5f¹⁶ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="No">
                        No
                        <div class="tooltip">
                            <strong>Nobelium (No)</strong><br>
                            Atomic No: 102<br>
                            Mass: 259<br>
                            Electron: [Rn] 5f¹⁸ 6d² 7s²
                        </div>
                    </div>
                    <div class="element actinoid" data-symbol="Lr">
                        Lr
                        <div class="tooltip">
                            <strong>Lawrencium (Lr)</strong><br>
                            Atomic No: 103<br>
                            Mass: 262<br>
                            Electron: [Rn] 5f¹⁴ 6d² 7s²
                        </div>
                    </div>
                </div>
                
                <!-- 隐藏的元素输入字段 -->
                <input type="hidden" name="elements" id="selectedElements" value="{{ search_params.elements }}">
                
                <!-- Element legend is now directly after the hidden input -->
                <div class="element-legend">
                    <div class="legend-item">
                        <div class="legend-color alkali"></div>
                        <span>Alkali Metals</span>
                </div>
                    <div class="legend-item">
                        <div class="legend-color alkaline"></div>
                        <span>Alkaline Earth Metals</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color transition"></div>
                        <span>Transition Metals</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color post-transition"></div>
                        <span>Post-transition Metals</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color metalloid"></div>
                        <span>Metalloids</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color nonmetal"></div>
                        <span>Nonmetals</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color halogen"></div>
                        <span>Halogens</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color noble"></div>
                        <span>Noble Gases</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color lanthanoid"></div>
                        <span>Lanthanides</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color actinoid"></div>
                        <span>Actinides</span>
                    </div>
                </div>
            </div>
        </div>
        <style>
        /* 元素周期表组件样式 */
        .periodic-table-wrapper {
            margin-top: 1rem;
            border: 1px solid #D9E2F0;
            border-radius: 6px;
            background-color: #fff;
            /* Removing overflow: hidden to allow tooltips to extend beyond the wrapper */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .elements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.2rem;
            background-color: #f1f5f9;
            border-bottom: 1px solid #D9E2F0;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .elements-header span:first-child {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.05rem;
        }
        
        .elements-header #clearElements {
            font-size: 0.8rem;
            padding: 0.25rem 0.7rem;
            background-color: rgba(0, 71, 171, 0.08);
            color: var(--primary-color);
            border: 1px solid rgba(0, 71, 171, 0.15);
            border-radius: 4px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .elements-header #clearElements:hover {
            background-color: rgba(0, 71, 171, 0.15);
            transform: translateY(-1px);
        }
        
        .elements-header #clearElements:active {
            background-color: rgba(0, 71, 171, 0.25);
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .elements-header span#selectedElementsCount {
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .periodic-table-container {
            padding: 1.2rem;
            /* Removing max-height and overflow-y to show all content without scrollbar */
            /* max-height: 450px; */
            /* overflow-y: auto; */
            position: relative;
        }
        
        .periodic-table {
            display: grid;
            grid-template-columns: repeat(18, minmax(40px, 1fr));
            gap: 4px;
            width: 100%;
        }
        
        .element {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1/1;
            border: 1px solid rgba(0,0,0,0.06);
            position: relative;
        }
        
        /* Add atomic number style */
        .atomic-number {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 0.7rem;
            font-weight: normal;
            opacity: 0.7;
        }
        
        .element:hover {
            transform: scale(1.08);
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        .element.selected {
            box-shadow: 0 0 0 2px var(--primary-color);
            color: white;
            background-color: var(--primary-color);
            transform: scale(1.05);
            animation: elementSelected 0.3s ease-out;
        }

        @keyframes elementSelected {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.05); }
        }
        
        .element-controls {
            display: none; /* Hide the old controls since we moved the button */
        }
        
        /* Override the original button styles with hiding */
        #clearElements:not(.elements-header #clearElements) {
            display: none;
        }
        
        /* Element tooltip styles */
        .element .tooltip {
            visibility: hidden;
            position: absolute;
            top: 110%; /* Position below element */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px 14px;
            white-space: nowrap;
            font-size: 0.75rem;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 1000; /* Highest z-index to ensure visibility */
            pointer-events: none;
            width: max-content;
            max-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        
        .element .tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%; /* Arrow at top of tooltip */
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.9) transparent;
        }
        
        .element:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(2px); /* Slight movement for better UX */
        }
        
        .element .tooltip strong {
            color: #6ee7ff; /* Highlight element name */
            font-size: 0.85rem;
        }
        
        /* Element legend styles */
        .element-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 0;
            border-top: 1px solid #edf2f7;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        </style>

        <!-- 周期表样式 -->
        <style>
        /* 元素类型颜色 */
        .alkali {
          background-color: #ffcdd2;
        }

        .alkaline {
          background-color: #f8bbd0;
        }

        .transition {
          background-color: #bbdefb;
        }

        .post-transition {
          background-color: #b2dfdb;
        }

        .metalloid {
          background-color: #c8e6c9;
        }

        .nonmetal {
          background-color: #dcedc8;
        }

        .halogen {
          background-color: #f0f4c3;
        }

        .noble {
          background-color: #d1c4e9;
        }

        .lanthanoid {
          background-color: #ffe0b2;
        }

        .actinoid {
          background-color: #ffccbc;
        }
        </style>

        <!-- 高级搜索 -->
        <div class="advanced-search" id="advancedSearch" style="display: none;">
            <div class="search-group">
                <!-- 第一行: 材料类型和带隙选择 -->
                <div class="search-row">
                    <!-- 材料类型下拉框 -->
                    <div class="filter-group">
                        <label for="materials_type">Materials Type</label>
                        <select name="materials_type" id="materials_type">
                            <option value="">All</option>
                            <option value="unknown" {% if search_params.materials_type == 'unknown' %}selected{% endif %}>Unknown</option>
                            <option value="metal" {% if search_params.materials_type == 'metal' %}selected{% endif %}>Metal</option>
                            <option value="semimetal" {% if search_params.materials_type == 'semimetal' %}selected{% endif %}>Semimetal</option>
                            <option value="semiconductor" {% if search_params.materials_type == 'semiconductor' %}selected{% endif %}>Semiconductor</option>
                            <option value="insulator" {% if search_params.materials_type == 'insulator' %}selected{% endif %}>Insulator</option>
                        </select>
                    </div>

                    <!-- 带隙范围 -->
                    <div class="filter-group">
                        <label for="band_gap_min">Band Gap (eV)</label>
                        <div class="range-inputs">
                            <input type="number" name="band_gap_min" id="band_gap_min"
                                   placeholder="Min" step="0.01"
                                   value="{{ search_params.band_gap_min }}">
                            <span>to</span>
                            <input type="number" name="band_gap_max" id="band_gap_max"
                                   placeholder="Max" step="0.01"
                                   value="{{ search_params.band_gap_max }}">
                        </div>
                    </div>
                </div>

                <!-- 第二行: 形成能和费米能级范围选择 -->
                <div class="search-row">
                    <!-- Max Shift Current范围 -->
                    <div class="filter-group">
                        <label for="max_sc_min">Max Shift Current (μA/V²)</label>
                        <div class="range-inputs">
                            <input type="number" name="max_sc_min" id="max_sc_min"
                                   placeholder="Min" step="0.01"
                                   value="{{ search_params.max_sc_min }}">
                            <span>to</span>
                            <input type="number" name="max_sc_max" id="max_sc_max"
                                   placeholder="Max" step="0.01"
                                   value="{{ search_params.max_sc_max }}">
                        </div>
                    </div>

                    <!-- 费米能级范围 -->
                    <div class="filter-group">
                        <label for="fermi_level_min">Fermi Level (eV)</label>
                        <div class="range-inputs">
                            <input type="number" name="fermi_level_min" id="fermi_level_min" 
                                   placeholder="Min" step="0.01" 
                                   value="{{ search_params.fermi_level_min }}">
                            <span>to</span>
                            <input type="number" name="fermi_level_max" id="fermi_level_max" 
                                   placeholder="Max" step="0.01" 
                                   value="{{ search_params.fermi_level_max }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style>
        /* 高级搜索样式 */
        .advanced-search {
            display: none;  /* 默认隐藏 */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #edf2f7;
        }

        .advanced-search.show {
            display: block;
        }

        .search-row {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        /* 保证当一行有两个搜索组时能够均分宽度 */
        .search-row .search-group {
            flex: 1;
        }

        .search-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .search-actions button,
        .search-actions .clear-btn button {
            padding: 0.5rem 1.25rem;
            font-size: 0.95rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .search-actions .search-btn {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-actions .search-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .search-actions .clear-btn {
            text-decoration: none;
        }

        .search-actions .clear-btn button {
            background-color: #f5f5f5;
            color: #555;
            border: 1px solid #e0e0e0;
        }

        .search-actions .clear-btn button:hover {
            background-color: #e8e8e8;
            transform: translateY(-1px);
        }

        /* 范围输入框的样式 */
        .range-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .range-inputs input {
            flex: 1;
        }
        
        .range-inputs span {
            color: #666;
            font-weight: 500;
        }
        </style>
        
        <!-- 搜索验证提示 -->
        <div id="searchAlert" class="search-alert" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>Please enter search criteria or select at least one filter before searching.</span>
        </div>
        <style>
        /* 搜索验证提示样式 */
        .search-alert {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1rem auto;
            padding: 0.85rem 1.2rem;
            background-color: #fff4e5;
            border-left: 4px solid #ff9800;
            color: #663c00;
            border-radius: 4px;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease-in-out;
            max-width: 90%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .search-alert i {
            color: #ff9800;
            font-size: 1.2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        </style>
    </form>

    <!-- 搜索结果信息 -->
    <div class="search-info">
        {% if search_params|any %}
            <div class="search-summary">
                Searching with filters:
            </div>
            <div class="active-filters">
                {% for key, value in search_params.items() %}
                    {% if value %}
                        <span class="filter-tag">
                            <span class="filter-key">{{ key|title }}</span>
                            <span class="filter-value">{{ value }}</span>
                            <a href="{{ url_for('views.index', **(search_params|remove_key(key))) }}" class="remove-filter" title="Remove this filter">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('views.index') }}" class="clear-all-filters">Clear All</a>
            </div>
        {% endif %}
    </div>
    <style>
    /* 搜索筛选标签样式 */
    .search-info {
        margin: 1.5rem 0 0.5rem;
    }
    
    .search-summary {
        font-size: 0.95rem;
        color: #64748b;
        margin-bottom: 0.75rem;
        font-weight: 500;
    }
    
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    .filter-tag {
        display: flex;
        align-items: center;
        background-color: var(--light-bg);
        border: 1px solid #D9E2F0;
        border-radius: 6px;
        padding: 0;
        font-size: 0.9rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        transition: all 0.2s;
    }
    
    .filter-tag:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }
    
    .filter-key {
        background-color: rgba(0, 71, 171, 0.08);
        color: var(--primary-color);
        padding: 6px 10px;
        font-weight: 600;
        border-right: 1px solid #D9E2F0;
    }
    
    .filter-value {
        padding: 6px 10px;
        color: #333;
    }

    .remove-filter {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
        color: #64748b;
        text-decoration: none;
        background-color: transparent;
        transition: all 0.2s;
        border-left: 1px solid #D9E2F0;
    }
    
    .remove-filter:hover {
        background-color: #ffebee;
        color: #e53935;
    }
    
    .clear-all-filters {
        color: var(--primary-color);
        font-size: 0.9rem;
        text-decoration: none;
        padding: 6px 12px;
        background-color: rgba(0, 71, 171, 0.08);
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .clear-all-filters:hover {
        background-color: rgba(0, 71, 171, 0.15);
        text-decoration: underline;
    }
    </style>

    <!-- 表格标题 -->
    <div class="table-title">
        <span class="title2">Total {{ materials|length }} Materials This Page</span>
    </div>
    <style>
    /* 表格相关样式 */
    .table-title {
      display: flex;
      align-items: center;
      margin: 1.8rem 0 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .title2 {
      color: var(--primary-color);
      font-weight: 600;
      font-size: 1.15rem;
      position: relative;
      padding-left: 1rem;
    }
    
    .title2::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 1.1em;
      background-color: var(--primary-color);
      border-radius: 2px;
    }
    </style>

    <!-- 表格 -->
    <table class="material-data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>MP-ID</th>
                <th>Material Name</th>
                <th>Space Group</th>
                <th>Fermi Level (eV)</th>
                <th>Band Gap (eV)</th>
                <th>Max SC (μA/V²)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td>{{ material.formatted_id }}</td>
                <td>{{ material.mp_id if material.mp_id else 'Unknown' }}</td>
                <td>
                    <a href="{{ url_for('views.detail', material_id=material.id) }}" class="material-link">
                        {{ material.name }}
                    </a>
                </td>
                <td>{{ material.sg_name if material.sg_name else 'Unknown' }} ({{ material.sg_num if material.sg_num else 'N/A' }})</td>
                <td>{{ material.fermi_level if material.fermi_level is not none else 'N/A' }}</td>
                <td class="band-gap-cell" data-material-id="{{ material.id }}">
                    {% if material.band_gap is not none %}
                        {{ "%.4f"|format(material.band_gap) }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td class="max-sc-cell" data-material-id="{{ material.id }}">
                    {% if material.max_sc is not none %}
                        {{ "%.4f"|format(material.max_sc) }}
                    {% else %}
                        Loading...
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a class="mp" 
                           href="https://next-gen.materialsproject.org/materials?formula={{ material.name }}" 
                           target="_blank"
                           title="View in MP">
                           MP
                        </a>
                        {% if current_user.is_authenticated and current_user.is_admin() %}
                        <a class="btn" 
                           href="{{ url_for('views.edit', material_id=material.id) }}">
                           Edit
                        </a>
                        <form method="post" 
                              action="{{ url_for('views.delete', material_id=material.id) }}">
                            <button class="btn" 
                                    type="submit" 
                                    onclick="return confirm('Delete permanently?')">Del</button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <style>
    /* 表格样式 */
    .material-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 2rem 0;
    }

    .material-data-table th {
        background-color: #f1f5f9;
        color: #333333;
        padding: 1rem;
        text-align: left;
        font-weight: 700;
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .material-data-table td {
        padding: 1rem;
        border-bottom: 1px solid #edf2f7;
    }

    .material-data-table tr:hover {
        background-color: var(--light-bg);
    }

    /* 表格左对齐 */
    .material-data-table th,
    .material-data-table td {
        text-align: left;
        vertical-align: middle;
        padding: 16px 12px;  /* 增加上下内边距以增大行距 */
    }
    
    /* 只让操作按钮居中对齐 */
    .material-data-table td:last-child {
        text-align: center;
    }

    .material-data-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;  /* 偶数行使用浅灰色背景 */
    }

    .material-data-table tbody tr:nth-child(odd) {
        background-color: #ffffff;  /* 奇数行使用白色背景 */
    }

    .material-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .material-link:hover {
        color: var(--secondary-color);
    }

    /* 操作按钮样式 */
    .action-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
    }

    /* 表单内联布局 */
    .action-buttons form {
        display: inline-block;
        margin: 0;
    }
    
    /* 统一操作按钮样式 */
    .action-buttons .btn,
    .action-buttons form .btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 4px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-weight: 500;
        display: inline-block;
        line-height: 1;
    }
    
    .action-buttons .btn:hover,
    .action-buttons form .btn:hover {
        background-color: var(--secondary-color);
        transform: translateY(-1px);
    }
    
    .action-buttons .mp {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 4px;
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-weight: 600;
        display: inline-block;
        line-height: 1;
    }
    
    .action-buttons .mp:hover {
        background-color: #e0e0e0;
        transform: translateY(-1px);
    }
    </style>

    <!-- 分页导航 -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
		    <a href="{{ url_for('views.index', page=pagination.prev_num, **search_params) }}">« Previous</a>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
			    <a href="{{ url_for('views.index', page=page_num, **search_params) }}" 
                   class="{% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span class="ellipsis">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
		    <a href="{{ url_for('views.index', page=pagination.next_num, **search_params) }}">Next »</a>
        {% endif %}
    </div>
    {% endif %}
    <style>
    /* 修改分页按钮样式 */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination a {
        padding: 0.3rem 1rem;  /* 减小上下内边距，增加左右内边距 */
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-color);
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
        font-weight: 500;
        border: 1px solid #e2e8f0;
        font-size: 0.9rem;
    }

    .pagination a:hover {
        background-color: #f8fafc;
        color: var(--primary-color);
        border-color: var(--primary-color);
        transform: translateY(-1px);
    }

    .pagination .active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    </style>
</div>

<!-- Root CSS Variables -->
<style>
    :root {
        --primary-color: #0047AB;        /* 钴蓝色 - 主色调 */
        --secondary-color: #1E5CB3;      /* 稍微浅一些的蓝色 */
        --accent-color: #007FFF;         /* 天蓝色 - 强调色 */
        --text-color: #333333;           /* 深灰色文本 */
        --light-bg: #F5F8FF;             /* 非常浅的蓝色背景 */
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
    }
</style>

<!-- JavaScript代码 -->
<script>
function toggleAdvanced() {
    const advancedSearch = document.getElementById('advancedSearch');
    if (advancedSearch.style.display === 'none' || !advancedSearch.style.display) {
        advancedSearch.style.display = 'block';
    } else {
        advancedSearch.style.display = 'none';
    }
}

function toggleElements() {
    const periodicTable = document.getElementById('periodicTableWrapper');
    if (periodicTable.style.display === 'none' || !periodicTable.style.display) {
        periodicTable.style.display = 'block';
    } else {
        periodicTable.style.display = 'none';
    }
}

// 实时搜索建议功能
class SearchSuggestions {
    constructor() {
        this.searchInput = document.getElementById('searchInput');
        this.suggestionsContainer = document.getElementById('searchSuggestions');
        this.currentSuggestions = [];
        this.selectedIndex = -1;
        this.debounceTimer = null;
        this.isVisible = false;

        this.init();
    }

    init() {
        // 绑定事件监听器
        this.searchInput.addEventListener('input', (e) => this.handleInput(e));
        this.searchInput.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.searchInput.addEventListener('focus', (e) => this.handleFocus(e));

        // 点击外部隐藏建议
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-container')) {
                this.hideSuggestions();
            }
        });
    }

    handleInput(e) {
        const query = e.target.value.trim();

        // 清除之前的定时器
        if (this.debounceTimer) {
            clearTimeout(this.debounceTimer);
        }

        // 防抖处理：300ms后执行搜索
        this.debounceTimer = setTimeout(() => {
            if (query.length >= 2) {
                this.fetchSuggestions(query);
            } else {
                this.hideSuggestions();
            }
        }, 300);
    }

    handleKeydown(e) {
        if (!this.isVisible || this.currentSuggestions.length === 0) {
            return;
        }

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, this.currentSuggestions.length - 1);
                this.updateHighlight();
                break;

            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                this.updateHighlight();
                break;

            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0) {
                    this.selectSuggestion(this.currentSuggestions[this.selectedIndex]);
                }
                break;

            case 'Escape':
                this.hideSuggestions();
                break;
        }
    }

    handleFocus(e) {
        const query = e.target.value.trim();
        if (query.length >= 2 && this.currentSuggestions.length > 0) {
            this.showSuggestions();
        }
    }

    async fetchSuggestions(query) {
        try {
            const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=8`);
            const data = await response.json();

            if (data.suggestions && data.suggestions.length > 0) {
                this.currentSuggestions = data.suggestions;
                this.renderSuggestions(query);
                this.showSuggestions();
            } else {
                this.hideSuggestions();
            }
        } catch (error) {
            console.error('Failed to fetch search suggestions:', error);
            this.hideSuggestions();
        }
    }

    renderSuggestions(query) {
        const html = this.currentSuggestions.map((suggestion, index) => {
            const highlightedLabel = this.highlightMatch(suggestion.label, query);
            return `
                <div class="suggestion-item" data-index="${index}">
                    <div class="suggestion-label">${highlightedLabel}</div>
                    <div class="suggestion-category">${suggestion.category}</div>
                </div>
            `;
        }).join('');

        this.suggestionsContainer.innerHTML = html;

        // 绑定点击事件
        this.suggestionsContainer.querySelectorAll('.suggestion-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                this.selectSuggestion(this.currentSuggestions[index]);
            });
        });
    }

    highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="suggestion-highlight">$1</span>');
    }

    updateHighlight() {
        this.suggestionsContainer.querySelectorAll('.suggestion-item').forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('highlighted');
            } else {
                item.classList.remove('highlighted');
            }
        });
    }

    selectSuggestion(suggestion) {
        this.searchInput.value = suggestion.value;
        this.hideSuggestions();

        // 触发搜索表单提交
        const form = this.searchInput.closest('form');
        if (form) {
            form.submit();
        }
    }

    showSuggestions() {
        this.suggestionsContainer.style.display = 'block';
        this.isVisible = true;
        this.selectedIndex = -1;
    }

    hideSuggestions() {
        this.suggestionsContainer.style.display = 'none';
        this.isVisible = false;
        this.selectedIndex = -1;
    }
}

// 搜索清除功能
function initClearSearchFunction() {
    const clearBtn = document.getElementById('clearSearchBtn');
    const searchInput = document.getElementById('searchInput');
    const searchForm = document.getElementById('searchForm');

    clearBtn.addEventListener('click', function() {
        // 清除基本搜索输入
        searchInput.value = '';

        // 清除所有高级搜索字段
        const advancedInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
        advancedInputs.forEach(input => {
            if (input.type === 'text' || input.type === 'number') {
                input.value = '';
            } else if (input.type === 'select-one') {
                input.selectedIndex = 0; // 选择第一个选项（通常是"All"）
            }
        });

        // 清除元素选择
        const selectedElements = document.querySelectorAll('.element.selected');
        selectedElements.forEach(element => {
            element.classList.remove('selected');
        });

        // 清除隐藏的元素输入字段
        const selectedElementsInput = document.getElementById('selectedElements');
        if (selectedElementsInput) {
            selectedElementsInput.value = '';
        }

        // 更新元素计数显示
        const selectedElementsCount = document.getElementById('selectedElementsCount');
        if (selectedElementsCount) {
            selectedElementsCount.textContent = '0 selected';
        }

        // 隐藏分析按钮
        const analyzeElementsBtn = document.getElementById('analyzeElements');
        if (analyzeElementsBtn) {
            analyzeElementsBtn.style.display = 'none';
        }

        // 隐藏搜索建议
        const searchSuggestions = document.getElementById('searchSuggestions');
        if (searchSuggestions) {
            searchSuggestions.style.display = 'none';
        }

        // 提供用户反馈
        const originalText = clearBtn.textContent;
        clearBtn.textContent = 'Cleared!';
        clearBtn.style.backgroundColor = '#10b981';
        clearBtn.style.color = 'white';
        clearBtn.style.borderColor = '#10b981';

        setTimeout(() => {
            clearBtn.textContent = originalText;
            clearBtn.style.backgroundColor = '';
            clearBtn.style.color = '';
            clearBtn.style.borderColor = '';
        }, 1000);

        // 聚焦到搜索输入框
        searchInput.focus();
    });
}

// 元素周期表功能
document.addEventListener('DOMContentLoaded', function() {
    // 初始化搜索建议功能
    new SearchSuggestions();

    // 初始化清除搜索功能
    initClearSearchFunction();
    // 周期表切换按钮
    const elementsToggleBtn = document.getElementById('elementsToggleBtn');
    const periodicTableWrapper = document.getElementById('periodicTableWrapper');
    const selectedElementsInput = document.getElementById('selectedElements');
    const selectedElementsCount = document.getElementById('selectedElementsCount');
    const clearElementsBtn = document.getElementById('clearElements');
    const analyzeElementsBtn = document.getElementById('analyzeElements');
    const elements = document.querySelectorAll('.element');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    
    // 为所有元素添加原子序数标签
    elements.forEach(element => {
        const tooltipText = element.querySelector('.tooltip').textContent;
        const atomicNoMatch = tooltipText.match(/Atomic No: (\d+)/);
        if (atomicNoMatch && atomicNoMatch[1]) {
            const atomicNo = atomicNoMatch[1];
            // 检查是否已有原子序数标签
            if (!element.querySelector('.atomic-number')) {
                const atomicNumberSpan = document.createElement('span');
                atomicNumberSpan.className = 'atomic-number';
                atomicNumberSpan.textContent = atomicNo;
                element.insertBefore(atomicNumberSpan, element.firstChild);
            }
        }
    });
    
    // 处理元素的悬浮工具提示位置
    elements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const tooltip = this.querySelector('.tooltip');
            if (!tooltip) return;
            
            // 基于视窗调整tooltip位置
            const rect = this.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 重置位置样式
            tooltip.style.top = '110%';
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translateX(-50%) translateY(2px)';
            tooltip.style.bottom = 'auto';
            tooltip.style.right = 'auto';
            
            // 创建元素后延迟检查位置
            setTimeout(() => {
                const updatedRect = tooltip.getBoundingClientRect();
                
                // 处理水平溢出
                if (updatedRect.right > viewportWidth) {
                    tooltip.style.left = 'auto';
                    tooltip.style.right = '0';
                    tooltip.style.transform = 'translateY(2px)';
                } else if (updatedRect.left < 0) {
                    tooltip.style.left = '0';
                    tooltip.style.transform = 'translateY(2px)';
                }
                
                // 处理垂直溢出
                if (updatedRect.bottom > viewportHeight) {
                    tooltip.style.top = 'auto';
                    tooltip.style.bottom = '110%';
                    
                    // 调整箭头位置为底部
                    const arrow = tooltip.querySelector('::after');
                    if (arrow) {
                        arrow.style.top = '100%';
                        arrow.style.bottom = 'auto';
                        arrow.style.borderColor = 'rgba(0, 0, 0, 0.9) transparent transparent transparent';
                    }
                }
            }, 0);
        });
    });
    
    // 添加切换按钮点击事件
    elementsToggleBtn.addEventListener('click', toggleElements);

    // 监听搜索框输入变化，自动同步元素选择状态
    searchInput.addEventListener('input', function() {
        syncElementsFromSearchInput();
    });
    
    // 初始化已选中的元素
    let selectedElements = [];
    if (selectedElementsInput.value) {
        selectedElements = selectedElementsInput.value.split(',').filter(el => el.trim());
        updateSelectedCount();

        // 标记已选中的元素
        elements.forEach(el => {
            if (selectedElements.includes(el.dataset.symbol)) {
                el.classList.add('selected');
            }
        });
    }

    // 初始化时同步搜索框和元素选择状态
    if (searchInput.value.trim()) {
        syncElementsFromSearchInput();
    }
    
    // 元素点击事件
    elements.forEach(element => {
        element.addEventListener('click', function() {
            const symbol = this.dataset.symbol;
            
            // 切换元素选择状态
            if (this.classList.contains('selected')) {
                // 如果已选中，则取消选择
                this.classList.remove('selected');
                selectedElements = selectedElements.filter(el => el !== symbol);
            } else {
                // 如果未选中，则选中
                this.classList.add('selected');
                selectedElements.push(symbol);
            }
            
            // 更新选中元素计数和隐藏字段
            updateSelectedCount();

            // 智能更新搜索输入框：只有当搜索框为空或只包含元素符号时才自动更新
            updateSearchInputWithElements();

            // 不再自动隐藏周期表和提交表单
        });
    });
    
    // 清除所有选中的元素
    clearElementsBtn.addEventListener('click', function() {
        selectedElements = [];
        elements.forEach(el => el.classList.remove('selected'));
        updateSelectedCount();
        // 清除搜索框中的元素内容
        updateSearchInputWithElements();

        // 提供用户反馈
        const originalText = clearElementsBtn.textContent;
        clearElementsBtn.textContent = 'Cleared!';
        clearElementsBtn.style.backgroundColor = '#28a745';

        setTimeout(() => {
            clearElementsBtn.textContent = originalText;
            clearElementsBtn.style.backgroundColor = '';
        }, 1000);
    });

    // 更新选中元素计数
    function updateSelectedCount() {
        selectedElementsCount.textContent = `${selectedElements.length} selected`;
        selectedElementsInput.value = selectedElements.join(',');

        // 显示或隐藏分析按钮
        if (selectedElements.length > 0) {
            analyzeElementsBtn.style.display = 'inline-block';
        } else {
            analyzeElementsBtn.style.display = 'none';
        }
    }

    // 元素分析功能
    analyzeElementsBtn.addEventListener('click', async function() {
        if (selectedElements.length === 0) return;

        try {
            const response = await fetch(`/api/search/element-analysis?elements=${selectedElements.join(',')}`);
            const data = await response.json();

            if (data.error) {
                alert('Analysis failed: ' + data.error);
                return;
            }

            // 显示分析结果
            showElementAnalysis(data);

        } catch (error) {
            console.error('Element analysis failed:', error);
            alert('Failed to analyze elements. Please try again.');
        }
    });

    // 显示元素分析结果
    function showElementAnalysis(data) {
        const modal = document.createElement('div');
        modal.className = 'analysis-modal';
        modal.innerHTML = `
            <div class="analysis-content">
                <div class="analysis-header">
                    <h3>Element Analysis Results</h3>
                    <button class="close-btn" onclick="this.closest('.analysis-modal').remove()">&times;</button>
                </div>
                <div class="analysis-body">
                    <div class="analysis-section">
                        <h4>Selected Elements (${data.selected_elements.length})</h4>
                        <div class="element-tags">
                            ${data.selected_elements.map(el => `<span class="element-tag">${el}</span>`).join('')}
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h4>Material Count</h4>
                        <p>Found <strong>${data.material_count}</strong> materials containing these elements</p>
                    </div>

                    ${data.similar_elements.length > 0 ? `
                    <div class="analysis-section">
                        <h4>Similar Elements</h4>
                        <div class="element-tags">
                            ${data.similar_elements.map(el => `<span class="element-tag similar" onclick="addSimilarElement('${el}')">${el}</span>`).join('')}
                        </div>
                        <small>Click to add to selection</small>
                    </div>
                    ` : ''}

                    ${Object.keys(data.element_groups).length > 0 ? `
                    <div class="analysis-section">
                        <h4>Element Groups</h4>
                        ${Object.entries(data.element_groups).map(([group, elements]) => `
                            <div class="group-info">
                                <strong>${group.replace('_', ' ').toUpperCase()}:</strong>
                                <span>${elements.join(', ')}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="analysis-section">
                        <h4>Analysis Summary</h4>
                        <ul>
                            <li>Total elements selected: ${data.analysis.total_elements}</li>
                            <li>Contains metals: ${data.analysis.has_metals ? 'Yes' : 'No'}</li>
                            <li>Contains non-metals: ${data.analysis.has_nonmetals ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // 智能更新搜索输入框
    function updateSearchInputWithElements() {
        const currentValue = searchInput.value.trim();

        // 检查当前搜索框内容是否只包含元素符号（用空格分隔）
        const isElementsOnly = currentValue === '' ||
            currentValue.split(/\s+/).every(term =>
                term.length <= 3 && /^[A-Z][a-z]?$/.test(term)
            );

        // 如果搜索框为空或只包含元素符号，则自动更新
        if (isElementsOnly) {
            if (selectedElements.length > 0) {
                searchInput.value = selectedElements.join(' ');
            } else {
                searchInput.value = '';
            }
        }

        // 如果用户输入了其他内容，不覆盖，但在末尾添加元素
        else if (selectedElements.length > 0) {
            // 移除现有的元素符号，保留其他搜索词
            const nonElementTerms = currentValue.split(/\s+/).filter(term =>
                !(term.length <= 3 && /^[A-Z][a-z]?$/.test(term))
            );

            // 组合非元素词汇和选中的元素
            const combinedTerms = [...nonElementTerms, ...selectedElements];
            searchInput.value = combinedTerms.join(' ');
        }
    }

    // 从搜索框内容同步元素选择状态
    function syncElementsFromSearchInput() {
        const searchValue = searchInput.value.trim();
        if (!searchValue) {
            // 如果搜索框为空，清除所有选择
            selectedElements = [];
            elements.forEach(el => el.classList.remove('selected'));
            updateSelectedCount();
            return;
        }

        // 提取搜索框中的元素符号
        const terms = searchValue.split(/\s+/);
        const elementsInSearch = terms.filter(term =>
            term.length <= 3 && /^[A-Z][a-z]?$/.test(term)
        );

        // 更新选中状态
        elements.forEach(el => {
            const symbol = el.dataset.symbol;
            if (elementsInSearch.includes(symbol)) {
                if (!el.classList.contains('selected')) {
                    el.classList.add('selected');
                    if (!selectedElements.includes(symbol)) {
                        selectedElements.push(symbol);
                    }
                }
            } else {
                if (el.classList.contains('selected')) {
                    el.classList.remove('selected');
                    selectedElements = selectedElements.filter(s => s !== symbol);
                }
            }
        });

        updateSelectedCount();
    }
});

// 全局函数：添加相似元素
function addSimilarElement(element) {
    const elementDiv = document.querySelector(`[data-symbol="${element}"]`);
    if (elementDiv && !elementDiv.classList.contains('selected')) {
        elementDiv.click(); // 触发点击事件
    }
}

function validateSearch() {
    // 获取基本搜索输入
    const basicSearchInput = document.getElementById('searchInput').value.trim();
    
    // 获取所有高级搜索输入
    const advancedInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
    let hasAdvancedCriteria = false;
    
    // 检查是否有任何高级搜索条件
    for (let input of advancedInputs) {
        if (input.value && input.value.trim() !== '' && input.id !== 'selectedElements') {
            hasAdvancedCriteria = true;
            break;
        }
    }
    
    // 检查元素选择器
    const selectedElementsInput = document.getElementById('selectedElements');
    if (selectedElementsInput.value.trim() !== '') {
        hasAdvancedCriteria = true;
    }
    
    // 如果没有任何搜索条件，显示提示并阻止表单提交
    if (!basicSearchInput && !hasAdvancedCriteria) {
        const searchAlert = document.getElementById('searchAlert');
        searchAlert.style.display = 'flex';
        
        // 5秒后自动隐藏提示
        setTimeout(() => {
            searchAlert.style.display = 'none';
        }, 5000);
        
        return false; // 阻止表单提交
    }
    
    return true; // 允许表单提交
}
</script>

<!-- Materials Type数据同步脚本 -->
<script>
    // 监听材料数据更新事件
    window.addEventListener('materialDataUpdated', function(event) {
        const { materialId, bandGap, maxSC } = event.detail;
        updateMaterialDataInTable(materialId, bandGap, maxSC);
    });

    // 通知系统已移除 - 用户不希望看到更新提示

    // 更新表格中的材料数据
    function updateMaterialDataInTable(materialId, bandGap, maxSC) {
        try {
            // 查找对应的表格行
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell && idCell.textContent.includes(`IMR-${materialId}`)) {

                    // 更新Band Gap列（第6列）
                    const bandGapCell = row.querySelector('.band-gap-cell[data-material-id="' + materialId + '"]');
                    if (bandGapCell && bandGap !== undefined && bandGap !== null) {
                        const oldGap = bandGapCell.textContent.trim(); // 清理空白字符
                        bandGapCell.textContent = typeof bandGap === 'number' ? bandGap.toFixed(4) : bandGap;

                        // 只在console显示更新信息，不显示视觉反馈
                        console.log(`✅ Material ${materialId} Band Gap updated: ${oldGap} → ${bandGap}`);
                    }

                    // 更新Max SC列（第7列）
                    const maxSCCell = row.querySelector('.max-sc-cell[data-material-id="' + materialId + '"]');
                    if (maxSCCell && maxSC !== undefined && maxSC !== null) {
                        const oldSC = maxSCCell.textContent.trim(); // 清理空白字符
                        maxSCCell.textContent = typeof maxSC === 'number' ? maxSC.toFixed(4) : maxSC;

                        // 只在console显示更新信息，不显示视觉反馈
                        console.log(`✅ Material ${materialId} Max SC updated: ${oldSC} → ${maxSC}`);
                    }
                }
            });
        } catch (error) {
            console.error('Error updating material data in table:', error);
        }
    }

    // 页面加载时检查是否有待更新的材料数据
    document.addEventListener('DOMContentLoaded', function() {
        // 如果从detail页面返回，检查localStorage中是否有更新的材料数据
        const updatedData = localStorage.getItem('updatedMaterialData');
        if (updatedData) {
            try {
                const updates = JSON.parse(updatedData);
                updates.forEach(update => {
                    updateMaterialDataInTable(update.materialId, update.bandGap, update.maxSC);
                });
                // 清除localStorage中的数据
                localStorage.removeItem('updatedMaterialData');
            } catch (error) {
                console.error('Error processing updated material data:', error);
            }
        }
    });
</script>

{% endblock %}
