{% extends 'base.html' %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/database.css', v='20250913') }}">
{% endblock %}

{% block content %}
<!-- ====================== 数据表格容器 ====================== -->
<div class="data-table-container">
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（.data-table-container） -->

    <!-- ====================== 搜索表单 ====================== -->
    <form method="GET" action="{{ url_for('views.index') }}" class="search-form" id="searchForm" onsubmit="return validateSearch()">
        <!-- 量子电子动画画布（仅首屏10秒展示，随后渐隐隐藏） -->
        <canvas id="hvElectronsDb" class="hv-electrons" aria-hidden="true"></canvas>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（.search-form, .hv-electrons） -->

        <script>
        (function(){
          const canvas = document.getElementById('hvElectronsDb');
          const formEl = document.getElementById('searchForm');
          if (!canvas || !formEl) return;

          const ctx = canvas.getContext('2d');
          let electrons = [];
          let raf = null;
          const N = 10;
          const R = 3;
          const V_INIT_MIN = 1.2, V_INIT_MAX = 3.8;
          const V_MIN = 1.0, V_MAX = 4.2;
          const TRAIL = 0.08;
          const SHOW_MS = 10000;  // 10 秒展示
          const FADE_MS = 1000;   // 渐隐 1 秒
          let startTs = performance.now();

          function resize(){
            const rect = formEl.getBoundingClientRect();
            canvas.width = Math.max(10, Math.floor(rect.width));
            canvas.height = Math.max(10, Math.floor(rect.height));
          }

          function init(){
            resize();
            electrons = [];
            for (let i=0;i<N;i++){
              const theta = Math.random()*Math.PI*2;
              const speed = V_INIT_MIN + Math.random()*(V_INIT_MAX - V_INIT_MIN);
              const vx = Math.cos(theta)*speed;
              const vy = Math.sin(theta)*speed;
              const x = R + Math.random()*(canvas.width - 2*R);
              const y = R + Math.random()*(canvas.height - 2*R);
              electrons.push({x,y,vx,vy,r:R,prevSpeed:speed,prevAngle:theta,sAvg:0,aAvg:0});
            }
            startTs = performance.now();
            loop();
          }

          function steerQuantum(e){
            const BASE_DELTA = 0.28;
            const NOISE_MAX = 0.18;
            const spdNow = Math.hypot(e.vx,e.vy) || V_MIN;
            const angNow = Math.atan2(e.vy,e.vx);
            const ds = Math.abs(spdNow - (e.prevSpeed||spdNow));
            let dtheta = Math.abs(angNow - (e.prevAngle||angNow));
            dtheta = Math.min(Math.PI, Math.abs((dtheta + Math.PI) % (2*Math.PI) - Math.PI));
            const ALPHA = 0.15;
            e.sAvg = (e.sAvg||0)*(1-ALPHA) + ds*ALPHA;
            e.aAvg = (e.aAvg||0)*(1-ALPHA) + dtheta*ALPHA;
            const S_RANGE = 0.6, A_RANGE = 0.5;
            const sWeight = Math.max(0, Math.min(1, 1 - e.sAvg/S_RANGE));
            const aWeight = Math.max(0, Math.min(1, 1 - e.aAvg/A_RANGE));
            const delta = BASE_DELTA * Math.max(0.2, sWeight);
            const rot = (Math.random()*2 - 1) * delta;
            const cosr = Math.cos(rot), sinr = Math.sin(rot);
            let nvx = e.vx * cosr - e.vy * sinr;
            let nvy = e.vx * sinr + e.vy * cosr;
            const ax = (Math.random()-0.5) * (NOISE_MAX * Math.max(0.25, aWeight));
            const ay = (Math.random()-0.5) * (NOISE_MAX * Math.max(0.25, aWeight));
            nvx += ax; nvy += ay;
            const spd = Math.hypot(nvx,nvy) || V_MIN;
            const scale = spd > V_MAX ? V_MAX/spd : (spd < V_MIN ? V_MIN/spd : 1);
            e.vx = nvx*scale; e.vy = nvy*scale;
            e.prevSpeed = Math.hypot(e.vx,e.vy) || V_MIN;
            e.prevAngle = Math.atan2(e.vy,e.vx);
          }

          function bounceQuantum(e){
            let biasAngle = null;
            const pad = e.r + 1;
            if (e.x - pad <= 0) biasAngle = 0;
            else if (e.x + pad >= canvas.width) biasAngle = Math.PI;
            else if (e.y - pad <= 0) biasAngle = Math.PI/2;
            else if (e.y + pad >= canvas.height) biasAngle = -Math.PI/2;
            const spread = Math.PI/3;
            const theta = (biasAngle!==null?biasAngle:Math.random()*Math.PI*2) + (Math.random()-0.5)*spread;
            const speed = V_MIN + Math.random()*(V_MAX - V_MIN);
            e.vx = Math.cos(theta)*speed;
            e.vy = Math.sin(theta)*speed;
            e.x = Math.min(Math.max(e.x, pad), canvas.width - pad);
            e.y = Math.min(Math.max(e.y, pad), canvas.height - pad);
          }

          function loop(ts){
            raf = requestAnimationFrame(loop);
            const now = ts || performance.now();
            const elapsed = now - startTs;
            ctx.fillStyle = 'rgba(255,255,255,'+TRAIL+')';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            let opacity = 1;
            if (elapsed >= SHOW_MS - FADE_MS) {
              const t = Math.min(1, (elapsed - (SHOW_MS-FADE_MS)) / FADE_MS);
              opacity = 1 - t;
              canvas.style.opacity = String(opacity * 0.28);
            }
            const cx = canvas.width/2, cy = canvas.height/2;
            for (const e of electrons){
              e.x += e.vx; e.y += e.vy;
              if (e.x - e.r < 0 || e.x + e.r > canvas.width || e.y - e.r < 0 || e.y + e.r > canvas.height) {
                bounceQuantum(e);
              }
              steerQuantum(e);
              if (elapsed >= SHOW_MS - FADE_MS) {
                const vx = e.x - cx, vy = e.y - cy;
                const len = Math.hypot(vx,vy) || 1;
                const ux = vx/len, uy = vy/len;
                const bias = 0.12 * (opacity < 0.5 ? (1 - opacity) : 0.5);
                e.vx = e.vx*(1-bias) + ux*bias*V_MAX;
                e.vy = e.vy*(1-bias) + uy*bias*V_MAX;
              }
              ctx.beginPath();
              ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
              ctx.fillStyle = '#3b82f6';
              ctx.fill();
            }
            if (elapsed >= SHOW_MS) {
              cancelAnimationFrame(raf); raf = null;
              canvas.style.display = 'none';
            }
          }

          window.addEventListener('resize', () => {
            const wasHidden = canvas.style.display === 'none';
            canvas.style.display = '';
            resize();
            if (wasHidden) canvas.style.display = 'none';
          });
          if (window.ResizeObserver) {
            const ro = new ResizeObserver(() => {
              const wasHidden = canvas.style.display === 'none';
              canvas.style.display = '';
              resize();
              if (wasHidden) canvas.style.display = 'none';
            });
            ro.observe(formEl);
          }

          init();
          window.addEventListener('beforeunload', function(){ if (raf) cancelAnimationFrame(raf); });
        })();
        </script>

        <!-- 基本搜索 -->
        <div class="basic-search">
            <div class="search-input-container">
                <input type="text"
                       name="q"
                       id="searchInput"
                       placeholder="{{ _('Search materials, MP IDs, space groups...') }}"
                       value="{{ search_params.q }}"
                       aria-label="{{ _('Search') }}"
                       autocomplete="off">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <button type="button" class="btn btn-clear btn--ghost" id="clearSearchBtn">{{ _('Clear') }}</button>
            <button type="submit" class="btn btn--primary">{{ _('Search') }}</button>
            <button type="button" class="btn btn--secondary" id="elementsToggleBtn" aria-controls="periodicTableWrapper" aria-expanded="true">{{ _('Elements') }}</button>
            <button type="button" class="btn btn--secondary" onclick="toggleAdvanced()">{{ _('Advanced') }}</button>
            <input type="hidden" name="per_page" id="per_page" value="">
        </div>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（analysis modal 样式已外置） -->

        {% from 'components/periodic_table.html' import periodic_table with context %}
        {{ periodic_table(elements_value=search_params.elements, show_analyze_btn=True, default_visible=True) }}

        <!-- [Removed 20250908] Deprecated inline periodic table backup removed. See components/periodic_table.html -->

        <!-- 高级搜索 -->
        <div class="advanced-search" id="advancedSearch">
            <div class="search-group">
                <!-- 第一行: 材料类型和带隙选择 -->
                <div class="search-row">
                    <!-- 材料类型下拉框 -->
                    <div class="filter-group">
                        <label for="materials_type">{{ _('Materials Type') }}</label>
                        <select name="materials_type" id="materials_type">
                            <option value="">{{ _('All') }}</option>
                            <option value="unknown" {% if search_params.materials_type == 'unknown' %}selected{% endif %}>{{ _('Unknown') }}</option>
                            <option value="metal" {% if search_params.materials_type == 'metal' %}selected{% endif %}>{{ _('Metal') }}</option>
                            <option value="semimetal" {% if search_params.materials_type == 'semimetal' %}selected{% endif %}>{{ _('Semimetal') }}</option>
                            <option value="semiconductor" {% if search_params.materials_type == 'semiconductor' %}selected{% endif %}>{{ _('Semiconductor') }}</option>
                            <option value="insulator" {% if search_params.materials_type == 'insulator' %}selected{% endif %}>{{ _('Insulator') }}</option>
                        </select>
                    </div>

                    <!-- 带隙范围 -->
                    <div class="filter-group">
                        <label for="band_gap_min">{{ _('Band Gap (eV)') }}</label>
                        <div class="range-inputs">
                            <input type="number" name="band_gap_min" id="band_gap_min"
                                   placeholder="{{ _('Min') }}" step="0.01"
                                   value="{{ search_params.band_gap_min }}">
                            <span>{{ _('to') }}</span>
                            <input type="number" name="band_gap_max" id="band_gap_max"
                                   placeholder="{{ _('Max') }}" step="0.01"
                                   value="{{ search_params.band_gap_max }}">
                        </div>
                    </div>
                </div>

                <!-- 第二行: 形成能和费米能级范围选择 -->
                <div class="search-row">
                    <!-- Max Shift Current范围 -->
                    <div class="filter-group">
                        <label for="max_sc_min">{{ _('Max Shift Current (μA/V²)') }}</label>
                        <div class="range-inputs">
                            <input type="number" name="max_sc_min" id="max_sc_min"
                                   placeholder="{{ _('Min') }}" step="0.01"
                                   value="{{ search_params.max_sc_min }}">
                            <span>{{ _('to') }}</span>
                            <input type="number" name="max_sc_max" id="max_sc_max"
                                   placeholder="{{ _('Max') }}" step="0.01"
                                   value="{{ search_params.max_sc_max }}">
                        </div>
                    </div>

                    <!-- 费米能级范围 -->
                    <div class="filter-group">
                        <label for="fermi_level_min">{{ _('Fermi Level (eV)') }}</label>
                        <div class="range-inputs">
                            <input type="number" name="fermi_level_min" id="fermi_level_min" 
                                   placeholder="{{ _('Min') }}" step="0.01" 
                                   value="{{ search_params.fermi_level_min }}">
                            <span>{{ _('to') }}</span>
                            <input type="number" name="fermi_level_max" id="fermi_level_max" 
                                   placeholder="{{ _('Max') }}" step="0.01" 
                                   value="{{ search_params.fermi_level_max }}">
                        </div>
                    </div>
                </div>

                <!-- 第三行: MP-ID 与空间群 -->
                <div class="search-row">
                    <div class="filter-group">
                        <label for="mp_id">{{ _('MP-ID') }}</label>
                        <input type="text" name="mp_id" id="mp_id" 
                               placeholder="{{ _('e.g., mp-12345') }}" 
                               value="{{ search_params.mp_id }}">
                    </div>

                    <div class="filter-group">
                        <label for="space_group">{{ _('Space Group') }}</label>
                        <input type="text" name="space_group" id="space_group" 
                               placeholder="{{ _('e.g., 194 or P6_3/mmc') }}" 
                               value="{{ search_params.space_group }}">
                    </div>
                </div>
            </div>
        </div>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（advanced-search） -->
        
        <!-- 搜索验证提示 -->
        <div id="searchAlert" class="search-alert">
            <i class="fas fa-exclamation-circle"></i>
            <span>{{ _('Please enter search criteria or select at least one filter before searching.') }}</span>
        </div>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（search-alert） -->
    </form>

    <!-- [Moved] 搜索结果信息（与表格共享内容宽度）已移动到 .table-stack 内 -->
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（filters/tags） -->

    <!-- 表格标题 + 表格放入同一滚动容器，保证左右边界对齐 -->
    <div class="table-outer">
        <div class="table-inner">
    <div class="table-stack">
    <!-- 搜索结果信息：与表格同宽、左对齐，随表格边界动态显示 -->
    <div class="search-info">
        {% if search_params|any %}
            <div class="search-summary">
                {{ _('Searching with filters:') }}
            </div>
            <div class="active-filters">
                {% for key, value in search_params.items() %}
                    {% if value %}
                        <span class="filter-tag">
                            <span class="filter-key">{{ key|title }}</span>
                            <span class="filter-value">{{ value }}</span>
                            <a href="{{ url_for('views.index', **(search_params|remove_key(key))) }}" class="remove-filter btn btn--link btn--sm" title="Remove this filter">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('views.index') }}" class="clear-all-filters btn btn--link btn--sm">{{ _('Clear All') }}</a>
            </div>
        {% endif %}
    </div>
    <div class="table-title">
        <span class="title2">
            {% trans count=materials|length %}
            Total {{ count }} material on this page
            {% pluralize %}
            Total {{ count }} materials on this page
            {% endtrans %}
        </span>
        <div class="table-toolbar">
            <div class="menu per-page">
                <button type="button" class="btn small btn--sm btn--secondary" id="perPageBtn" aria-expanded="false">{{ _('Per Page') }} <span id="perPageCurrent" class="per-page-current">({{ pagination.per_page if pagination else 10 }})</span></button>
                <div class="menu-panel is-hidden" id="perPageMenu" role="menu" aria-labelledby="perPageBtn">
                    <button type="button" class="menu-item" data-per-page="10">
                      <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                      <span class="item-text">10</span>
                    </button>
                    <button type="button" class="menu-item" data-per-page="15">
                      <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                      <span class="item-text">15</span>
                    </button>
                    <button type="button" class="menu-item" data-per-page="20">
                      <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                      <span class="item-text">20</span>
                    </button>
                    <button type="button" class="menu-item" data-per-page="25">
                      <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                      <span class="item-text">25</span>
                    </button>
                    <button type="button" class="menu-item" data-per-page="30">
                      <i class="fas fa-list-ol item-icon" aria-hidden="true"></i>
                      <span class="item-text">30</span>
                    </button>
                </div>
            </div>
            <div class="menu column-visibility">
                <button type="button" class="btn small btn--sm btn--secondary" id="colToggleBtn" aria-expanded="false">{{ _('Columns') }}</button>
                <div class="menu-panel is-hidden" id="colMenu" role="menu" aria-labelledby="colToggleBtn">
                    <div class="menu-title">{{ _('Optional Columns') }}</div>
                    <label class="menu-check" data-field="fermi_level" title="{{ _('Fermi Level (eV)') }}">
                      <input type="checkbox" value="fermi_level">
                      <i class="fas fa-bolt field-icon" aria-hidden="true"></i>
                      <span class="menu-check-text">{{ _('Fermi Level (eV)') }}</span>
                      <i class="far fa-eye field-visibility" aria-hidden="true"></i>
                    </label>
                    <label class="menu-check" data-field="band_gap" title="{{ _('Band Gap (eV)') }}">
                      <input type="checkbox" value="band_gap">
                      <i class="fas fa-wave-square field-icon" aria-hidden="true"></i>
                      <span class="menu-check-text">{{ _('Band Gap (eV)') }}</span>
                      <i class="far fa-eye field-visibility" aria-hidden="true"></i>
                    </label>
                    <label class="menu-check" data-field="max_sc" title="{{ _('Max SC (μA/V²)') }}">
                      <input type="checkbox" value="max_sc">
                      <i class="fas fa-microchip field-icon" aria-hidden="true"></i>
                      <span class="menu-check-text">{{ _('Max SC (μA/V²)') }}</span>
                      <i class="far fa-eye field-visibility" aria-hidden="true"></i>
                    </label>
                    <div class="menu-actions">
                        <button type="button" class="btn small btn--sm btn--primary" id="applyColsBtn">{{ _('Apply') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（table title/toolbar/menus） -->

    <!-- 表格 -->
    <table class="material-data-table">
        <thead>
            <tr>
                <!-- 前端排序：点击表头切换升/降序 -->
                <th class="sortable" data-sort-key="id" data-col-key="id" aria-sort="none">{{ _('ID') }} <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="mp_id" data-col-key="mp_id" aria-sort="none">{{ _('MP-ID') }} <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="name" data-col-key="name" aria-sort="none">{{ _('Material Name') }} <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="space_group" data-col-key="space_group" aria-sort="none">{{ _('Space Group') }} <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="fermi" data-col-key="fermi_level" aria-sort="none">{{ _('Fermi Level (eV)') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="fermi_level" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
                <th class="sortable" data-sort-key="band_gap" data-col-key="band_gap" aria-sort="none">{{ _('Band Gap (eV)') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="band_gap" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
                <th class="sortable" data-sort-key="max_sc" data-col-key="max_sc" aria-sort="none">{{ _('Max SC (μA/V²)') }} <span class="sort-indicator"></span><button class="col-remove" data-col-key="max_sc" title="{{ _('Hide this column') }}" aria-label="{{ _('Hide this column') }}">×</button></th>
                <th data-col-key="actions">{{ _('Actions') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for material in materials %}
            <tr>
                <td data-col-key="id">{{ material.formatted_id }}</td>
                <td data-col-key="mp_id">{{ material.mp_id if material.mp_id else _('Unknown') }}</td>
                <td data-col-key="name">
                    <a href="{{ url_for('views.detail', material_id=material.id) }}" class="material-link">
                        {{ material.name }}
                    </a>
                </td>
                <td data-col-key="space_group">{{ material.sg_name if material.sg_name else _('Unknown') }} ({{ material.sg_num if material.sg_num else _('N/A') }})</td>
                <td data-col-key="fermi_level">{{ material.fermi_level if material.fermi_level is not none else _('N/A') }}</td>
                <td class="band-gap-cell" data-col-key="band_gap" data-material-id="{{ material.id }}">
                    {% if material.band_gap is not none %}
                        {{ "%.4f"|format(material.band_gap) }}
                    {% else %}
                        {{ _('N/A') }}
                    {% endif %}
                </td>
                <td class="max-sc-cell" data-col-key="max_sc" data-material-id="{{ material.id }}">
                    {% if material.max_sc is not none %}
                        {{ "%.4f"|format(material.max_sc) }}
                    {% else %}
                        {{ _('Loading...') }}
                    {% endif %}
                </td>
                <td data-col-key="actions">
                    <div class="action-buttons">
                        <a class="btn btn--ghost btn--sm" 
                           href="https://next-gen.materialsproject.org/materials?formula={{ material.name }}" 
                           target="_blank"
                           title="{{ _('View in MP') }}">
                           MP
                        </a>
                        {# [Deprecated 20251001] 行级编辑/删除入口已移除（只读模式） #}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
        </div>
    </div>
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（material-data-table & actions） -->

    <!-- 分页导航 -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
		    <a href="{{ url_for('views.index', page=pagination.prev_num, per_page=pagination.per_page, **search_params) }}">« {{ _('Previous') }}</a>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
			    <a href="{{ url_for('views.index', page=page_num, per_page=pagination.per_page, **search_params) }}" 
                   class="{% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span class="ellipsis">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
		    <a href="{{ url_for('views.index', page=pagination.next_num, per_page=pagination.per_page, **search_params) }}">{{ _('Next') }} »</a>
        {% endif %}
    </div>
    {% endif %}
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/database.css（pagination） -->
</div>

<!-- [Deprecated 20250913] 页面级 :root 变量已移除，统一使用 base.html 中的全局变量定义 -->

<!-- JavaScript代码 -->
<script>
function toggleAdvanced() {
    const advancedSearch = document.getElementById('advancedSearch');
    if (advancedSearch.style.display === 'none' || !advancedSearch.style.display) {
        advancedSearch.style.display = 'block';
    } else {
        advancedSearch.style.display = 'none';
    }
}

function toggleElements() {
    const periodicTable = document.getElementById('periodicTableWrapper');
    if (!periodicTable) return;
    periodicTable.classList.toggle('is-hidden');

    // 同步可访问性状态与焦点
    const btn = document.getElementById('elementsToggleBtn');
    if (btn) {
        const expanded = !periodicTable.classList.contains('is-hidden');
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }
    if (!periodicTable.classList.contains('is-hidden')) {
        const clearBtn = document.getElementById('clearElements');
        if (clearBtn) clearBtn.focus();
    }
}

// ===== 分页数量与列显隐控制 =====
const OPTIONAL_COLUMNS = ['fermi_level', 'band_gap', 'max_sc'];

function getStoredPerPage() {
  try { return parseInt(localStorage.getItem('per_page') || ''); } catch { return null; }
}

function setStoredPerPage(n) {
  try { localStorage.setItem('per_page', String(n)); } catch {}
}

function updateUrlParams(params) {
  const url = new URL(window.location.href);
  Object.entries(params).forEach(([k, v]) => {
    if (v === null || v === undefined || v === '') url.searchParams.delete(k);
    else url.searchParams.set(k, v);
  });
  window.location.assign(url.toString());
}

function applyPerPage(n) {
  setStoredPerPage(n);
  // 同步隐藏字段，确保表单提交时也保留参数
  const hidden = document.getElementById('per_page');
  if (hidden) hidden.value = String(n);
  // 仅更新 per_page，保持当前页不变；若当前页在新 per_page 下无效，后端会回落到第 1 页
  updateUrlParams({ per_page: n });
}

function getStoredVisibleCols() {
  try {
    const raw = localStorage.getItem('visible_columns');
    if (!raw) return null;
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) return new Set(arr);
  } catch {}
  return null;
}

function setStoredVisibleCols(set) {
  try { localStorage.setItem('visible_columns', JSON.stringify(Array.from(set))); } catch {}
}

function applyColumnVisibility(visibleSet) {
  const allKeys = OPTIONAL_COLUMNS;
  // Update headers and cells
  allKeys.forEach(key => {
    const selector = `[data-col-key="${key}"]`;
    document.querySelectorAll(selector).forEach(el => {
      if (visibleSet.has(key)) el.classList.remove('hidden');
      else el.classList.add('hidden');
    });
  });
  // Sync checkboxes
  const menu = document.getElementById('colMenu');
  if (menu) {
    menu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.checked = visibleSet.has(cb.value);
    });
  }
}

function initToolbar() {
  // Per-page menu
  const perBtn = document.getElementById('perPageBtn');
  const perMenu = document.getElementById('perPageMenu');
  if (perBtn && perMenu) {
    perBtn.addEventListener('click', () => {
      perMenu.classList.toggle('is-hidden');
      const expanded = !perMenu.classList.contains('is-hidden');
      perBtn.classList.toggle('active', expanded);
      perBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    });
    // 高亮当前 per_page，并设置按钮括号显示
    const currentHidden = document.getElementById('per_page');
    const currentPP = parseInt((currentHidden && currentHidden.value) || '');
    const display = document.getElementById('perPageCurrent');
    if (display && !isNaN(currentPP)) display.textContent = `(${currentPP})`;
    perMenu.querySelectorAll('[data-per-page]').forEach(item => {
      const n = parseInt(item.getAttribute('data-per-page'));
      if (!isNaN(currentPP) && n === currentPP) item.classList.add('active');
      item.addEventListener('click', () => applyPerPage(n));
    });
  }

  // Column menu
  const colBtn = document.getElementById('colToggleBtn');
  const colMenu = document.getElementById('colMenu');
  if (colBtn && colMenu) {
    colBtn.addEventListener('click', () => {
      colMenu.classList.toggle('is-hidden');
      const expanded = !colMenu.classList.contains('is-hidden');
      colBtn.classList.toggle('active', expanded);
      colBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    });
    document.getElementById('applyColsBtn')?.addEventListener('click', () => {
      const checks = Array.from(colMenu.querySelectorAll('input[type="checkbox"]'));
      const selected = new Set(checks.filter(cb => cb.checked).map(cb => cb.value));
      // Default: if none checked, we keep all hidden state
      applyColumnVisibility(selected);
      setStoredVisibleCols(selected);
      colMenu.classList.add('is-hidden');
      colBtn.classList.remove('active');
      colBtn.setAttribute('aria-expanded', 'false');
    });
  }

  // Remove buttons on headers
  document.querySelectorAll('th .col-remove').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const key = btn.getAttribute('data-col-key');
      const current = getStoredVisibleCols() || new Set(OPTIONAL_COLUMNS);
      current.delete(key);
      setStoredVisibleCols(current);
      applyColumnVisibility(current);
    });
  });

  // Initialize state from storage
  const storedPP = getStoredPerPage();
  const url = new URL(window.location.href);
  // 若URL已有per_page，则同步到隐藏字段；否则尝试用localStorage
  const hidden = document.getElementById('per_page');
  const urlPP = parseInt(url.searchParams.get('per_page') || '');
  if (!isNaN(urlPP) && [10,15,20,25,30].includes(urlPP)) {
    if (hidden) hidden.value = String(urlPP);
  } else if (storedPP && [10,15,20,25,30].includes(storedPP)) {
    if (hidden) hidden.value = String(storedPP);
  }
  if (!url.searchParams.get('per_page') && storedPP && [10,15,20,25,30].includes(storedPP)) {
    // If user has a preference but URL lacks it, set per_page only and keep current page
    updateUrlParams({ per_page: storedPP });
    return; // navigation will occur
  }
  // 初始化按钮括号显示（若此时已获得隐藏字段值）
  try {
    const display = document.getElementById('perPageCurrent');
    const currentPP = parseInt((hidden && hidden.value) || '');
    if (display && !isNaN(currentPP)) display.textContent = `(${currentPP})`;
  } catch {}

  // Columns
  const storedCols = getStoredVisibleCols();
  const initialVisible = storedCols || new Set(OPTIONAL_COLUMNS);
  applyColumnVisibility(initialVisible);
}

document.addEventListener('DOMContentLoaded', initToolbar);

// 实时搜索建议功能
class SearchSuggestions {
    constructor() {
        this.searchInput = document.getElementById('searchInput');
        this.suggestionsContainer = document.getElementById('searchSuggestions');
        this.currentSuggestions = [];
        this.selectedIndex = -1;
        this.debounceTimer = null;
        this.isVisible = false;

        this.init();
    }

    init() {
        // 绑定事件监听器
        this.searchInput.addEventListener('input', (e) => this.handleInput(e));
        this.searchInput.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.searchInput.addEventListener('focus', (e) => this.handleFocus(e));

        // 点击外部隐藏建议
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-container')) {
                this.hideSuggestions();
            }
        });
    }

    handleInput(e) {
        const query = e.target.value.trim();

        // 清除之前的定时器
        if (this.debounceTimer) {
            clearTimeout(this.debounceTimer);
        }

        // 防抖处理：300ms后执行搜索
        this.debounceTimer = setTimeout(() => {
            if (query.length >= 2) {
                this.fetchSuggestions(query);
            } else {
                this.hideSuggestions();
            }
        }, 300);
    }

    handleKeydown(e) {
        if (!this.isVisible || this.currentSuggestions.length === 0) {
            return;
        }

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, this.currentSuggestions.length - 1);
                this.updateHighlight();
                break;

            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                this.updateHighlight();
                break;

            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0) {
                    this.selectSuggestion(this.currentSuggestions[this.selectedIndex]);
                }
                break;

            case 'Escape':
                this.hideSuggestions();
                break;
        }
    }

    handleFocus(e) {
        const query = e.target.value.trim();
        if (query.length >= 2 && this.currentSuggestions.length > 0) {
            this.showSuggestions();
        }
    }

    async fetchSuggestions(query) {
        try {
            const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=8`);
            const data = await response.json();

            if (data.suggestions && data.suggestions.length > 0) {
                this.currentSuggestions = data.suggestions;
                this.renderSuggestions(query);
                this.showSuggestions();
            } else {
                this.hideSuggestions();
            }
        } catch (error) {
            console.error('Failed to fetch search suggestions:', error);
            this.hideSuggestions();
        }
    }

    renderSuggestions(query) {
        const html = this.currentSuggestions.map((suggestion, index) => {
            const highlightedLabel = this.highlightMatch(suggestion.label, query);
            return `
                <div class="suggestion-item" data-index="${index}">
                    <div class="suggestion-label">${highlightedLabel}</div>
                    <div class="suggestion-category">${suggestion.category}</div>
                </div>
            `;
        }).join('');

        this.suggestionsContainer.innerHTML = html;

        // 绑定点击事件
        this.suggestionsContainer.querySelectorAll('.suggestion-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                this.selectSuggestion(this.currentSuggestions[index]);
            });
        });
    }

    highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="suggestion-highlight">$1</span>');
    }

    updateHighlight() {
        this.suggestionsContainer.querySelectorAll('.suggestion-item').forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('highlighted');
            } else {
                item.classList.remove('highlighted');
            }
        });
    }

    selectSuggestion(suggestion) {
        this.searchInput.value = suggestion.value;
        this.hideSuggestions();

        // 触发搜索表单提交
        const form = this.searchInput.closest('form');
        if (form) {
            form.submit();
        }
    }

    showSuggestions() {
        this.suggestionsContainer.style.display = 'block';
        this.isVisible = true;
        this.selectedIndex = -1;
    }

    hideSuggestions() {
        this.suggestionsContainer.style.display = 'none';
        this.isVisible = false;
        this.selectedIndex = -1;
    }
}

// 搜索清除功能
function initClearSearchFunction() {
    const clearBtn = document.getElementById('clearSearchBtn');
    const searchInput = document.getElementById('searchInput');
    const searchForm = document.getElementById('searchForm');

    clearBtn.addEventListener('click', function() {
        // 清除基本搜索输入
        searchInput.value = '';

        // 清除所有高级搜索字段
        const advancedInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
        advancedInputs.forEach(input => {
            if (input.type === 'text' || input.type === 'number') {
                input.value = '';
            } else if (input.type === 'select-one') {
                input.selectedIndex = 0; // 选择第一个选项（通常是"All"）
            }
        });

        // 清除元素选择
        const selectedElements = document.querySelectorAll('.element.selected');
        selectedElements.forEach(element => {
            element.classList.remove('selected');
        });

        // 清除隐藏的元素输入字段
        const selectedElementsInput = document.getElementById('selectedElements');
        if (selectedElementsInput) {
            selectedElementsInput.value = '';
        }

        // 更新元素计数显示
        const selectedElementsCount = document.getElementById('selectedElementsCount');
        if (selectedElementsCount) {
            selectedElementsCount.textContent = '0 selected';
        }

        // 隐藏分析按钮
        const analyzeElementsBtn = document.getElementById('analyzeElements');
        if (analyzeElementsBtn) {
            analyzeElementsBtn.style.display = 'none';
        }

        // 隐藏搜索建议
        const searchSuggestions = document.getElementById('searchSuggestions');
        if (searchSuggestions) {
            searchSuggestions.style.display = 'none';
        }

        // 提供用户反馈
        const originalText = clearBtn.textContent;
        clearBtn.textContent = 'Cleared!';
        clearBtn.style.backgroundColor = '#10b981';
        clearBtn.style.color = 'white';
        clearBtn.style.borderColor = '#10b981';

        setTimeout(() => {
            clearBtn.textContent = originalText;
            clearBtn.style.backgroundColor = '';
            clearBtn.style.color = '';
            clearBtn.style.borderColor = '';
        }, 1000);

        // 聚焦到搜索输入框
        searchInput.focus();
    });
}

// 元素周期表功能
document.addEventListener('DOMContentLoaded', function() {
    // 初始化搜索建议功能
    new SearchSuggestions();

    // 初始化清除搜索功能
    initClearSearchFunction();
    // 周期表切换按钮
    const elementsToggleBtn = document.getElementById('elementsToggleBtn');
    const periodicTableWrapper = document.getElementById('periodicTableWrapper');
    const selectedElementsInput = document.getElementById('selectedElements');
    const selectedElementsCount = document.getElementById('selectedElementsCount');
    const clearElementsBtn = document.getElementById('clearElements');
    const analyzeElementsBtn = document.getElementById('analyzeElements');
    const elements = document.querySelectorAll('.element');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    
    // 为所有元素添加原子序数标签
    elements.forEach(element => {
        const tooltipText = element.querySelector('.tooltip').textContent;
        const atomicNoMatch = tooltipText.match(/Atomic No: (\d+)/);
        if (atomicNoMatch && atomicNoMatch[1]) {
            const atomicNo = atomicNoMatch[1];
            // 检查是否已有原子序数标签
            if (!element.querySelector('.atomic-number')) {
                const atomicNumberSpan = document.createElement('span');
                atomicNumberSpan.className = 'atomic-number';
                atomicNumberSpan.textContent = atomicNo;
                element.insertBefore(atomicNumberSpan, element.firstChild);
            }
        }
    });
    
    // 处理元素的悬浮工具提示位置
    elements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const tooltip = this.querySelector('.tooltip');
            if (!tooltip) return;
            
            // 基于视窗调整tooltip位置
            const rect = this.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 重置位置样式
            tooltip.style.top = '110%';
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translateX(-50%) translateY(2px)';
            tooltip.style.bottom = 'auto';
            tooltip.style.right = 'auto';
            
            // 创建元素后延迟检查位置
            setTimeout(() => {
                const updatedRect = tooltip.getBoundingClientRect();
                
                // 处理水平溢出
                if (updatedRect.right > viewportWidth) {
                    tooltip.style.left = 'auto';
                    tooltip.style.right = '0';
                    tooltip.style.transform = 'translateY(2px)';
                } else if (updatedRect.left < 0) {
                    tooltip.style.left = '0';
                    tooltip.style.transform = 'translateY(2px)';
                }
                
                // 处理垂直溢出
                if (updatedRect.bottom > viewportHeight) {
                    tooltip.style.top = 'auto';
                    tooltip.style.bottom = '110%';
                    
                    // 调整箭头位置为底部
                    const arrow = tooltip.querySelector('::after');
                    if (arrow) {
                        arrow.style.top = '100%';
                        arrow.style.bottom = 'auto';
                        arrow.style.borderColor = 'rgba(0, 0, 0, 0.9) transparent transparent transparent';
                    }
                }
            }, 0);
        });
    });
    
    // 添加切换按钮点击事件
    elementsToggleBtn.addEventListener('click', toggleElements);

    // 监听搜索框输入变化，自动同步元素选择状态
    searchInput.addEventListener('input', function() {
        syncElementsFromSearchInput();
    });
    
    // 初始化已选中的元素
    let selectedElements = [];
    if (selectedElementsInput.value) {
        selectedElements = selectedElementsInput.value.split(',').filter(el => el.trim());
        updateSelectedCount();

        // 标记已选中的元素
        elements.forEach(el => {
            if (selectedElements.includes(el.dataset.symbol)) {
                el.classList.add('selected');
            }
        });
    }

    // 初始化时同步搜索框和元素选择状态
    if (searchInput.value.trim()) {
        syncElementsFromSearchInput();
    }
    
    // 元素点击事件
    elements.forEach(element => {
        element.addEventListener('click', function() {
            const symbol = this.dataset.symbol;
            
            // 切换元素选择状态
            if (this.classList.contains('selected')) {
                // 如果已选中，则取消选择
                this.classList.remove('selected');
                selectedElements = selectedElements.filter(el => el !== symbol);
            } else {
                // 如果未选中，则选中
                this.classList.add('selected');
                selectedElements.push(symbol);
            }
            
            // 更新选中元素计数和隐藏字段
            updateSelectedCount();

            // 智能更新搜索输入框：只有当搜索框为空或只包含元素符号时才自动更新
            updateSearchInputWithElements();

            // 不再自动隐藏周期表和提交表单
        });
    });
    
    // 清除所有选中的元素
    clearElementsBtn.addEventListener('click', function() {
        selectedElements = [];
        elements.forEach(el => el.classList.remove('selected'));
        updateSelectedCount();
        // 清除搜索框中的元素内容
        updateSearchInputWithElements();

        // 提供用户反馈
        const originalText = clearElementsBtn.textContent;
        clearElementsBtn.textContent = 'Cleared!';
        clearElementsBtn.style.backgroundColor = '#28a745';

        setTimeout(() => {
            clearElementsBtn.textContent = originalText;
            clearElementsBtn.style.backgroundColor = '';
        }, 1000);
    });

    // 更新选中元素计数
    function updateSelectedCount() {
        selectedElementsCount.textContent = `${selectedElements.length} selected`;
        selectedElementsInput.value = selectedElements.join(',');

        // 显示或隐藏分析按钮
        if (selectedElements.length > 0) {
            analyzeElementsBtn.style.display = 'inline-block';
        } else {
            analyzeElementsBtn.style.display = 'none';
        }
    }

    // 元素分析功能
    analyzeElementsBtn.addEventListener('click', async function() {
        if (selectedElements.length === 0) return;

        try {
            const response = await fetch(`/api/search/element-analysis?elements=${selectedElements.join(',')}`);
            const data = await response.json();

            if (data.error) {
                alert('Analysis failed: ' + data.error);
                return;
            }

            // 显示分析结果
            showElementAnalysis(data);

        } catch (error) {
            console.error('Element analysis failed:', error);
            alert('Failed to analyze elements. Please try again.');
        }
    });

    // 显示元素分析结果
    function showElementAnalysis(data) {
        const modal = document.createElement('div');
        modal.className = 'analysis-modal';
        modal.innerHTML = `
            <div class="analysis-content">
                <div class="analysis-header">
                    <h3>Element Analysis Results</h3>
                    <button class="close-btn" onclick="this.closest('.analysis-modal').remove()">&times;</button>
                </div>
                <div class="analysis-body">
                    <div class="analysis-section">
                        <h4>Selected Elements (${data.selected_elements.length})</h4>
                        <div class="element-tags">
                            ${data.selected_elements.map(el => `<span class="element-tag">${el}</span>`).join('')}
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h4>Material Count</h4>
                        <p>Found <strong>${data.material_count}</strong> materials containing these elements</p>
                    </div>

                    ${data.similar_elements.length > 0 ? `
                    <div class="analysis-section">
                        <h4>Similar Elements</h4>
                        <div class="element-tags">
                            ${data.similar_elements.map(el => `<span class="element-tag similar" onclick="addSimilarElement('${el}')">${el}</span>`).join('')}
                        </div>
                        <small>Click to add to selection</small>
                    </div>
                    ` : ''}

                    ${data.partners && data.partners.length > 0 ? `
                    <div class="analysis-section">
                        <h4>Recommended Partners</h4>
                        <div class="element-tags">
                            ${data.partners.map(p => `
                                <span class="element-tag similar"
                                      onclick="addSimilarElement('${p.element}')"
                                      title="score=${(p.score||0).toFixed(3)}, lift=${(p.lift||0).toFixed(2)}, cond=${(p.cond||0).toFixed(2)}">
                                    ${p.element}
                                </span>
                            `).join('')}
                        </div>
                        <small>Click to add to selection</small>
                    </div>
                    ` : ``}

                    ${Object.keys(data.element_groups).length > 0 ? `
                    <div class="analysis-section">
                        <h4>Element Groups</h4>
                        ${Object.entries(data.element_groups).map(([group, elements]) => `
                            <div class="group-info">
                                <strong>${group.replace('_', ' ').toUpperCase()}:</strong>
                                <span>${elements.join(', ')}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="analysis-section">
                        <h4>Analysis Summary</h4>
                        <ul>
                            <li>Total elements selected: ${data.analysis.total_elements}</li>
                            <li>Contains metals: ${data.analysis.has_metals ? 'Yes' : 'No'}</li>
                            <li>Contains non-metals: ${data.analysis.has_nonmetals ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // 智能更新搜索输入框
    function updateSearchInputWithElements() {
        const currentValue = searchInput.value.trim();

        // 检查当前搜索框内容是否只包含元素符号（用空格分隔）
        const isElementsOnly = currentValue === '' ||
            currentValue.split(/\s+/).every(term =>
                term.length <= 3 && /^[A-Z][a-z]?$/.test(term)
            );

        // 如果搜索框为空或只包含元素符号，则自动更新
        if (isElementsOnly) {
            if (selectedElements.length > 0) {
                searchInput.value = selectedElements.join(' ');
            } else {
                searchInput.value = '';
            }
        }

        // 如果用户输入了其他内容，不覆盖，但在末尾添加元素
        else if (selectedElements.length > 0) {
            // 移除现有的元素符号，保留其他搜索词
            const nonElementTerms = currentValue.split(/\s+/).filter(term =>
                !(term.length <= 3 && /^[A-Z][a-z]?$/.test(term))
            );

            // 组合非元素词汇和选中的元素
            const combinedTerms = [...nonElementTerms, ...selectedElements];
            searchInput.value = combinedTerms.join(' ');
        }
    }

    // 从搜索框内容同步元素选择状态
    function syncElementsFromSearchInput() {
        const searchValue = searchInput.value.trim();
        if (!searchValue) {
            // 如果搜索框为空，清除所有选择
            selectedElements = [];
            elements.forEach(el => el.classList.remove('selected'));
            updateSelectedCount();
            return;
        }

        // 提取搜索框中的元素符号
        const terms = searchValue.split(/\s+/);
        const elementsInSearch = terms.filter(term =>
            term.length <= 3 && /^[A-Z][a-z]?$/.test(term)
        );

        // 更新选中状态
        elements.forEach(el => {
            const symbol = el.dataset.symbol;
            if (elementsInSearch.includes(symbol)) {
                if (!el.classList.contains('selected')) {
                    el.classList.add('selected');
                    if (!selectedElements.includes(symbol)) {
                        selectedElements.push(symbol);
                    }
                }
            } else {
                if (el.classList.contains('selected')) {
                    el.classList.remove('selected');
                    selectedElements = selectedElements.filter(s => s !== symbol);
                }
            }
        });

        updateSelectedCount();
    }
});

// 全局函数：添加相似元素
function addSimilarElement(element) {
    const elementDiv = document.querySelector(`[data-symbol="${element}"]`);
    if (elementDiv && !elementDiv.classList.contains('selected')) {
        elementDiv.click(); // 触发点击事件
    }
}

function validateSearch() {
    // 获取基本搜索输入
    const basicSearchInput = document.getElementById('searchInput').value.trim();
    
    // 获取所有高级搜索输入
    const advancedInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
    let hasAdvancedCriteria = false;
    
    // 检查是否有任何高级搜索条件
    for (let input of advancedInputs) {
        if (input.value && input.value.trim() !== '' && input.id !== 'selectedElements') {
            hasAdvancedCriteria = true;
            break;
        }
    }
    
    // 检查元素选择器
    const selectedElementsInput = document.getElementById('selectedElements');
    if (selectedElementsInput.value.trim() !== '') {
        hasAdvancedCriteria = true;
    }
    
    // 如果没有任何搜索条件，显示提示并阻止表单提交
    if (!basicSearchInput && !hasAdvancedCriteria) {
        const searchAlert = document.getElementById('searchAlert');
        searchAlert.style.display = 'flex';
        
        // 5秒后自动隐藏提示
        setTimeout(() => {
            searchAlert.style.display = 'none';
        }, 5000);
        
        return false; // 阻止表单提交
    }
    
    return true; // 允许表单提交
}
</script>

<!-- Materials Type数据同步脚本 -->
<script>
    // 监听材料数据更新事件
    window.addEventListener('materialDataUpdated', function(event) {
        const { materialId, bandGap, maxSC } = event.detail;
        updateMaterialDataInTable(materialId, bandGap, maxSC);
    });

    // 通知系统已移除 - 用户不希望看到更新提示

    // 更新表格中的材料数据
    function updateMaterialDataInTable(materialId, bandGap, maxSC) {
        try {
            // 查找对应的表格行
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell && idCell.textContent.includes(`IMR-${materialId}`)) {

                    // 更新Band Gap列（第6列）
                    const bandGapCell = row.querySelector('.band-gap-cell[data-material-id="' + materialId + '"]');
                    if (bandGapCell && bandGap !== undefined && bandGap !== null) {
                        const oldGap = bandGapCell.textContent.trim(); // 清理空白字符
                        bandGapCell.textContent = typeof bandGap === 'number' ? bandGap.toFixed(4) : bandGap;

                        // 只在console显示更新信息，不显示视觉反馈
                        console.log(`✅ Material ${materialId} Band Gap updated: ${oldGap} → ${bandGap}`);
                    }

                    // 更新Max SC列（第7列）
                    const maxSCCell = row.querySelector('.max-sc-cell[data-material-id="' + materialId + '"]');
                    if (maxSCCell && maxSC !== undefined && maxSC !== null) {
                        const oldSC = maxSCCell.textContent.trim(); // 清理空白字符
                        maxSCCell.textContent = typeof maxSC === 'number' ? maxSC.toFixed(4) : maxSC;

                        // 只在console显示更新信息，不显示视觉反馈
                        console.log(`✅ Material ${materialId} Max SC updated: ${oldSC} → ${maxSC}`);
                    }
                }
            });
        } catch (error) {
            console.error('Error updating material data in table:', error);
        }
    }

    // 页面加载时检查是否有待更新的材料数据
    document.addEventListener('DOMContentLoaded', function() {
        // 如果从detail页面返回，检查localStorage中是否有更新的材料数据
        const updatedData = localStorage.getItem('updatedMaterialData');
        if (updatedData) {
            try {
                const updates = JSON.parse(updatedData);
                updates.forEach(update => {
                    updateMaterialDataInTable(update.materialId, update.bandGap, update.maxSC);
                });
                // 清除localStorage中的数据
                localStorage.removeItem('updatedMaterialData');
            } catch (error) {
                console.error('Error processing updated material data:', error);
            }
        }
    });

    // 表头点击排序功能（仅对当前页进行前端排序）
    document.addEventListener('DOMContentLoaded', function() {
        // 解释：获取表格与可排序表头
        const table = document.querySelector('.material-data-table');
        if (!table) return;
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        if (!thead || !tbody) return;

        const sortableHeaders = thead.querySelectorAll('th.sortable');

        // 解释：工具函数—将单元格文本转为可比较的值
        function parseNumberOrNull(text) {
            const t = (text || '').trim();
            if (!t || /^(N\/A|Unknown|Loading\.\.\.)$/i.test(t)) return null;
            const v = parseFloat(t.replace(/[,\s]+/g, ''));
            return Number.isNaN(v) ? null : v;
        }

        function extractMpIdNumber(text) {
            const m = (text || '').match(/(\d+(?:\.\d+)?)/);
            return m ? parseFloat(m[1]) : null;
        }

        function extractTrailingNumberAfterHyphen(text) {
            // 解释：取最后一个连字符后的连续数字，例如 IMR-000123 → 123
            const s = (text || '').trim();
            const idx = s.lastIndexOf('-');
            if (idx === -1) return null;
            const tail = s.slice(idx + 1).match(/\d+/);
            return tail ? parseInt(tail[0], 10) : null;
        }

        function extractSpaceGroupNumber(text) {
            // 示例："P6_3/mmc (194)" → 194
            const m = (text || '').match(/\((\d+)\)/);
            return m ? parseInt(m[1], 10) : null;
        }

        function getComparableValue(td, key) {
            const raw = td ? td.textContent : '';
            switch (key) {
                case 'id': {
                    // IMR-ID：按连字符后数字大小排序
                    const num = extractTrailingNumberAfterHyphen(raw);
                    return num !== null ? { type: 'num', v: num } : { type: 'str', v: raw.trim() };
                }
                case 'mp_id': {
                    const num = extractMpIdNumber(raw);
                    return num !== null ? { type: 'num', v: num } : { type: 'str', v: raw.trim() };
                }
                case 'name': {
                    const link = td.querySelector('a');
                    const text = link ? link.textContent.trim() : raw.trim();
                    return { type: 'str', v: text };
                }
                case 'space_group': {
                    const num = extractSpaceGroupNumber(raw);
                    if (num !== null) return { type: 'num', v: num };
                    return { type: 'str', v: raw.trim() };
                }
                case 'fermi':
                case 'band_gap':
                case 'max_sc': {
                    const num = parseNumberOrNull(raw);
                    return num !== null ? { type: 'num', v: num } : { type: 'null', v: null };
                }
                default:
                    return { type: 'str', v: raw.trim() };
            }
        }

        function compareValues(a, b, direction) {
            // 解释：空值总在末尾
            if (a.type === 'null' && b.type === 'null') return 0;
            if (a.type === 'null') return 1;
            if (b.type === 'null') return -1;

            // 解释：数字优先按数值比较，字符串按本地化比较
            if (a.type === 'num' && b.type === 'num') {
                return direction * (a.v - b.v);
            }
            const as = ('' + a.v).toLocaleLowerCase();
            const bs = ('' + b.v).toLocaleLowerCase();
            if (as === bs) return 0;
            return direction * (as < bs ? -1 : 1);
        }

        function clearOtherHeaders(current) {
            sortableHeaders.forEach(h => {
                if (h !== current) h.setAttribute('aria-sort', 'none');
            });
        }

        sortableHeaders.forEach(th => {
            th.addEventListener('click', function() {
                // 解释：切换当前列排序状态
                const current = this.getAttribute('aria-sort') || 'none';
                const next = current === 'asc' ? 'desc' : 'asc';
                this.setAttribute('aria-sort', next);
                clearOtherHeaders(this);

                // 解释：获取列索引与排序键
                const colIndex = this.cellIndex;
                const key = this.dataset.sortKey || 'str';
                const direction = next === 'asc' ? 1 : -1;

                // 解释：将行映射为可比较对象，保证稳定排序
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const mapped = rows.map((row, idx) => {
                    const td = row.children[colIndex];
                    const val = getComparableValue(td, key);
                    return { row, val, idx };
                });

                mapped.sort((r1, r2) => {
                    const c = compareValues(r1.val, r2.val, direction);
                    if (c !== 0) return c;
                    return r1.idx - r2.idx; // 稳定排序
                });

                // 解释：按新顺序重新附加行
                const frag = document.createDocumentFragment();
                mapped.forEach(m => frag.appendChild(m.row));
                tbody.appendChild(frag);
            });
        });
    });
</script>

<!-- 表格居中滚动脚本：当表格宽于视口时，自动将滚动位置置于水平居中 -->
<script>
    (function(){
        function centerScrollableTables(){
            try {
                document.querySelectorAll('.table-outer').forEach(outer => {
                    const sw = outer.scrollWidth || 0;
                    const cw = outer.clientWidth || 0;
                    if (sw > cw) {
                        outer.scrollLeft = Math.max(0, Math.floor((sw - cw) / 2));
                    } else {
                        outer.scrollLeft = 0;
                    }
                });
            } catch (e) {
                console.warn('centerScrollableTables failed:', e);
            }
        }

        // 初始与窗口尺寸变化时保持居中
        document.addEventListener('DOMContentLoaded', centerScrollableTables);
        window.addEventListener('load', centerScrollableTables);
        window.addEventListener('resize', function(){
            // 使用 requestAnimationFrame 避免频繁计算
            window.requestAnimationFrame(centerScrollableTables);
        });

        // 若列可见性或每页数量变更后需要保持居中，可在对应逻辑后手动调用
        // 这里钩住菜单应用按钮进行一次性处理
        document.addEventListener('click', function(e){
            if (e.target && e.target.id === 'applyColsBtn') {
                setTimeout(centerScrollableTables, 0);
            }
        });

        // 钩住 per_page 菜单项点击后也进行居中
        document.addEventListener('click', function(e){
            const t = e.target.closest('[data-per-page]');
            if (t) {
                // 让 URL 更新与 DOM 可能变化后再执行
                setTimeout(centerScrollableTables, 0);
            }
        }, true);

        // 监听表格或标题容器尺寸变化，自动保持居中
        if (window.ResizeObserver) {
            try {
                const ro = new ResizeObserver(() => {
                    window.requestAnimationFrame(centerScrollableTables);
                });
                document.querySelectorAll('.table-stack, .material-data-table').forEach(el => ro.observe(el));
            } catch {}
        }
    })();
</script>

{% endblock %}

