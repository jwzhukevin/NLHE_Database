{% extends 'base.html' %}
{# 继承base.html模板，这使得detail.html可以共享base.html中定义的全局结构 #}

{% block content %}
{# 开始内容块，将覆盖base.html中相应的块 #}

<!-- ====================== 外部脚本引入 ====================== -->
<!-- 确保Inter字体加载 -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Three.js相关脚本：用于创建和渲染3D晶体结构模型 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"
        onerror="console.warn('Three.js CDN加载失败，3D功能将不可用')"></script>
<!-- Three.js轨道控制器：允许用户旋转、平移和缩放3D模型 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"
        onerror="console.warn('OrbitControls CDN加载失败，3D控制功能将不可用')"></script>
<!-- 备用OrbitControls加载和错误处理 -->
<script>
// 延迟检查库是否加载成功
setTimeout(function() {
    if (typeof THREE === 'undefined') {
        console.warn('⚠️ Three.js库未加载，3D晶体结构功能将不可用');
        // 可以在这里添加用户友好的提示
        const crystalContainer = document.getElementById('crystal-container');
        if (crystalContainer) {
            crystalContainer.innerHTML = '<div class="alert alert-warning">3D晶体结构功能暂时不可用（网络连接问题）</div>';
        }
    } else if (!THREE.OrbitControls) {
        console.log("尝试加载备用OrbitControls...");
        const script = document.createElement('script');
        script.src = 'https://threejs.org/examples/js/controls/OrbitControls.js';
        script.onerror = function() {
            console.warn('⚠️ OrbitControls加载失败，3D控制功能受限');
        };
        document.head.appendChild(script);
    }
}, 1000);
</script>
<!-- 自定义晶体查看器脚本：实现晶体结构的交互式展示 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/crystal-viewer.js') }}"></script>

<!-- 加载能带分析配置 -->
<script>
// 加载统一的能带分析配置
fetch('/api/band-config')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.bandConfig = data.config;
            console.log('✅ 能带分析配置已加载:', window.bandConfig);
        } else {
            console.warn('⚠️ 能带分析配置加载失败，使用默认值');
            window.bandConfig = {
                fermiLevel: 0,
                tolerance: 0.1,
                metalThreshold: 0.0,
                semimetalThreshold: 0.1,
                semiconductorThreshold: 3.0
            };
        }
    })
    .catch(error => {
        console.warn('⚠️ 能带分析配置加载失败，使用默认值:', error);
        window.bandConfig = {
            fermiLevel: 0,
            tolerance: 0.1,
            metalThreshold: 0.0,
            semimetalThreshold: 0.1,
            semiconductorThreshold: 3.0
        };
    });
</script>

<!-- 能带结构脚本：用于绘制和交互式显示材料的电子能带结构 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/band-plot.js') }}"></script>

<!-- SC结构相关脚本 -->
<!-- Plotly.js：强大的图表库，用于创建交互式图表 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/plotly.js@2.18.0/dist/plotly.min.js"
        onerror="console.warn('Plotly.js CDN加载失败，图表功能将不可用')"></script>
<!-- Plotly.js错误处理 -->
<script>
// 延迟检查Plotly是否加载成功
setTimeout(function() {
    if (typeof Plotly === 'undefined') {
        console.warn('⚠️ Plotly.js库未加载，图表功能将不可用');
        // 可以在这里添加用户友好的提示
        const scContainer = document.getElementById('sc-plot-container');
        if (scContainer) {
            scContainer.innerHTML = '<div class="alert alert-warning">图表功能暂时不可用（网络连接问题）</div>';
        }
    }
}, 1000);
</script>
<!-- 自定义SC结构绘图脚本：处理SC结构数据的可视化 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/sc-plot.js') }}"></script>


<!-- ====================== 材料导航栏 ====================== -->
<div class="material-nav">
    <div class="material-nav-wrapper">
        <!-- 导航栏主体：面包屑+属性导航（左对齐）+ 功能按钮（右对齐） -->
        <div class="nav-main-container">
            <!-- 左侧：面包屑导航 + 属性导航链接 -->
            <div class="nav-left-section">
                <!-- 面包屑导航 -->
                <div class="breadcrumb-nav">
                    <a href="{{ url_for('views.landing') }}" class="breadcrumb-link">
                        <i class="fas fa-home"></i> {{ _('Home') }}
                    </a>
                    <span class="breadcrumb-separator">
                        <i class="fas fa-chevron-right"></i>
                    </span>
                    <a href="{{ url_for('views.index') }}" class="breadcrumb-link">{{ _('Materials') }}</a>
                    <span class="breadcrumb-separator">
                        <i class="fas fa-chevron-right"></i>
                    </span>
                    <span class="breadcrumb-current">
                        {{ material.name }} ({{ material.formatted_id }}{% if material.mp_id %} · {{ material.mp_id }}{% endif %})
                    </span>
                </div>

                <!-- 属性导航链接 -->
                <div class="nav-properties">
                    <a href="#first-section" class="nav-property-link active">{{ _('Structure') }}</a>
                    <a href="#second-section" class="nav-property-link">{{ _('Crystal Data') }}</a>
                    <a href="#third-section" class="nav-property-link">{{ _('Band Structure') }}</a>
                    <a href="#sc-section" class="nav-property-link">{{ _('SC') }}</a>
                    <a href="#bcd-section" class="nav-property-link">{{ _('BCD') }}</a>
                    <a href="#dw-section" class="nav-property-link">{{ _('DW') }}</a>
                    <a href="#fourth-section" class="nav-property-link">{{ _('Properties') }}</a>
                </div>
            </div>

            <!-- 右侧：功能按钮 -->
            <div class="nav-actions">
                <!-- Materials Project外部链接 -->
                <a href="{% if material.mp_id %}https://next-gen.materialsproject.org/materials/{{ material.mp_id }}{% else %}https://next-gen.materialsproject.org/materials?formula={{ material.name }}{% endif %}"
                   target="_blank"
                   class="action-btn mp-btn">
                    <i class="fas fa-external-link-alt"></i>
                    <span>MP</span>
                </a>

                <!-- 搜索返回按钮 -->
                {% if request.referrer and 'q=' in request.referrer %}
                <a href="{{ request.referrer }}" class="action-btn back-btn">
                    <i class="fas fa-arrow-left"></i>
                    <span>{{ _('Back') }}</span>
                </a>
                {% endif %}

                <!-- 管理员专用功能：仅在管理员用户登录时显示 -->
                {% if current_user.is_authenticated and current_user.is_admin() %}
                <a href="{{ url_for('views.edit', material_id=material.id) }}"
                   class="action-btn edit-btn">
                    <i class="fas fa-edit"></i>
                    <span>{{ _('Edit') }}</span>
                </a>

                <a method="post" action="{{ url_for('views.delete', material_id=material.id) }}"
                   type="submit" data-confirm="{{ _('Delete permanently?') }}" onclick="return confirm(this.dataset.confirm)"
                   class="action-btn delete-btn">
                    <i class="fas fa-trash-alt"></i>
                    <span>{{ _('Delete') }}</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ====================== 主容器 ====================== -->
<div class="material-detail-container">

    <!-- ====================== 第一栏：3D结构和晶体结构 ====================== -->
    <div id="first-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：3D结构显示区域 (60%) -->
            <div class="column-60">
                <div class="viewer-container">
                    <div class="card-header">
        <h3>{{ _('3D Structure') }}</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="viewer-content">
        <div class="crystal-viewer" id="crystalViewer"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：晶体结构信息 (40%) -->
            <div class="column-40">
                <div class="detail-card" id="crystal-structure">
                    <div class="card-header">
                        <h3>{{ _('Crystal Structure') }}</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content">
                        <ul>
                            <li><span class="property-label">{{ _('Lattice a:') }}</span> <span class="property-value" id="lattice-a">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Lattice b:') }}</span> <span class="property-value" id="lattice-b">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Lattice c:') }}</span> <span class="property-value" id="lattice-c">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Alpha:') }}</span> <span class="property-value" id="lattice-alpha">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Beta:') }}</span> <span class="property-value" id="lattice-beta">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Gamma:') }}</span> <span class="property-value" id="lattice-gamma">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Volume:') }}</span> <span class="property-value" id="lattice-volume">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Density:') }}</span> <span class="property-value" id="structure-density">{{ _('Loading...') }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 第二栏：晶体对称性和原子坐标 ====================== -->
    <div id="second-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：晶体对称性 -->
            <div class="column-40">
                <div class="detail-card" id="crystal-symmetry">
                    <div class="card-header collapsed">
                        <h3>{{ _('Crystal Symmetry') }}</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li><span class="property-label">{{ _('Crystal System:') }}</span> <span class="property-value" id="crystal-system">{{ _('Loading...') }}</span></li>
                            <li><span class="property-label">{{ _('Space Group:') }}</span> <span class="property-value" id="space-group">
                                {% if material.sg_name and material.sg_num %}
                                    {{ material.sg_name }} ({{ material.sg_num }})
                                {% else %}
                                    {{ _('Loading...') }}
                                {% endif %}
                            </span></li>
                            <li><span class="property-label">{{ _('MP-ID:') }}</span> <span class="property-value">{{ material.mp_id if material.mp_id else _('Unknown') }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：原子坐标 -->
            <div class="column-60">
                <div class="detail-card" id="atomic-coordinates">
                    <div class="card-header collapsed">
                        <h3>{{ _('Atomic Coordinates') }}</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <div id="atom-list">{{ _('Loading atomic coordinates...') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 第三栏：能带信息和能带性质 ====================== -->
    <div id="third-section" class="content-section">
        <div class="two-column-layout">
            <!-- 左侧：能带图 (60%) -->
            <div class="column-60">
                <div class="viewer-container">
                    <div class="card-header collapsed">
        <h3>{{ _('Band Structure') }}
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('static', filename='materials/' + material.formatted_id + '/band/band.dat') }}" download class="download-btn" title="{{ _('Download band data') }}">
                <i class="fas fa-download"></i>
            </a>
            {% endif %}
        </h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="viewer-content card-content collapsed">
        <div id="bandStructure"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：能带结构属性 (40%) -->
            <div class="column-40">
                <div class="detail-card" id="band-structure">
                    <div class="card-header collapsed">
                        <h3>{{ _('Band Structure') }}</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="card-content collapsed">
                        <ul>
                            <li id="band-gap"><span class="property-label">{{ _('Band Gap:') }}</span>
                                <span class="property-value">
                                    {% if material.band_gap is not none %}
                                        {{ "%.4f"|format(material.band_gap) }} eV
                                    {% else %}
                                        {{ _('Analyzing...') }}
                                    {% endif %}
                                </span>
                            </li>
                            <li id="material-type"><span class="property-label">{{ _('Materials Type:') }}</span>
                                <span class="property-value">
                                    {% if material.materials_type %}
                                        {{ material.materials_type|title }}
                                    {% else %}
                                        {{ _('Analyzing...') }}
                                    {% endif %}
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ====================== SC部分：SC结构图 ====================== -->
    <div id="sc-section" class="content-section">
        <div class="detail-card" id="sc-card">
            <div class="card-header">
                <h3>{{ _('Shift Current') }}</h3>
                <!-- 内联 Tab 按钮，与标题同级以减少垂直空间 -->
                <div class="tab-header inline" role="tablist" aria-label="{{ _('SC Tabs') }}">
                    <button id="tab-sc-overview" class="tab-button active" role="tab" aria-selected="true" aria-controls="panel-sc-overview" data-tab="overview">{{ _('Relations') }}</button>
                    <button id="tab-sc-prop" class="tab-button" role="tab" aria-selected="false" aria-controls="panel-sc-prop" data-tab="properties">{{ _('Properties') }}</button>
                </div>
            </div>

            <!-- 保留隐藏占位，保障折叠逻辑跳过Tab卡片 -->
            <div class="tab-header" role="presentation" aria-hidden="true" style="display:none"></div>

            

            <!-- 固定两列布局：左侧始终显示绘图，右侧在 Overview/Properties 间切换 -->
            <div class="two-column-layout sc-combined-layout">
                <div class="column-70">
                    <div class="sc-plot-panel">
                        <div id="scStructure"></div>
                    </div>
                </div>
                <div class="column-30">
                    <!-- 右侧：Relations（元素关系）作为一个 Tab 面板 -->
                    <div id="panel-sc-overview" class="tab-content active" role="tabpanel" aria-labelledby="tab-sc-overview">
                        <div id="relations-table-container" class="relations-table-scroll">
                            <div class="loading-message">{{ _('Loading element relations...') }}</div>
                        </div>
                    </div>
                    <!-- 右侧：Properties 作为另一个 Tab 面板 -->
                    <div id="panel-sc-prop" class="tab-content" role="tabpanel" aria-labelledby="tab-sc-prop" hidden>
                        <div class="properties-panel">
                            <ul class="properties-list">
                                <li>
                                    <span class="property-label">{{ _('Max SC') }}</span>
                                    <span class="property-value">
                                        {% if material.max_sc is not none %}
                                            {{ "%.4f"|format(material.max_sc) }} μA/V²
                                        {% else %}
                                            {{ _('Unknown') }}
                                        {% endif %}
                                    </span>
                                </li>
                                <li>
                                    <span class="property-label">{{ _('Max Photon Energy') }}</span>
                                    <span class="property-value">
                                        {% if material.max_photon_energy is not none %}
                                            {{ "%.4f"|format(material.max_photon_energy) }} eV
                                        {% else %}
                                            {{ _('Unknown') }}
                                        {% endif %}
                                    </span>
                                </li>
                                <li>
                                    <span class="property-label">{{ _('Max Tensor Type') }}</span>
                                    <span class="property-value">{{ material.max_tensor_type if material.max_tensor_type else _('Unknown') }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        <!-- 旧位置的 Properties 面板已并入右侧列 -->

        <!-- [Deprecated 20250822] 旧结构备份已移除：原双列布局（左图右详情）。如需回滚，请参照Git历史。 -->
    </div><!-- /#sc-section -->

<!-- ====================== BCD 部分：九曲线 + Eigen Matrix ====================== -->
<div id="bcd-section" class="content-section">
    <div class="detail-card" id="bcd-card">
        <div class="card-header">
            <h3>{{ _('Berry curvature dipole (BCD)') }}</h3>
            <span class="card-header-extra" aria-label="{{ _('Eigen Matrix') }}">{{ _('Eigen Matrix') }}</span>
        </div>
        <div class="card-content">
            <div class="two-column-layout">
                <div class="column-60">
                    <div class="sc-plot-panel">
                        <div id="bcdStructure"></div>
                        <div id="bcdNotice" class="property-note" style="display:none"></div>
                    </div>
                </div>
                <div class="column-40">
                    <div class="sc-properties-panel">
                        <div id="bcdEigenMatrix" class="properties-panel"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="sc-legend-container" aria-label="{{ _('BCD Legend') }}" style="display:none"></div>
</div>

<!-- ====================== DW 部分：九曲线 + Eigen Matrix ====================== -->
<div id="dw-section" class="content-section">
    <div class="detail-card" id="dw-card">
        <div class="card-header">
            <h3>{{ _('Drude weight (DW)') }}</h3>
            <span class="card-header-extra" aria-label="{{ _('Eigen Matrix') }}">{{ _('Eigen Matrix') }}</span>
        </div>
        <div class="card-content">
            <div class="two-column-layout">
                <div class="column-60">
                    <div class="sc-plot-panel">
                        <div id="dwStructure"></div>
                        <div id="dwNotice" class="property-note" style="display:none"></div>
                    </div>
                </div>
                <div class="column-40">
                    <div class="sc-properties-panel">
                        <div id="dwEigenMatrix" class="properties-panel"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="sc-legend-container" aria-label="{{ _('DW Legend') }}" style="display:none"></div>
</div>

<!-- ====================== 第四栏：基本信息和表面属性（移动至页面底部） ====================== -->
<div id="fourth-section" class="content-section">
    <div class="two-column-layout">
        <!-- 左侧：基本属性 -->
        <div class="column-40">
            <div class="detail-card" id="basic-properties">
                <div class="card-header collapsed">
                    <h3>{{ _('Basic Properties') }}</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="card-content collapsed">
                    <ul>
                        <li><span class="property-label">{{ _('ID:') }}</span> <span class="property-value">{{ material.formatted_id }}</span></li>
                        <li><span class="property-label">{{ _('Fermi Level:') }}</span> <span class="property-value">{{ material.fermi_level ~ ' eV' if material.fermi_level is not none else _('Not available yet') }}</span></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 右侧：表面属性 -->
        <div class="column-40">
            <div class="detail-card" id="surface-properties">
                <div class="card-header collapsed">
                    <h3>{{ _('Surface Properties') }}</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="card-content collapsed">
                    <ul>
                        <li><span class="property-label">{{ _('Vacuum Level:') }}</span> <span class="property-value">{{ _('Not available yet') }}</span></li>
                        <li><span class="property-label">{{ _('Work Function:') }}</span> <span class="property-value">{{ _('Not available yet') }}</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript区域 -->
<!-- BCD/DW 绘图脚本需在 material-detail.js 之前引入，以便初始化调用 -->
<script type="text/javascript" src="{{ url_for('static', filename='js/bcd-plot.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/dw-plot.js') }}"></script>
<!-- 引入材料详情页面的JavaScript文件 -->
<script src="{{ url_for('static', filename='js/material-detail.js') }}"></script>
<!-- 使用JSON script标签安全地传递材料数据到前端 -->
<!-- 这种方法避免了在JavaScript代码中使用Jinja2语法，IDE不会报错 -->
<script id="material-data" type="application/json">
{
    "id": {{ material.id }},
    "name": {{ material.name|tojson }},
    "max_sc": {{ material.max_sc if material.max_sc is not none else 'null' }},
    "max_photon_energy": {{ material.max_photon_energy if material.max_photon_energy is not none else 'null' }},
    "max_tensor_type": {{ (material.max_tensor_type if material.max_tensor_type else _('Unknown'))|tojson }},
    "materials_type": {{ _('Unknown')|tojson }},
    "band_data_path": "/static/materials/{{ material.formatted_id }}/band/band.dat",
    "sc_data_path": "/static/materials/{{ material.formatted_id }}/sc/sc.dat",
    "bcd_dir": {{ ('/static/' ~ bcd_dir)|tojson if bcd_dir else 'null' }},
    "dw_dir": {{ ('/static/' ~ dw_dir)|tojson if dw_dir else 'null' }},
    "bcd_matrix_path": {{ ('/static/' ~ bcd_matrix_path)|tojson if bcd_matrix_path else 'null' }},
    "dw_matrix_path": {{ ('/static/' ~ dw_matrix_path)|tojson if dw_matrix_path else 'null' }}
}
</script>
{% endblock %}
