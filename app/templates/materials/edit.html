{% extends 'base.html' %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/materials_form.css', v='20250913') }}">
{% endblock %}

{% block content %}
<!-- ====================== Main Container ====================== -->
<div class="full-form-container" 
     data-no-file="{{ _('No file selected') }}" 
     data-file-label="{{ _('File:') }}" 
     data-size-label="{{ _('Size:') }}">
    <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/materials_form.css（容器） -->

    <span class="title2">{{ _('Editing %(name)s', name=material.name) }}</span>
    <form method="post" class="material-form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- Core Properties -->
        <div class="form-section">
            <h3>{{ _('Core Properties') }}</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>{{ _('Material Name') }} <span class="required">*</span></label>
                    <input type="text" name="name" 
                           value="{{ material.name }}" 
                           required
                           pattern=".{2,120}"
                           title="{{ _('2-120 characters') }}">
                </div>
                <div class="form-group">
                    <label>{{ _('Structure File (CIF)') }}</label>
                    <input type="file" name="structure_file" accept=".cif" class="custom-file-input">
                    {% if cif_files %}
                    <p class="file-info">{{ _('Current CIF file(s):') }}<br>
                        {% for f in cif_files %}
                        <b>{{ f }}</b><br><span class="text-muted">{{ _('Path:') }} {{ structure_dir }}/{{ f }}</span><br>
                        {% endfor %}
                        {% if cif_files|length > 1 %}
                        <span class="text-danger fw-bold">{{ _('Warning: 存在多个.cif文件，请只保留一个！') }}</span>
                        {% endif %}
                    </p>
                    {% endif %}
                    <small class="help-text">{{ _('支持.cif格式，文件名不限，若有多个.cif文件将报错') }}</small>
                    <span class="file-name">{{ _('No file selected') }}</span>
                </div>
                <div class="form-group">
                    <label>{{ _('Band Structure File (DAT/JSON)') }}</label>
                    <input type="file" name="band_file" accept=".json,.dat" class="custom-file-input">
                    <small class="help-text">{{ _('支持.dat/.json格式，文件名不限，若有多个同类文件将报错') }}</small>
                    {% if band_files %}
                    <p class="file-info">{{ _('Current band file(s):') }}<br>
                        {% for f in band_files %}
                        <b>{{ f }}</b><br><span class="text-muted">{{ _('Path:') }} {{ band_dir }}/{{ f }}</span><br>
                        {% endfor %}
                        {% if band_files|length > 1 %}
                        <span class="text-danger fw-bold">{{ _('Warning: 存在多个能带文件，请只保留一个！') }}</span>
                        {% endif %}
                    </p>
                    {% endif %}
                    <span class="file-name">{{ _('No file selected') }}</span>
                </div>
            </div>
        </div>
        
        <!-- Additional Files Upload Area -->
        <div class="form-section">
            <h3>{{ _('Additional Files') }}</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>{{ _('Material Properties (JSON)') }}</label>
                    <input type="file" name="properties_json" accept=".json" class="custom-file-input">
                    <small class="help-text">{{ _('JSON file with material properties') }}</small>
                    {% if material.properties_json %}
                    <p class="file-info">{{ _('Current file:') }} <b>{{ material.properties_json }}</b><br><span class="text-muted">{{ _('Path:') }} /static/materials/IMR-{{ material.id }}/{{ material.properties_json }}</span><br><span class="text-primary-600">{{ _('Required name: material.json') }}</span></p>
                    {% endif %}
                    <span class="file-name">{{ _('No file selected') }}</span>
                </div>
                <div class="form-group">
                    <label>{{ _('Shift Current File (DAT)') }}</label>
                    <div class="custom-file">
                    <input type="file" name="sc_structure_file" accept=".dat" class="custom-file-input">
                    <small class="help-text">{{ _('支持.dat格式，文件名不限，若有多个同类文件将报错') }}</small>
                    </div>
                    <div class="file-list">
                        {% for f in sc_files %}
                        <div class="file-item">
                            <b>{{ f }}</b><br><span class="text-muted">{{ _('Path:') }} {{ sc_dir }}/{{ f }}</span><br>
                            <button type="button" class="btn btn-sm btn-danger delete-file" data-file="{{ sc_dir }}/{{ f }}">{{ _('删除') }}</button>
                        </div>
                        {% else %}
                        <div class="no-files">{{ _('无Shift Current文件') }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/materials_form.css（表单分区/控件/文件选择） -->

        <!-- Energy Properties -->
        <div class="form-section">
            <h3>{{ _('Energy Properties (eV)') }}</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>{{ _('Fermi Level') }}</label>
                    <input type="number" step="0.00000001"
                           name="fermi_level"
                           value="{{ material.fermi_level }}">
                    <small class="help-text">{{ _('Fermi energy level in eV') }}</small>
                </div>
            </div>
        </div>

        <!-- Electronic Properties -->
        <div class="form-section">
            <h3>{{ _('Electronic Properties') }}</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>{{ _('Band Gap (eV)') }}</label>
                    <input type="number" step="0.0001"
                           name="band_gap"
                           value="{{ material.band_gap }}">
                    <small class="help-text">{{ _('Automatically calculated from band data') }}</small>
                </div>
                <div class="form-group">
                    <label>{{ _('Materials Type') }}</label>
                    <select name="materials_type">
                        <option value="">{{ _('Select Type') }}</option>
                        <option value="metal" {% if material.materials_type == 'metal' %}selected{% endif %}>{{ _('Metal') }}</option>
                        <option value="semimetal" {% if material.materials_type == 'semimetal' %}selected{% endif %}>{{ _('Semimetal') }}</option>
                        <option value="semiconductor" {% if material.materials_type == 'semiconductor' %}selected{% endif %}>{{ _('Semiconductor') }}</option>
                        <option value="insulator" {% if material.materials_type == 'insulator' %}selected{% endif %}>{{ _('Insulator') }}</option>
                        <option value="unknown" {% if material.materials_type == 'unknown' %}selected{% endif %}>{{ _('Unknown') }}</option>
                    </select>
                    <small class="help-text">{{ _('Automatically determined from band gap') }}</small>
                </div>
            </div>
        </div>

        <!-- VBM/CBM 和 Band Indexes 相关字段已删除，这些字段在数据库中不存在 -->

        <!-- Form Action Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-save" 
                    data-confirm="{{ _('Confirm Save?') }}">
                <i class="fas fa-save"></i> {{ _('Update Material') }}
            </button>
            <a href="{{ url_for('views.detail', material_id=material.id) }}" 
               class="btn btn-cancel">
                <i class="fas fa-times"></i> {{ _('Discard Changes') }}
            </a>
        </div>
        
        <!-- Data Synchronization Information -->
        <div class="sync-info">
            <h4><i class="fas fa-sync"></i> {{ _('Data Synchronization Feature') }}</h4>
            <p>{{ _('After submitting the material, the system will automatically create the following directory structure:') }}</p>
            <div class="directory-structure">
                <pre>
材料目录结构:
IMR-[id]/
├── structure/         # 晶体结构目录
│   └── structure.cif  # 晶体结构文件
├── band/              # 能带结构目录
│   └── band.dat       # 能带数据文件
└── sc/                # Shift Current目录
    └── sc.dat         # Shift Current数据文件
            </pre>
            </div>
        </div>
        <!-- [Deprecated 20250913] 内联样式已迁移至 static/css/pages/materials_form.css（按钮/信息块） -->
    </form>
</div>

<!-- File Input Event Handler -->
<script>
(function(){
  const container = document.querySelector('.full-form-container');
  if (!container) return;
  const noFileText = container.dataset.noFile || 'No file selected';
  const fileLabel = container.dataset.fileLabel || 'File:';
  const sizeLabel = container.dataset.sizeLabel || 'Size:';

  // 文件选择文本更新
  document.querySelectorAll('input[type="file"]').forEach(function(input) {
    input.addEventListener('change', function() {
      const file = this.files[0];
      const fileNameSpan = this.parentElement.querySelector('.file-name');
      if (!file) {
        fileNameSpan.textContent = noFileText;
        return;
      }
      let size = file.size;
      let sizeStr = size > 1024*1024 ? (size/1024/1024).toFixed(2)+' MB' : (size/1024).toFixed(2)+' KB';
      fileNameSpan.innerHTML = `<b>${fileLabel}</b> ${file.name} <br><b>${sizeLabel}</b> ${sizeStr}`;
    });
  });

  // 保存按钮确认弹窗
  const saveBtn = document.querySelector('.btn-save');
  if (saveBtn) {
    const confirmText = saveBtn.dataset.confirm || 'Confirm Save?';
    saveBtn.addEventListener('click', function(ev){
      if (!confirm(confirmText)) {
        ev.preventDefault();
      }
    });
  }
})();
</script>
{% endblock %}