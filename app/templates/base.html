<!DOCTYPE html>
<html lang="{{ current_locale or 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatdataX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css', v='20260106') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/menus.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/periodic_table.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/utilities.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/alerts.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base/navbar.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base/footer.css', v='20250913') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/loader.css', v='20250913') }}">
    {% block page_styles %}{% endblock %}
    <style>
        /* ========== 全局变量和基础样式 ========== */
        :root {
            /* Theme colors */
            --primary-color: #0047AB;    /* Cobalt blue - primary color */
            --secondary-color: #1E5CB3;   /* Lighter blue */
            --accent-color: #007FFF;      /* Sky blue - accent color */
            --text-color: #333333;        /* Dark gray text */
            --light-bg: #F5F8FF;          /* Very light blue background */
            
    
            /* Shadows and borders */
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            --input-border: #D9E2F0;
            --input-focus: #0047AB;
            --button-hover: #003A8C;
            
            /* Spacing and font sizes */
            --spacing-xs: 0.25rem;    /* 4px */
            --spacing-sm: 0.5rem;     /* 8px */
            --spacing-md: 1rem;       /* 16px */
            --spacing-lg: 1.5rem;     /* 24px */
            --spacing-xl: 2rem;       /* 32px */
            
            /* Font sizes - using clamp for responsive sizing */
            --font-size-sm: clamp(0.75rem, 0.8vw, 0.875rem);
            --font-size-base: clamp(0.875rem, 1vw, 1rem);
            --font-size-lg: clamp(1rem, 1.2vw, 1.25rem);
            --font-size-xl: clamp(1.25rem, 1.5vw, 1.5rem);
            
            /* Button styles */
            --button-padding: 0.5rem 1rem;
            --button-radius: 0.375rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
        }
        
        /* 确保 Font Awesome 图标不被覆盖 */
        .fas, .far, .fal, .fab, .fa {
            font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Brands' !important;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        /* ========== 公共组件样式 ========== */
        /* [DEPRECATED] 按钮基础样式已迁移至 app/static/css/components/buttons.css */

        /* 输入框通用样式 
         * 适用于文本输入框、下拉选择框和文本区域
         * 包含了焦点状态的样式变化
         */
        input, select, textarea {
            width: 100%; /* 宽度占满容器 */
            padding: var(--spacing-sm); /* 内边距 */
            border: 1px solid var(--input-border); /* 边框样式 */
            border-radius: var(--button-radius); /* 圆角边框 */
            font-size: var(--font-size-base); /* 字体大小 */
            transition: border-color 0.3s; /* 边框颜色变化动画 */
        }

        /* 输入框获得焦点时的样式 */
        input:focus,
        select:focus,
        textarea:focus {
            outline: none; /* 移除默认的焦点轮廓 */
            border-color: var(--input-focus); /* 边框变为主题色 */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); /* 添加柔和的阴影效果 */
        }
        
        /* 主内容区域样式 
         * 定义了页面主要内容的布局和间距
         */
        .main-content {
            padding-top: var(--navbar-height, 74px); /* 动态匹配导航栏高度 */
            min-height: calc(100vh - 350px); /* 最小高度确保页面填充 */
            margin-top: 0; /* 移除顶部外边距 */
            background-color: var(--light-bg); /* 使用浅色背景 */
        }

        /* 材料详情页面的特殊调整 */
        .main-content .material-detail-container {
            padding-top: 0; /* 移除顶部内边距 */
        }

        
    </style>
</head>
<body>
    <!-- ========== 导航栏 ========== -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="{{ url_for('views.landing') }}" class="logo"><i class="fas fa-database"></i> MatdataX</a>
            <div class="nav-links">
                <!-- 语言切换下拉：移到最前（在 MatdataX 链接前） -->
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" id="lang-dropdown">
                        <i class="fas fa-language"></i> {{ _('Language') }} <i class="fas fa-caret-down"></i>
                    </a>
                    <div class="dropdown-menu" id="lang-menu">
                        <a href="{{ url_for('views.set_language', lang='en') }}" hreflang="en">{{ _('English') }}</a>
                        <a href="{{ url_for('views.set_language', lang='zh') }}" hreflang="zh">{{ _('中文') }}</a>
                    </div>
                </div>
                <a href="{{ url_for('views.index') }}">
                    <i class="fas fa-table"></i>
                    {{ _('MatdataX-I: Functional Materials') }}
                </a>
                <div class="dropdown" id="structural-dropdown">
                    <a href="#" class="dropdown-toggle" id="struct-dropdown">
                        <i class="fas fa-flask"></i>
                        {{ _('MatdataX-II: Structural Materials') }}
                        <i class="fas fa-caret-down"></i>
                    </a>
                    <div class="dropdown-menu" id="struct-menu">
                        <a href="#" class="disabled" aria-disabled="true" tabindex="-1">
                            {{ _('Alloy') }}
                        </a>
                        <div class="dropdown-submenu">
                            <a href="#" id="ceramics-item">
                                {{ _('Ceramics') }}
                                <i class="fas fa-caret-right" style="margin-left:auto;"></i>
                            </a>
                            <div class="submenu-menu" id="ceramics-submenu">
                                <a href="{{ url_for('ceramics_literature.index') }}">
                                    {{ _('Literature Extracted Data') }} ({{ ceramics_literature_count|default(0) }})
                                </a>
                                <a href="{{ url_for('ceramics_experiment.index') }}">
                                    {{ _('Internal Experimental Data') }} ({{ ceramics_experiment_count|default(0) }})
                                </a>
                                <a href="{{ url_for('high_temperature_alloy.index') }}">
                                    {{ _('Model Predicted Data') }} ({{ ceramics_ai_count|default(0) }})
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('articles.listing') }}">
                    <i class="fas fa-book"></i>
                    {{ _('Articles') }}
                </a>
                {% if current_user.is_authenticated %}
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" id="tools-dropdown">
                        <i class="fas fa-robot"></i> {{ _('AI Tools') }} <i class="fas fa-caret-down"></i>
                    </a>
                    <div class="dropdown-menu" id="tools-menu">
                        <a href="{{ url_for('static', filename='Package/example.zip') }}" download="example.zip">
                            <i class="fas fa-graduation-cap"></i> {{ _('Active Learning') }}
                        </a>
                        <a href="{{ url_for('static', filename='Package/example.zip') }}" download="example.zip">
                            <i class="fas fa-image"></i> {{ _('Image Recognition') }}
                        </a>
                        <a href="{{ url_for('static', filename='Package/example.zip') }}" download="example.zip">
                            <i class="fas fa-language"></i> {{ _('Natural Language Processing') }}
                        </a>
                        <a href="{{ url_for('chat.chat_page') }}">
                            <i class="fas fa-comments"></i> {{ _('LLM') }}
                        </a>
                    </div>
                </div>
                {% endif %}
                <!-- 登录用户专用功能按钮 -->
                {% if current_user.is_authenticated %}
                {% endif %}

                {# [Deprecated 20251001] 管理员新增入口已移除（只读模式） #}

                {# 取消未登录状态下在此处展示独立 Apply/Login 链接，改由 guest 头像下拉提供 #}

                <!-- 自适应收纳：更多下拉（默认隐藏，JS控制显示） -->
                <div class="dropdown more-dropdown" id="more-dropdown" aria-label="More">
                    <a href="#" class="dropdown-toggle" id="more-toggle">
                        <i class="fas fa-ellipsis-h"></i> {{ _('More') }}
                    </a>
                    <div class="dropdown-menu" id="more-menu"></div>
                </div>

                <!-- We 下拉（移到 Guest 前） -->
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle" id="we-dropdown">
                        <i class="fas fa-users"></i> {{ _('We') }} <i class="fas fa-caret-down"></i>
                    </a>
                    <div class="dropdown-menu" id="we-menu">
                        <a href="{{ url_for('views.members') }}"><i class="fas fa-user-friends"></i> {{ _('Team') }}</a>
                        <a href="#"><i class="fas fa-book"></i> {{ _('Publications') }}</a>
                        <a href="#"><i class="fas fa-trophy"></i> {{ _('Achievements') }}</a>
                        <a href="http://www.synl.ac.cn/division.asp?id=8" target="_blank" rel="noopener noreferrer"><i class="fas fa-user-plus"></i> {{ _('Join Us') }}</a>
                    </div>
                </div>

                <!-- 用户类型提示区域，头像+用户名+下拉菜单 -->
                <div class="user-type-indicator user-dropdown">
                    {% if current_user.is_authenticated %}
                        <span class="user-avatar user user-dropdown-toggle"><i class="fas fa-user-circle"></i></span>
                        <span class="user-name user-dropdown-toggle">{{ current_user.username }}</span>
                        <div class="user-dropdown-menu">
                            <a href="{{ url_for('views.logout') }}"><i class="fas fa-sign-out-alt"></i> {{ _('Logout') }}</a>
                        </div>
                    {% else %}
                        <span class="user-avatar guest user-dropdown-toggle"><i class="fas fa-user-circle"></i></span>
                        <span class="user-name user-dropdown-toggle">{{ _('Guest') }}</span>
                        <div class="user-dropdown-menu">
                            <a href="{{ url_for('views.apply') }}"><i class="fas fa-user-plus"></i> {{ _('Apply') }}</a>
                            <a href="{{ url_for('views.login') }}"><i class="fas fa-sign-in-alt"></i> {{ _('Login') }}</a>
                        </div>
                    {% endif %}
                </div>
                <!-- 结束 -->

                
            </div>
        </div>
    </nav>

    <!-- [Deprecated 20250913] 导航栏样式已迁移至 static/css/base/navbar.css -->

    <!-- ========== 主内容区域 ========== -->
    <div class="main-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                <div class="container">
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">
                            <div class="message-content">
                                <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
                                <span>{{ message }}</span>
                            </div>
                            <button class="close-flash">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- ========== 页脚 ========== -->
    <footer class="footer">
        <div class="container footer-layout">
            <div class="footer-links">
                <div class="footer-column">
                    <h3>{{ _('MatdataX') }}</h3>
                    <ul>
                        <li><a href="{{ url_for('articles.view', category='legal', filename='copyright_statement') }}">{{ _('Copyright') }}</a></li>
                        <li><a href="{{ url_for('views.landing') }}">{{ _('Home') }}</a></li>
                        <li><a href="{{ url_for('views.index') }}">{{ _('Functional Materials') }}</a></li>
                        <li><a href="{{ url_for('articles.listing') }}">{{ _('Articles') }}</a></li>
                        <li><a href="{{ url_for('views.login') }}">{{ _('User Portal') }}</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>{{ _('Resources') }}</h3>
                    <ul>
                        <li><a href="{{ url_for('views.members') }}">{{ _('Team') }}</a></li>
                        <li><a href="https://www.cas.cn/" target="_blank" rel="noopener">{{ _('CAS') }}</a></li>
                        <li><a href="http://www.imr.cas.cn/" target="_blank" rel="noopener">{{ _('IMR') }}</a></li>
                        <li><a href="https://gs.imr.ac.cn/" target="_blank" rel="noopener">{{ _('IMR Graduate School') }}</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>{{ _('Community') }}</h3>
                    <ul>
                        <li><a href="#">{{ _('Seminars (Coming Soon)') }}</a></li>
                        <li><a href="#">{{ _('Documentation') }}</a></li>
                        <li><a href="{{ url_for('chat.chat_page') }}">{{ _('AI Assistant') }}</a></li>
                        <li><a href="#">{{ _('Support') }}</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-info">
                <div class="footer-logos">
                    <img src="{{ url_for('static', filename='favicon.ico') }}" alt="{{ _('MatdataX Logo') }}">
                </div>
                <p class="footer-description">{{ _('MatdataX') }}</p>
                <p class="footer-meta">
                    {{ _('Record & Compliance: Placeholder ICP Record · All rights reserved by IMR MatdataX.') }}<br>
                    &copy; IMR MatdataX. {{ _('Powered by') }} <a href="https://github.com/pallets/flask">Flask</a>
                </p>
            </div>
        </div>
    </footer>

    <!-- [Deprecated 20250913] 页脚样式已迁移至 static/css/base/footer.css -->
    
    <!-- ========== 下拉菜单和消息提示脚本 ========== -->
    <script>
        // 当DOM内容加载完成后执行脚本
        document.addEventListener('DOMContentLoaded', function() {
            // 获取工具下拉菜单相关元素（未登录时元素不存在，需判空）
            const toolsDropdown = document.getElementById('tools-dropdown'); // 下拉按钮
            const toolsMenu = document.getElementById('tools-menu'); // 下拉菜单内容
            if (toolsDropdown && toolsMenu) {
                // 为下拉按钮添加点击事件监听器
                // 点击时切换菜单的显示状态
                toolsDropdown.addEventListener('click', function(e) {
                    e.preventDefault(); // 阻止默认行为
                    toolsMenu.classList.toggle('show'); // 切换show类来显示/隐藏菜单
                });
                
                // 点击页面其他区域时关闭下拉菜单
                // 这是一个常见的交互模式,提升用户体验
                document.addEventListener('click', function(e) {
                    // 检查点击是否发生在下拉菜单区域外
                    if (!toolsDropdown.contains(e.target) && !toolsMenu.contains(e.target)) {
                        toolsMenu.classList.remove('show'); // 隐藏菜单
                    }
                });
            }

            // 语言下拉菜单交互
            const langDropdown = document.getElementById('lang-dropdown');
            const langMenu = document.getElementById('lang-menu');
            if (langDropdown && langMenu) {
                langDropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    langMenu.classList.toggle('show');
                });
                document.addEventListener('click', function(e) {
                    if (!langDropdown.contains(e.target) && !langMenu.contains(e.target)) {
                        langMenu.classList.remove('show');
                    }
                });
            }

            // We 下拉菜单交互（与 Tools/Language 一致）
            const weDropdown = document.getElementById('we-dropdown');
            const weMenu = document.getElementById('we-menu');
            if (weDropdown && weMenu) {
                weDropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    weMenu.classList.toggle('show');
                });
                document.addEventListener('click', function(e) {
                    if (!weDropdown.contains(e.target) && !weMenu.contains(e.target)) {
                        weMenu.classList.remove('show');
                    }
                });
            }

            // 结构材料（MatdataX-II）一级下拉交互：点击展开/收起
            const structDropdown = document.getElementById('struct-dropdown');
            const structMenu = document.getElementById('struct-menu');
            const structuralContainer = document.getElementById('structural-dropdown');
            if (structDropdown && structMenu && structuralContainer) {
                structDropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    structMenu.classList.toggle('show');
                });
                document.addEventListener('click', function(e) {
                    if (!structuralContainer.contains(e.target)) {
                        structMenu.classList.remove('show');
                    }
                });
            }

            // 处理Flash消息关闭按钮的点击事件
            document.querySelectorAll('.close-flash').forEach(button => {
                button.addEventListener('click', function() {
                    const flashMessage = this.parentElement;
                    flashMessage.classList.add('hide');
                    setTimeout(() => {
                        flashMessage.remove();
                    }, 400);
                });
            });

            // 自动关闭Flash消息（3秒后右侧滑出）
            setTimeout(() => {
                document.querySelectorAll('.flash-message').forEach(message => {
                    if (message) {
                        message.style.animation = 'slideOutToRight 0.5s ease-in forwards';
                        setTimeout(() => {
                            if (message.parentElement) {
                                message.remove();
                            }
                        }, 500);
                    }
                });
            }, 3000);

            // 用户头像+用户名下拉菜单交互
            (function(){
                const dropdown = document.querySelector('.user-type-indicator.user-dropdown');
                if (!dropdown) return;
                const toggles = dropdown.querySelectorAll('.user-dropdown-toggle');
                toggles.forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dropdown.classList.toggle('active');
                    });
                });
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
            })();

            // ===== 自适应：将低优先级导航项收纳到“更多” =====
            const navLinks = document.querySelector('.nav-links');
            const moreDropdown = document.getElementById('more-dropdown');
            const moreToggle = document.getElementById('more-toggle');
            const moreMenu = document.getElementById('more-menu');

            if (moreToggle && moreMenu) {
                moreToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    moreMenu.classList.toggle('show');
                });
                document.addEventListener('click', function(e){
                    if (!moreDropdown.contains(e.target)) {
                        moreMenu.classList.remove('show');
                    }
                });
            }

            function isFixed(node) {
                if (!node || node.nodeType !== 1) return true;
                // 保留：语言下拉、用户区、“更多”自身
                if (node.id === 'more-dropdown') return true;
                if (node.classList.contains('user-type-indicator')) return true;
                const toggle = node.querySelector('#lang-dropdown');
                if (toggle) return true;
                return false;
            }

            function currentItems() {
                // 可移动的候选：nav-links 直接子元素
                return Array.from(navLinks.children).filter(el => el && el.nodeType === 1);
            }

            function measureOverflow() {
                return navLinks.scrollWidth > navLinks.clientWidth + 2; // 容忍2px误差
            }

            function moveToMore(el) {
                if (!moreDropdown || !moreMenu) return;
                moreDropdown.style.display = '';
                // 将原元素移入 moreMenu，保持可点击（直接附加）
                moreMenu.appendChild(el);
            }

            function moveBackFromMore() {
                if (!moreMenu || !moreDropdown) return;
                // 将 moreMenu 中的第一个项目移回（先进先出）
                const item = moreMenu.firstElementChild;
                if (item) {
                    // 在 "更多" 按钮前插入
                    navLinks.insertBefore(item, moreDropdown);
                }
            }

            function compactOnce() {
                // 先尝试释放空间（把已收纳的移回），再判断是否仍溢出
                let safeGuard = 50; // 防止死循环
                while (moreMenu && moreMenu.children.length && !measureOverflow() && safeGuard-- > 0) {
                    moveBackFromMore();
                }
                // 若仍溢出，从右往左移动非固定项
                safeGuard = 50;
                while (measureOverflow() && safeGuard-- > 0) {
                    const items = currentItems();
                    // 从倒数第一个开始寻找可移动项
                    let moved = false;
                    for (let i = items.length - 1; i >= 0; i--) {
                        const el = items[i];
                        if (isFixed(el)) continue;
                        moveToMore(el);
                        moved = true;
                        break;
                    }
                    if (!moved) break; // 没有可移动项
                }
                // 如果更多里没有内容则隐藏
                if (moreDropdown) {
                    moreDropdown.style.display = (moreMenu && moreMenu.children.length) ? '' : 'none';
                }
            }

            // 初始执行与窗口变化监听
            compactOnce();
            window.addEventListener('resize', () => {
                // 为防抖，简化处理：直接调用一次
                compactOnce();
            });

            // ===== 动态设置导航高度，消除英雄模块与导航之间的间隙 =====
            const navbarEl = document.querySelector('.navbar');
            function setNavbarHeightVar() {
                if (!navbarEl) return;
                const h = Math.max(0, navbarEl.offsetHeight || 74);
                document.documentElement.style.setProperty('--navbar-height', h + 'px');
            }
            // 初次计算
            setNavbarHeightVar();
            // 在窗口尺寸变化时更新
            window.addEventListener('resize', setNavbarHeightVar);
            // 在字体加载或图片/图标渲染后可能高度变化，使用延时与加载事件兜底
            window.addEventListener('load', setNavbarHeightVar);
            setTimeout(setNavbarHeightVar, 150);
            setTimeout(setNavbarHeightVar, 400);
            // 观察导航内部结构变化（登录状态变化、更多收纳等）
            if (window.MutationObserver && navbarEl) {
                const mo = new MutationObserver(() => setNavbarHeightVar());
                mo.observe(navbarEl, { childList: true, subtree: true, attributes: true });
            }
        });
    </script>

    <!-- 全局加载遮罩（默认显示，DOMContentLoaded 后自动隐藏） -->
    <div id="global-loader" aria-live="polite" aria-busy="true">
        <div class="loader-stack">
            <!-- 灰色图框容器 -->
            <div class="loader-outer">
                <!-- 内框线（8px 边距）通过额外容器实现 -->
                <div class="loader-frame">
                    <canvas id="band-loader-canvas" width="960" height="600"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- [Deprecated 20250913] 全局加载器样式已迁移至 static/css/components/loader.css -->
    <script src="{{ url_for('static', filename='js/loader.js') }}"></script>

</body>
</html>